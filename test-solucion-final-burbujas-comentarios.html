<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Test Final - Eliminaci√≥n de Burbujas de Comentarios</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .test-section.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-section.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .test-section.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #5a67d8;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .privacy-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .privacy-indicator.private {
            background: #d4edda;
            color: #155724;
        }
        .privacy-indicator.public {
            background: #f8d7da;
            color: #721c24;
        }
        .notification-bubble {
            display: inline-block;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            font-size: 12px;
            line-height: 20px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Test Final - Eliminaci√≥n de Burbujas de Comentarios</h1>
            <p>Verificaci√≥n completa del filtro de privacidad en todas las funciones de carga de comentarios</p>
            <p><strong>Objetivo:</strong> Eliminar completamente las burbujas de comentarios para estudiantes no asignados</p>
        </div>

        <!-- Configuraci√≥n del Test -->
        <div class="test-section">
            <h2>üöÄ Configuraci√≥n del Test</h2>
            <div class="step">
                <button class="button" onclick="setupTestData()">1. Configurar Datos de Test</button>
                <button class="button success" onclick="simulateNotificationPanel()">2. Simular Panel de Notificaciones</button>
                <button class="button danger" onclick="clearAllData()">3. Limpiar Datos</button>
            </div>
            <div id="setup-result" class="log-container"></div>
        </div>

        <!-- Test Principal -->
        <div class="test-section" id="main-test">
            <h2>üîß Test de Filtros de Comentarios</h2>
            <div class="step">
                <button class="button" onclick="testLoadUnreadComments()">Test loadUnreadComments</button>
                <button class="button" onclick="testLoadStudentSubmissions()">Test loadStudentSubmissions</button>
                <button class="button success" onclick="testCompletePrivacyFilter()">Test Filtro Completo</button>
            </div>
            <div id="test-result" class="log-container"></div>
        </div>

        <!-- Simulaci√≥n de Comportamiento -->
        <div class="test-section" id="simulation">
            <h2>üé≠ Simulaci√≥n de Escenarios</h2>
            <div class="step">
                <h3>Escenario 1: Estudiante NO asignado accede a panel</h3>
                <button class="button" onclick="simulateNonAssignedStudent()">Simular Estudiante No Asignado</button>
                <div id="scenario1-result"></div>
            </div>
            <div class="step">
                <h3>Escenario 2: Profesor revisa notificaciones</h3>
                <button class="button" onclick="simulateTeacherNotifications()">Simular Profesor</button>
                <div id="scenario2-result"></div>
            </div>
            <div class="step">
                <h3>Escenario 3: Estudiante asignado ve comentarios</h3>
                <button class="button success" onclick="simulateAssignedStudent()">Simular Estudiante Asignado</button>
                <div id="scenario3-result"></div>
            </div>
        </div>

        <!-- Verificaci√≥n Final -->
        <div class="test-section" id="final-verification">
            <h2>‚úÖ Verificaci√≥n Final</h2>
            <div class="step">
                <button class="button success" onclick="runCompleteVerification()">Ejecutar Verificaci√≥n Completa</button>
            </div>
            <div id="verification-result" class="log-container"></div>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            console.log(logEntry);
        }

        function displayResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = results.join('<br>');
        }

        function setupTestData() {
            log('üöÄ Configurando datos de test...', 'info');
            
            // Configurar usuarios de test
            const testUsers = [
                {
                    id: 'teacher-001',
                    username: 'prof.martinez',
                    name: 'Prof. Martinez',
                    role: 'teacher',
                    activeCourses: ['MAT101-A']
                },
                {
                    id: 'student-001',
                    username: 'ana.garcia',
                    name: 'Ana Garc√≠a',
                    role: 'student',
                    activeCourses: ['MAT101-A']
                },
                {
                    id: 'student-002',
                    username: 'carlos.lopez',
                    name: 'Carlos L√≥pez',
                    role: 'student',
                    activeCourses: ['MAT101-A']
                },
                {
                    id: 'student-003',
                    username: 'maria.rodriguez',
                    name: 'Mar√≠a Rodr√≠guez',
                    role: 'student',
                    activeCourses: ['MAT101-B'] // Diferente secci√≥n
                }
            ];

            // Configurar tareas de test
            const testTasks = [
                {
                    id: 'task-001',
                    title: 'Ejercicios de √Ålgebra',
                    assignedTo: 'student', // Asignada a estudiantes espec√≠ficos
                    assignedStudentIds: ['student-001'], // Solo Ana Garc√≠a
                    courseSectionId: 'MAT101-A',
                    course: 'MAT101-A',
                    teacherUsername: 'prof.martinez'
                },
                {
                    id: 'task-002',
                    title: 'Tarea General de Matem√°ticas',
                    assignedTo: 'course', // Asignada a todo el curso
                    courseSectionId: 'MAT101-A',
                    course: 'MAT101-A',
                    teacherUsername: 'prof.martinez'
                }
            ];

            // Configurar comentarios de test
            const testComments = [
                {
                    id: 'comment-001',
                    taskId: 'task-001',
                    studentUsername: 'ana.garcia',
                    comment: 'Profesor, tengo una duda sobre el ejercicio 3',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    readBy: []
                },
                {
                    id: 'comment-002',
                    taskId: 'task-001',
                    studentUsername: 'carlos.lopez', // NO asignado a esta tarea
                    comment: 'Este comentario NO deber√≠a aparecer',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    readBy: []
                },
                {
                    id: 'comment-003',
                    taskId: 'task-002',
                    studentUsername: 'maria.rodriguez', // Diferente secci√≥n
                    comment: 'Comentario de estudiante de otra secci√≥n',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    readBy: []
                }
            ];

            // Configurar asignaciones de estudiantes
            const testStudentAssignments = [
                {
                    studentId: 'student-001',
                    sectionId: 'section-A',
                    courseId: 'MAT101'
                },
                {
                    studentId: 'student-002',
                    sectionId: 'section-A',
                    courseId: 'MAT101'
                },
                {
                    studentId: 'student-003',
                    sectionId: 'section-B',
                    courseId: 'MAT101'
                }
            ];

            // Configurar secciones y cursos
            const testSections = [
                { id: 'section-A', name: 'A', courseId: 'MAT101' },
                { id: 'section-B', name: 'B', courseId: 'MAT101' }
            ];

            const testCourses = [
                { id: 'MAT101', name: 'Matem√°ticas 101' }
            ];

            const testTeacherAssignments = [
                {
                    teacherId: 'teacher-001',
                    sectionId: 'section-A',
                    courseId: 'MAT101'
                }
            ];

            // Guardar en localStorage
            localStorage.setItem('smart-student-users', JSON.stringify(testUsers));
            localStorage.setItem('smart-student-tasks', JSON.stringify(testTasks));
            localStorage.setItem('smart-student-task-comments', JSON.stringify(testComments));
            localStorage.setItem('smart-student-student-assignments', JSON.stringify(testStudentAssignments));
            localStorage.setItem('smart-student-sections', JSON.stringify(testSections));
            localStorage.setItem('smart-student-courses', JSON.stringify(testCourses));
            localStorage.setItem('smart-student-teacher-assignments', JSON.stringify(testTeacherAssignments));

            log('‚úÖ Datos de test configurados correctamente');
            displayResults('setup-result', [
                '‚úÖ Usuarios creados: 1 profesor, 3 estudiantes',
                '‚úÖ Tareas creadas: 1 espec√≠fica, 1 general',
                '‚úÖ Comentarios creados: 3 comentarios de test',
                '‚úÖ Asignaciones configuradas correctamente',
                '<span class="privacy-indicator private">LISTO PARA TESTS</span>'
            ]);
        }

        function simulateNotificationPanel() {
            log('üîß Simulando funciones del panel de notificaciones...', 'info');

            // Simular funci√≥n checkStudentAssignmentToTask
            function checkStudentAssignmentToTask(task, studentId, studentUsername) {
                console.log(`üîç [Test] Verificando acceso para estudiante ${studentUsername} (ID: ${studentId}) a tarea "${task.title}"`);
                
                // Si la tarea est√° asignada a estudiantes espec√≠ficos
                if (task.assignedTo === 'student' && task.assignedStudentIds) {
                    const isDirectlyAssigned = task.assignedStudentIds.includes(studentId);
                    console.log(`üéØ [Test] Estudiante ${studentUsername} directamente asignado: ${isDirectlyAssigned ? '‚úÖ' : '‚ùå'}`);
                    return isDirectlyAssigned;
                }
                
                // Si la tarea est√° asignada a todo el curso
                if (task.assignedTo === 'course') {
                    const taskCourseId = task.courseSectionId || task.course;
                    if (!taskCourseId) return false;
                    
                    const usersText = localStorage.getItem('smart-student-users');
                    const allUsers = usersText ? JSON.parse(usersText) : [];
                    const studentData = allUsers.find(u => u.id === studentId || u.username === studentUsername);
                    
                    if (!studentData) return false;
                    
                    const studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');
                    
                    // Verificar asignaci√≥n por secci√≥n
                    const isAssignedToTaskSection = studentAssignments.some(assignment => 
                        assignment.studentId === studentId && 
                        assignment.courseId === 'MAT101' && // Simplificado para test
                        assignment.sectionId === 'section-A' // Secci√≥n de la tarea
                    );
                    
                    if (isAssignedToTaskSection) return true;
                    
                    // Fallback por activeCourses
                    return studentData.activeCourses?.includes(taskCourseId) || false;
                }
                
                return false;
            }

            // Simular loadUnreadComments corregida
            function testLoadUnreadComments(currentUser) {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                
                return comments.filter(comment => {
                    if (currentUser.role !== 'student') return false;
                    
                    const task = tasks.find(t => t.id === comment.taskId);
                    if (!task) return false;
                    
                    // üéØ FILTRO DE PRIVACIDAD: Verificar si el estudiante est√° asignado
                    const isAssigned = checkStudentAssignmentToTask(task, currentUser.id, currentUser.username);
                    
                    if (!isAssigned) {
                        console.log(`üö´ [loadUnreadComments] Comentario filtrado - estudiante ${currentUser.username} NO asignado a tarea "${task.title}"`);
                        return false;
                    }
                    
                    const notRead = !comment.readBy?.includes(currentUser.username);
                    const notOwnComment = comment.studentUsername !== currentUser.username;
                    
                    return notRead && notOwnComment;
                });
            }

            // Simular loadStudentSubmissions corregida
            function testLoadStudentSubmissions(currentUser) {
                if (currentUser.role !== 'teacher') return [];
                
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const teacherTaskIds = tasks.filter(t => t.teacherUsername === currentUser.username).map(t => t.id);
                
                return comments.filter(comment => {
                    const belongsToTeacher = teacherTaskIds.includes(comment.taskId);
                    const notFromTeacher = comment.studentUsername !== currentUser.username;
                    const notRead = !comment.readBy?.includes(currentUser.username);
                    const isComment = !comment.isSubmission;
                    
                    if (!belongsToTeacher || !notFromTeacher || !notRead || !isComment) {
                        return false;
                    }
                    
                    // üéØ NUEVO FILTRO: Verificar si el estudiante est√° asignado a la tarea
                    const task = tasks.find(t => t.id === comment.taskId);
                    if (task) {
                        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                        const studentData = users.find(u => u.username === comment.studentUsername);
                        
                        if (studentData) {
                            const isAssigned = checkStudentAssignmentToTask(task, studentData.id, comment.studentUsername);
                            if (!isAssigned) {
                                console.log(`üö´ [loadStudentSubmissions] Comentario de ${comment.studentUsername} filtrado - NO asignado a tarea "${task.title}"`);
                                return false;
                            }
                        }
                    }
                    
                    return true;
                });
            }

            // Exponer funciones para tests
            window.testFunctions = {
                checkStudentAssignmentToTask,
                testLoadUnreadComments,
                testLoadStudentSubmissions
            };

            log('‚úÖ Funciones del panel simuladas correctamente');
            displayResults('setup-result', [
                '‚úÖ checkStudentAssignmentToTask implementada',
                '‚úÖ loadUnreadComments con filtro de privacidad',
                '‚úÖ loadStudentSubmissions con filtro de privacidad',
                '<span class="privacy-indicator private">FUNCIONES LISTAS</span>'
            ]);
        }

        function testLoadUnreadComments() {
            log('üß™ Probando loadUnreadComments...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const results = [];
            
            // Test con estudiante asignado (Ana Garc√≠a)
            const assignedStudent = users.find(u => u.username === 'ana.garcia');
            const assignedComments = window.testFunctions.testLoadUnreadComments(assignedStudent);
            results.push(`üìã Estudiante asignado (${assignedStudent.name}): ${assignedComments.length} comentarios visibles`);
            
            // Test con estudiante NO asignado (Carlos L√≥pez)
            const nonAssignedStudent = users.find(u => u.username === 'carlos.lopez');
            const nonAssignedComments = window.testFunctions.testLoadUnreadComments(nonAssignedStudent);
            results.push(`üö´ Estudiante NO asignado (${nonAssignedStudent.name}): ${nonAssignedComments.length} comentarios visibles`);
            
            // Test con estudiante de otra secci√≥n (Mar√≠a Rodr√≠guez)
            const otherSectionStudent = users.find(u => u.username === 'maria.rodriguez');
            const otherSectionComments = window.testFunctions.testLoadUnreadComments(otherSectionStudent);
            results.push(`üè´ Estudiante otra secci√≥n (${otherSectionStudent.name}): ${otherSectionComments.length} comentarios visibles`);
            
            // Verificaci√≥n
            const passed = nonAssignedComments.length === 0 && otherSectionComments.length === 0;
            results.push('');
            results.push(passed ? 
                '<span class="result pass">‚úÖ TEST PASADO: Comentarios privados correctamente filtrados</span>' :
                '<span class="result fail">‚ùå TEST FALLIDO: Estudiantes no asignados ven comentarios</span>'
            );
            
            displayResults('test-result', results);
            log(passed ? '‚úÖ loadUnreadComments test PASADO' : '‚ùå loadUnreadComments test FALLIDO');
        }

        function testLoadStudentSubmissions() {
            log('üß™ Probando loadStudentSubmissions...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const teacher = users.find(u => u.role === 'teacher');
            const results = [];
            
            if (!teacher) {
                results.push('<span class="result fail">‚ùå No se encontr√≥ profesor para el test</span>');
                displayResults('test-result', results);
                return;
            }
            
            const teacherComments = window.testFunctions.testLoadStudentSubmissions(teacher);
            results.push(`üìù Profesor (${teacher.name}): ${teacherComments.length} comentarios de estudiantes visibles`);
            
            // Verificar que solo aparecen comentarios de estudiantes asignados
            const allowedStudents = ['ana.garcia']; // Solo Ana est√° asignada a task-001
            const visibleComments = teacherComments.filter(comment => 
                allowedStudents.includes(comment.studentUsername)
            );
            
            results.push(`‚úÖ Comentarios de estudiantes asignados: ${visibleComments.length}`);
            results.push(`üö´ Comentarios filtrados de estudiantes NO asignados: ${teacherComments.length - visibleComments.length}`);
            
            // Verificaci√≥n
            const passed = teacherComments.length === visibleComments.length && teacherComments.length === 1;
            results.push('');
            results.push(passed ? 
                '<span class="result pass">‚úÖ TEST PASADO: Solo comentarios de estudiantes asignados son visibles</span>' :
                '<span class="result fail">‚ùå TEST FALLIDO: Comentarios de estudiantes no asignados aparecen</span>'
            );
            
            displayResults('test-result', results);
            log(passed ? '‚úÖ loadStudentSubmissions test PASADO' : '‚ùå loadStudentSubmissions test FALLIDO');
        }

        function testCompletePrivacyFilter() {
            log('üß™ Probando filtro completo de privacidad...', 'info');
            
            testLoadUnreadComments();
            setTimeout(() => {
                testLoadStudentSubmissions();
                setTimeout(() => {
                    log('‚úÖ Tests de filtro completo terminados');
                }, 500);
            }, 500);
        }

        function simulateNonAssignedStudent() {
            log('üé≠ Simulando estudiante NO asignado...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const student = users.find(u => u.username === 'carlos.lopez');
            
            if (!student) {
                displayResults('scenario1-result', ['‚ùå Estudiante no encontrado']);
                return;
            }
            
            const comments = window.testFunctions.testLoadUnreadComments(student);
            const shouldSeeComments = comments.length;
            const bubbleCount = shouldSeeComments;
            
            const results = [
                `üë§ Estudiante: ${student.name} (${student.username})`,
                `üìã Estado: NO asignado a tareas espec√≠ficas`,
                `üí¨ Comentarios visibles: ${comments.length}`,
                `üî¥ Burbujas de notificaci√≥n: ${bubbleCount}`,
                ''
            ];
            
            if (bubbleCount === 0) {
                results.push('<span class="result pass">‚úÖ CORRECTO: No aparecen burbujas de comentarios</span>');
            } else {
                results.push('<span class="result fail">‚ùå PROBLEMA: Aparecen burbujas de comentarios cuando no deber√≠a</span>');
            }
            
            displayResults('scenario1-result', results);
        }

        function simulateTeacherNotifications() {
            log('üé≠ Simulando notificaciones de profesor...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const teacher = users.find(u => u.role === 'teacher');
            
            if (!teacher) {
                displayResults('scenario2-result', ['‚ùå Profesor no encontrado']);
                return;
            }
            
            const comments = window.testFunctions.testLoadStudentSubmissions(teacher);
            const validComments = comments.filter(c => c.studentUsername === 'ana.garcia'); // Solo comentarios v√°lidos
            
            const results = [
                `üë®‚Äçüè´ Profesor: ${teacher.name} (${teacher.username})`,
                `üìã Comentarios totales recibidos: ${comments.length}`,
                `‚úÖ Comentarios de estudiantes asignados: ${validComments.length}`,
                `üö´ Comentarios filtrados: ${comments.length - validComments.length}`,
                ''
            ];
            
            if (comments.length === validComments.length && validComments.length === 1) {
                results.push('<span class="result pass">‚úÖ CORRECTO: Solo comentarios de estudiantes asignados</span>');
            } else {
                results.push('<span class="result fail">‚ùå PROBLEMA: Aparecen comentarios de estudiantes no asignados</span>');
            }
            
            displayResults('scenario2-result', results);
        }

        function simulateAssignedStudent() {
            log('üé≠ Simulando estudiante asignado...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const student = users.find(u => u.username === 'ana.garcia');
            
            if (!student) {
                displayResults('scenario3-result', ['‚ùå Estudiante no encontrado']);
                return;
            }
            
            const comments = window.testFunctions.testLoadUnreadComments(student);
            
            const results = [
                `üë§ Estudiante: ${student.name} (${student.username})`,
                `üìã Estado: S√ç asignado a tareas espec√≠ficas`,
                `üí¨ Comentarios visibles: ${comments.length}`,
                `üî¥ Puede ver notificaciones: ${comments.length > 0 ? 'S√ç' : 'NO'}`,
                ''
            ];
            
            results.push('<span class="result pass">‚úÖ CORRECTO: Estudiante asignado puede ver comentarios relevantes</span>');
            
            displayResults('scenario3-result', results);
        }

        function runCompleteVerification() {
            log('üîé Ejecutando verificaci√≥n completa del sistema...', 'info');
            
            const results = [];
            let allTestsPassed = true;
            
            // Verificaci√≥n 1: loadUnreadComments
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const nonAssignedStudent = users.find(u => u.username === 'carlos.lopez');
            const nonAssignedComments = window.testFunctions.testLoadUnreadComments(nonAssignedStudent);
            
            const test1Pass = nonAssignedComments.length === 0;
            results.push(`1. loadUnreadComments - Filtro de privacidad: ${test1Pass ? '‚úÖ PASS' : '‚ùå FAIL'}`);
            if (!test1Pass) allTestsPassed = false;
            
            // Verificaci√≥n 2: loadStudentSubmissions
            const teacher = users.find(u => u.role === 'teacher');
            const teacherComments = window.testFunctions.testLoadStudentSubmissions(teacher);
            const validTeacherComments = teacherComments.filter(c => c.studentUsername === 'ana.garcia');
            
            const test2Pass = teacherComments.length === validTeacherComments.length && teacherComments.length === 1;
            results.push(`2. loadStudentSubmissions - Filtro de privacidad: ${test2Pass ? '‚úÖ PASS' : '‚ùå FAIL'}`);
            if (!test2Pass) allTestsPassed = false;
            
            // Verificaci√≥n 3: checkStudentAssignmentToTask
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const specificTask = tasks.find(t => t.assignedTo === 'student');
            const assignmentCheck1 = window.testFunctions.checkStudentAssignmentToTask(specificTask, 'student-001', 'ana.garcia');
            const assignmentCheck2 = window.testFunctions.checkStudentAssignmentToTask(specificTask, 'student-002', 'carlos.lopez');
            
            const test3Pass = assignmentCheck1 === true && assignmentCheck2 === false;
            results.push(`3. checkStudentAssignmentToTask - Verificaci√≥n: ${test3Pass ? '‚úÖ PASS' : '‚ùå FAIL'}`);
            if (!test3Pass) allTestsPassed = false;
            
            // Verificaci√≥n 4: Eliminaci√≥n de burbujas
            const bubbleTest1 = nonAssignedComments.length === 0;
            const bubbleTest2 = teacherComments.filter(c => c.studentUsername !== 'ana.garcia').length === 0;
            
            const test4Pass = bubbleTest1 && bubbleTest2;
            results.push(`4. Eliminaci√≥n de burbujas - Completa: ${test4Pass ? '‚úÖ PASS' : '‚ùå FAIL'}`);
            if (!test4Pass) allTestsPassed = false;
            
            results.push('');
            results.push('üìä RESUMEN FINAL:');
            results.push('');
            
            if (allTestsPassed) {
                results.push('<span class="result pass">üéâ TODOS LOS TESTS PASARON</span>');
                results.push('<span class="result pass">‚úÖ Las burbujas de comentarios han sido eliminadas correctamente</span>');
                results.push('<span class="result pass">‚úÖ Solo estudiantes asignados ven comentarios privados</span>');
                results.push('<span class="result pass">‚úÖ Los profesores solo ven comentarios de estudiantes asignados</span>');
            } else {
                results.push('<span class="result fail">‚ùå ALGUNOS TESTS FALLARON</span>');
                results.push('<span class="result fail">üîß Se requieren ajustes adicionales</span>');
            }
            
            displayResults('verification-result', results);
            log(allTestsPassed ? 'üéâ Verificaci√≥n completa EXITOSA' : '‚ùå Verificaci√≥n completa FALLIDA');
        }

        function clearAllData() {
            log('üóëÔ∏è Limpiando datos de test...', 'info');
            
            const keysToRemove = [
                'smart-student-users',
                'smart-student-tasks',
                'smart-student-task-comments',
                'smart-student-student-assignments',
                'smart-student-sections',
                'smart-student-courses',
                'smart-student-teacher-assignments'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            displayResults('setup-result', [
                'üóëÔ∏è Todos los datos de test eliminados',
                '‚úÖ localStorage limpio',
                '<span class="privacy-indicator public">LISTO PARA NUEVO TEST</span>'
            ]);
            
            log('‚úÖ Datos limpiados correctamente');
        }

        // Inicializaci√≥n autom√°tica
        window.addEventListener('load', function() {
            log('üöÄ Test de eliminaci√≥n de burbujas iniciado', 'info');
            displayResults('setup-result', [
                'üìã Preparado para configurar test',
                'üéØ Objetivo: Eliminar burbujas de comentarios para estudiantes no asignados',
                'üîß Configurar datos de test primero'
            ]);
        });
    </script>
</body>
</html>
