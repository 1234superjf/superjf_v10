<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Comment Notifications - SMART STUDENT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #f97316;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #f97316;
        }
        .section h2 {
            color: #333;
            margin-top: 0;
        }
        .test-case {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .test-case h3 {
            color: #f97316;
            margin-top: 0;
        }
        .button {
            background: #f97316;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #ea580c;
        }
        .log {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            color: #16a34a;
            font-weight: bold;
        }
        .error {
            color: #dc2626;
            font-weight: bold;
        }
        .info {
            color: #2563eb;
        }
        .highlight-demo {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .highlight-demo.unread {
            border-color: #f97316;
            background-color: #fef3cd;
        }
        .highlight-demo.read {
            border-color: #d1d5db;
            background-color: #f9fafb;
        }
        .simulate-navigation {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #93c5fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test de Notificaciones de Comentarios</h1>
        
        <div class="section">
            <h2>üìã Funcionalidades Implementadas</h2>
            <p>Se han implementado las siguientes mejoras para las notificaciones de comentarios:</p>
            <ul>
                <li><strong>Navegaci√≥n directa:</strong> Al hacer clic en "ver comentario" se abre la tarea y se desplaza al comentario espec√≠fico</li>
                <li><strong>Resaltado visual:</strong> Los comentarios no le√≠dos del profesor aparecen destacados con borde naranja</li>
                <li><strong>Marcado autom√°tico masivo:</strong> Al entrar a una tarea desde notificaciones se marcan TODOS los comentarios no le√≠dos como le√≠dos</li>
                <li><strong>Marcado granular:</strong> Al hacer clic en un comentario espec√≠fico solo se marca ese comentario como le√≠do</li>
                <li><strong>Identificaci√≥n √∫nica:</strong> Cada comentario tiene un ID √∫nico para navegaci√≥n directa</li>
            </ul>
        </div>

        <div class="section">
            <h2>üéØ Casos de Prueba</h2>
            
            <div class="test-case">
                <h3>1. Navegaci√≥n desde Notificaci√≥n</h3>
                <p>Simula el flujo completo desde el panel de notificaciones hasta el comentario espec√≠fico.</p>
                
                <div class="simulate-navigation">
                    <strong>Flujo de navegaci√≥n mejorado:</strong><br>
                    1. Usuario hace clic en "ver comentario" desde el panel de notificaciones<br>
                    2. Se navega a: <code>/dashboard/tareas?taskId=task_123&commentId=comment_456</code><br>
                    3. Se abre autom√°ticamente el di√°logo de la tarea<br>
                    4. Se desplaza al comentario espec√≠fico y lo resalta temporalmente<br>
                    5. <strong>‚ú® NUEVO:</strong> Se marcan TODOS los comentarios no le√≠dos de la tarea como le√≠dos<br>
                    6. <strong>üéØ Comportamiento:</strong> Simula "revisar toda la tarea" no solo un comentario
                </div>
                
                <button class="button" onclick="testNavigationFlow()">Simular Navegaci√≥n</button>
                <div id="navigation-log" class="log"></div>
            </div>

            <div class="test-case">
                <h3>2. Comentarios No Le√≠dos</h3>
                <p>Demuestra c√≥mo se ven los comentarios no le√≠dos vs le√≠dos.</p>
                
                <div class="highlight-demo unread" id="unread-demo">
                    <strong>üì© Comentario NO LE√çDO del Profesor</strong><br>
                    <small>Profesor Garc√≠a - hace 2 horas</small><br>
                    "Excelente trabajo en la primera parte, pero necesitas mejorar la conclusi√≥n..."
                </div>
                
                <div class="highlight-demo read" id="read-demo">
                    <strong>‚úì Comentario LE√çDO del Profesor</strong><br>
                    <small>Profesor Garc√≠a - hace 1 d√≠a</small><br>
                    "Muy bien explicado el tema de las fracciones."
                </div>
                
                <button class="button" onclick="toggleReadStatus()">Cambiar Estado de Lectura</button>
                <div id="read-status-log" class="log"></div>
            </div>

            <div class="test-case">
                <h3>3. Gesti√≥n de Estado de Lectura</h3>
                <p>Prueba las funciones de marcado como le√≠do/no le√≠do.</p>
                
                <button class="button" onclick="createMultipleTestComments()">Crear M√∫ltiples Comentarios</button>
                <button class="button" onclick="markSingleAsRead()">Marcar UNO como Le√≠do</button>
                <button class="button" onclick="markAllTaskAsRead()">Marcar TODOS de la Tarea como Le√≠dos</button>
                <button class="button" onclick="checkAllReadStatus()">Verificar Estado de Todos</button>
                <div id="read-management-log" class="log"></div>
            </div>
        </div>

        <div class="section">
            <h2>üîß Funciones de Desarrollo</h2>
            
            <div class="test-case">
                <h3>Debug y Mantenimiento</h3>
                
                <button class="button" onclick="inspectComments()">Inspeccionar Comentarios</button>
                <button class="button" onclick="inspectNotifications()">Inspeccionar Notificaciones</button>
                <button class="button" onclick="clearTestData()">Limpiar Datos de Prueba</button>
                <button class="button" onclick="resetToDefaults()">Restaurar Valores por Defecto</button>
                <div id="debug-log" class="log"></div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Estado del Sistema</h2>
            <div id="system-status" class="log">
                Cargando estado del sistema...
            </div>
            <button class="button" onclick="refreshSystemStatus()">Actualizar Estado</button>
        </div>
    </div>

    <script>
        // Utility functions
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Test functions
        function testNavigationFlow() {
            clearLog('navigation-log');
            log('navigation-log', 'üöÄ Iniciando simulaci√≥n de navegaci√≥n...', 'info');
            
            // Simulate creating a test task and comment
            const testTask = {
                id: 'task_test_' + Date.now(),
                title: 'Tarea de Matem√°ticas - Fracciones',
                description: 'Resolver ejercicios de fracciones del cap√≠tulo 5',
                course: '5A',
                subject: 'Matem√°ticas',
                assignedBy: 'profesor1',
                assignedByName: 'Prof. Garc√≠a',
                dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString(),
                status: 'pending'
            };

            const testComment = {
                id: 'comment_test_' + Date.now(),
                taskId: testTask.id,
                studentUsername: 'estudiante1',
                studentName: 'Ana Rodr√≠guez',
                comment: 'Profesor, tengo dudas sobre el ejercicio 3. ¬øPodr√≠as explic√°rmelo?',
                timestamp: new Date().toISOString(),
                isSubmission: false,
                userRole: 'student'
            };

            const teacherComment = {
                id: 'comment_teacher_' + Date.now(),
                taskId: testTask.id,
                studentUsername: 'profesor1',
                studentName: 'Prof. Garc√≠a',
                comment: 'Claro Ana, el ejercicio 3 requiere que primero encuentres el denominador com√∫n...',
                timestamp: new Date().toISOString(),
                isSubmission: false,
                userRole: 'teacher',
                readBy: [] // Not read by student yet
            };

            // Save to localStorage
            try {
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                
                tasks.push(testTask);
                comments.push(testComment, teacherComment);
                
                localStorage.setItem('smart-student-tasks', JSON.stringify(tasks));
                localStorage.setItem('smart-student-task-comments', JSON.stringify(comments));
                
                log('navigation-log', '‚úÖ Tarea y comentarios de prueba creados', 'success');
                log('navigation-log', `üìù Tarea ID: ${testTask.id}`, 'info');
                log('navigation-log', `üí¨ Comentario del profesor ID: ${teacherComment.id}`, 'info');
                log('navigation-log', 'üîó URL de navegaci√≥n simulada:', 'info');
                log('navigation-log', `/dashboard/tareas?taskId=${testTask.id}&commentId=${teacherComment.id}`, 'info');
                log('navigation-log', 'üìç El comentario del profesor aparecer√° DESTACADO para el estudiante', 'success');
                
            } catch (error) {
                log('navigation-log', '‚ùå Error al crear datos de prueba: ' + error.message, 'error');
            }
        }

        function toggleReadStatus() {
            clearLog('read-status-log');
            const unreadDemo = document.getElementById('unread-demo');
            const readDemo = document.getElementById('read-demo');
            
            // Toggle classes
            if (unreadDemo.classList.contains('unread')) {
                unreadDemo.classList.remove('unread');
                unreadDemo.classList.add('read');
                unreadDemo.innerHTML = '<strong>‚úì Comentario LE√çDO del Profesor</strong><br><small>Profesor Garc√≠a - hace 2 horas</small><br>"Excelente trabajo en la primera parte, pero necesitas mejorar la conclusi√≥n..."';
                log('read-status-log', '‚úÖ Comentario marcado como LE√çDO', 'success');
            } else {
                unreadDemo.classList.remove('read');
                unreadDemo.classList.add('unread');
                unreadDemo.innerHTML = '<strong>üì© Comentario NO LE√çDO del Profesor</strong><br><small>Profesor Garc√≠a - hace 2 horas</small><br>"Excelente trabajo en la primera parte, pero necesitas mejorar la conclusi√≥n..."';
                log('read-status-log', 'üì© Comentario marcado como NO LE√çDO', 'info');
            }
            
            log('read-status-log', 'üé® Demostraci√≥n de cambio visual completada', 'info');
        }

        function createMultipleTestComments() {
            clearLog('read-management-log');
            
            const testTaskId = 'task_multiple_comments_' + Date.now();
            
            // Create 3 test comments from teacher
            const testComments = [
                {
                    id: 'comment_1_' + Date.now(),
                    taskId: testTaskId,
                    studentUsername: 'profesor1',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Primer comentario: Muy buen trabajo en la introducci√≥n.',
                    timestamp: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: []
                },
                {
                    id: 'comment_2_' + Date.now() + 1,
                    taskId: testTaskId,
                    studentUsername: 'profesor1',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Segundo comentario: Necesitas mejorar la conclusi√≥n.',
                    timestamp: new Date(Date.now() - 1800000).toISOString(), // 30 min ago
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: []
                },
                {
                    id: 'comment_3_' + Date.now() + 2,
                    taskId: testTaskId,
                    studentUsername: 'profesor1',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Tercer comentario: Excelente uso de ejemplos pr√°cticos.',
                    timestamp: new Date().toISOString(), // now
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: []
                }
            ];
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                testComments.forEach(comment => comments.push(comment));
                localStorage.setItem('smart-student-task-comments', JSON.stringify(comments));
                localStorage.setItem('test-task-id', testTaskId);
                
                log('read-management-log', '‚úÖ Creados 3 comentarios del profesor para la misma tarea', 'success');
                log('read-management-log', `üìù Tarea ID: ${testTaskId}`, 'info');
                log('read-management-log', 'üìä Estado inicial: TODOS NO LE√çDOS', 'info');
                log('read-management-log', 'üí° Esto simula m√∫ltiples comentarios nuevos del profesor', 'info');
                
            } catch (error) {
                log('read-management-log', '‚ùå Error al crear comentarios: ' + error.message, 'error');
            }
        }

        function markSingleAsRead() {
            const testTaskId = localStorage.getItem('test-task-id');
            if (!testTaskId) {
                log('read-management-log', '‚ö†Ô∏è Primero debes crear comentarios de prueba', 'error');
                return;
            }
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const taskComments = comments.filter(c => c.taskId === testTaskId);
                
                if (taskComments.length === 0) {
                    log('read-management-log', '‚ö†Ô∏è No hay comentarios para esta tarea', 'error');
                    return;
                }
                
                // Mark only the first unread comment as read
                const updatedComments = comments.map(comment => {
                    if (comment.taskId === testTaskId && 
                        comment.userRole === 'teacher' && 
                        !comment.readBy?.includes('estudiante1')) {
                        return {
                            ...comment,
                            readBy: [...(comment.readBy || []), 'estudiante1']
                        };
                    }
                    return comment;
                });
                
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                log('read-management-log', '‚úÖ PRIMER comentario marcado como le√≠do', 'success');
                log('read-management-log', 'üìä Los otros comentarios siguen SIN LEER', 'info');
                
            } catch (error) {
                log('read-management-log', '‚ùå Error al marcar como le√≠do: ' + error.message, 'error');
            }
        }

        function markAllTaskAsRead() {
            const testTaskId = localStorage.getItem('test-task-id');
            if (!testTaskId) {
                log('read-management-log', '‚ö†Ô∏è Primero debes crear comentarios de prueba', 'error');
                return;
            }
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                let markedCount = 0;
                
                // Mark ALL teacher comments in this task as read
                const updatedComments = comments.map(comment => {
                    if (comment.taskId === testTaskId && 
                        comment.userRole === 'teacher' && 
                        !comment.readBy?.includes('estudiante1')) {
                        markedCount++;
                        return {
                            ...comment,
                            isNew: false,
                            readBy: [...(comment.readBy || []), 'estudiante1']
                        };
                    }
                    return comment;
                });
                
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                log('read-management-log', `‚úÖ TODOS los comentarios marcados como le√≠dos (${markedCount} comentarios)`, 'success');
                log('read-management-log', 'üí° Esto simula entrar a la tarea desde notificaciones', 'info');
                log('read-management-log', 'üéØ Comportamiento esperado: revisar TODA la tarea', 'success');
                
            } catch (error) {
                log('read-management-log', '‚ùå Error al marcar todos como le√≠dos: ' + error.message, 'error');
            }
        }

        function checkAllReadStatus() {
            const testTaskId = localStorage.getItem('test-task-id');
            if (!testTaskId) {
                log('read-management-log', '‚ö†Ô∏è Primero debes crear comentarios de prueba', 'error');
                return;
            }
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const taskComments = comments.filter(c => c.taskId === testTaskId);
                
                if (taskComments.length === 0) {
                    log('read-management-log', '‚ùå No hay comentarios para esta tarea', 'error');
                    return;
                }
                
                log('read-management-log', `üìä Estado de ${taskComments.length} comentarios:`, 'info');
                
                taskComments.forEach((comment, index) => {
                    const isRead = comment.readBy?.includes('estudiante1') || false;
                    const status = isRead ? 'LE√çDO ‚úÖ' : 'NO LE√çDO üì©';
                    const timestamp = new Date(comment.timestamp).toLocaleTimeString();
                    
                    log('read-management-log', `   ${index + 1}. ${status} - ${timestamp}`, isRead ? 'success' : 'info');
                    log('read-management-log', `      "${comment.comment.substring(0, 50)}..."`, 'info');
                });
                
                const unreadCount = taskComments.filter(c => !c.readBy?.includes('estudiante1')).length;
                log('read-management-log', `üìà Resumen: ${unreadCount} sin leer, ${taskComments.length - unreadCount} le√≠dos`, 'info');
                
            } catch (error) {
                log('read-management-log', '‚ùå Error al verificar estado: ' + error.message, 'error');
            }
        }

        function inspectComments() {
            clearLog('debug-log');
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                log('debug-log', `üìä Total de comentarios en el sistema: ${comments.length}`, 'info');
                
                if (comments.length === 0) {
                    log('debug-log', 'üìù No hay comentarios en el sistema', 'info');
                    return;
                }
                
                comments.forEach((comment, index) => {
                    log('debug-log', `üìù Comentario ${index + 1}:`, 'info');
                    log('debug-log', `   ID: ${comment.id}`, 'info');
                    log('debug-log', `   Tarea: ${comment.taskId}`, 'info');
                    log('debug-log', `   Usuario: ${comment.studentName} (${comment.userRole || 'student'})`, 'info');
                    log('debug-log', `   Le√≠do por: ${comment.readBy?.join(', ') || 'nadie'}`, 'info');
                    log('debug-log', `   Es entrega: ${comment.isSubmission ? 'S√≠' : 'No'}`, 'info');
                    log('debug-log', '   ---', 'info');
                });
                
            } catch (error) {
                log('debug-log', '‚ùå Error al inspeccionar comentarios: ' + error.message, 'error');
            }
        }

        function inspectNotifications() {
            clearLog('debug-log');
            
            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-notifications') || '[]');
                log('debug-log', `üîî Total de notificaciones: ${notifications.length}`, 'info');
                
                if (notifications.length === 0) {
                    log('debug-log', 'üîî No hay notificaciones en el sistema', 'info');
                    return;
                }
                
                notifications.forEach((notification, index) => {
                    log('debug-log', `üîî Notificaci√≥n ${index + 1}:`, 'info');
                    log('debug-log', `   ID: ${notification.id}`, 'info');
                    log('debug-log', `   Tipo: ${notification.type}`, 'info');
                    log('debug-log', `   Tarea: ${notification.taskTitle}`, 'info');
                    log('debug-log', `   Para usuarios: ${notification.targetUsernames?.join(', ') || 'no especificado'}`, 'info');
                    log('debug-log', `   Le√≠da: ${notification.isRead ? 'S√≠' : 'No'}`, 'info');
                    log('debug-log', '   ---', 'info');
                });
                
            } catch (error) {
                log('debug-log', '‚ùå Error al inspeccionar notificaciones: ' + error.message, 'error');
            }
        }

        function clearTestData() {
            clearLog('debug-log');
            
            try {
                // Remove test comments
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const filteredComments = comments.filter(comment => 
                    !comment.id.includes('test') && !comment.id.includes('management')
                );
                localStorage.setItem('smart-student-task-comments', JSON.stringify(filteredComments));
                
                // Remove test tasks
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const filteredTasks = tasks.filter(task => !task.id.includes('test'));
                localStorage.setItem('smart-student-tasks', JSON.stringify(filteredTasks));
                
                // Remove test comment ID
                localStorage.removeItem('test-comment-id');
                
                log('debug-log', 'üßπ Datos de prueba eliminados exitosamente', 'success');
                log('debug-log', `üìù Comentarios restantes: ${filteredComments.length}`, 'info');
                log('debug-log', `üìã Tareas restantes: ${filteredTasks.length}`, 'info');
                
            } catch (error) {
                log('debug-log', '‚ùå Error al limpiar datos: ' + error.message, 'error');
            }
        }

        function resetToDefaults() {
            clearLog('debug-log');
            
            if (confirm('‚ö†Ô∏è Esto eliminar√° TODOS los comentarios y tareas del sistema. ¬øContinuar?')) {
                try {
                    localStorage.setItem('smart-student-task-comments', JSON.stringify([]));
                    localStorage.setItem('smart-student-tasks', JSON.stringify([]));
                    localStorage.setItem('smart-student-notifications', JSON.stringify([]));
                    localStorage.removeItem('test-comment-id');
                    
                    log('debug-log', 'üîÑ Sistema restaurado a valores por defecto', 'success');
                    log('debug-log', 'üìù Todos los comentarios eliminados', 'info');
                    log('debug-log', 'üìã Todas las tareas eliminadas', 'info');
                    log('debug-log', 'üîî Todas las notificaciones eliminadas', 'info');
                    
                } catch (error) {
                    log('debug-log', '‚ùå Error al restaurar: ' + error.message, 'error');
                }
            } else {
                log('debug-log', '‚ùå Operaci√≥n cancelada por el usuario', 'info');
            }
        }

        function refreshSystemStatus() {
            const statusElement = document.getElementById('system-status');
            statusElement.innerHTML = '';
            
            try {
                const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const notifications = JSON.parse(localStorage.getItem('smart-student-notifications') || '[]');
                
                const unreadComments = comments.filter(c => 
                    c.userRole === 'teacher' && !c.readBy?.includes('estudiante1')
                ).length;
                
                statusElement.innerHTML = `
                    <span class="success">üìä Estado del Sistema (${new Date().toLocaleTimeString()})</span><br>
                    <span class="info">üìù Total de comentarios: ${comments.length}</span><br>
                    <span class="info">üìã Total de tareas: ${tasks.length}</span><br>
                    <span class="info">üîî Total de notificaciones: ${notifications.length}</span><br>
                    <span class="info">üì© Comentarios no le√≠dos del profesor: ${unreadComments}</span><br>
                    <span class="info">üîß Funcionalidades implementadas:</span><br>
                    <span class="success">  ‚úÖ Navegaci√≥n directa a comentarios</span><br>
                    <span class="success">  ‚úÖ Resaltado de comentarios no le√≠dos</span><br>
                    <span class="success">  ‚úÖ Marcado autom√°tico como le√≠do</span><br>
                    <span class="success">  ‚úÖ IDs √∫nicos para cada comentario</span><br>
                `;
                
            } catch (error) {
                statusElement.innerHTML = `<span class="error">‚ùå Error al cargar estado: ${error.message}</span>`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshSystemStatus();
            
            // Auto-refresh status every 30 seconds
            setInterval(refreshSystemStatus, 30000);
        });
    </script>
</body>
</html>
