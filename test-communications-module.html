<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Módulo de Comunicaciones para Profesores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #2563eb;
        }
        .button.success {
            background: #10b981;
        }
        .button.danger {
            background: #ef4444;
        }
        .button.warning {
            background: #f59e0b;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .communication-card {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .communication-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .communication-content {
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .communication-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #9ca3af;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #e5e7eb;
            color: #374151;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.course {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge.student {
            background: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            🔧 Test: Módulo de Comunicaciones para Profesores
        </h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Panel de configuración -->
            <div class="space-y-6">
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">📊 Estado del Sistema</h2>
                    <div id="system-status"></div>
                    <button class="button" onclick="checkSystemStatus()">🔍 Verificar Estado</button>
                </div>

                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">🔧 Configuración de Datos</h2>
                    <div class="space-y-3">
                        <button class="button success" onclick="setupTestData()">1. 📚 Configurar Cursos y Estudiantes</button>
                        <button class="button" onclick="createSampleCommunications()">2. 📝 Crear Comunicaciones de Ejemplo</button>
                        <button class="button warning" onclick="loginAsTeacher()">3. 👨‍🏫 Login como Profesor</button>
                        <button class="button danger" onclick="cleanupTestData()">🧹 Limpiar Datos de Prueba</button>
                    </div>
                    <div id="setup-status"></div>
                </div>

                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">📱 Navegación a Comunicaciones</h2>
                    <div class="space-y-3">
                        <button class="button" onclick="goToCommunications()">🚀 Ir a Comunicaciones</button>
                        <p class="text-sm text-gray-600">
                            <strong>Nota:</strong> Asegúrate de estar logueado como profesor para ver la pestaña de comunicaciones.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Panel de resultados -->
            <div class="space-y-6">
                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">📈 Estadísticas</h2>
                    <div id="statistics"></div>
                    <button class="button" onclick="showStatistics()">📊 Mostrar Estadísticas</button>
                </div>

                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">📋 Comunicaciones Creadas</h2>
                    <div id="communications-list"></div>
                    <button class="button" onclick="loadCommunications()">📨 Cargar Comunicaciones</button>
                </div>

                <div class="test-section">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">👥 Usuarios de Prueba</h2>
                    <div id="test-users"></div>
                    <button class="button" onclick="showTestUsers()">👤 Mostrar Usuarios</button>
                </div>
            </div>
        </div>

        <div class="test-section mt-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">📝 Log de Actividades</h2>
            <div id="activity-log" class="bg-gray-900 text-green-400 p-4 rounded text-sm font-mono h-64 overflow-y-auto"></div>
            <button class="button" onclick="clearLog()">🗑️ Limpiar Log</button>
        </div>
    </div>

    <script src="setup-communications-test-data.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#22d3ee',
                success: '#10b981', 
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkSystemStatus() {
            log('🔍 Verificando estado del sistema...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
            const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
            const communications = JSON.parse(localStorage.getItem('smart-student-communications') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('smart-student-user') || 'null');
            
            const teachers = users.filter(u => u.role === 'teacher');
            const students = users.filter(u => u.role === 'student');
            
            const status = `
                <strong>📊 Estado del Sistema:</strong><br>
                👥 Usuarios totales: ${users.length}<br>
                👨‍🏫 Profesores: ${teachers.length}<br>
                👨‍🎓 Estudiantes: ${students.length}<br>
                📚 Cursos: ${courses.length}<br>
                📖 Secciones: ${sections.length}<br>
                📨 Comunicaciones: ${communications.length}<br>
                🔑 Usuario actual: ${currentUser ? `${currentUser.displayName} (${currentUser.role})` : 'No logueado'}
            `;
            
            showStatus('system-status', status, 'info');
            log(`✅ Estado verificado: ${users.length} usuarios, ${courses.length} cursos, ${communications.length} comunicaciones`, 'success');
        }

        function setupTestData() {
            log('📚 Configurando datos de prueba...', 'info');
            
            try {
                const result = setupCommunicationsTestData();
                showStatus('setup-status', `✅ Datos configurados correctamente:<br>📚 ${result.courses.length} cursos<br>📖 ${result.sections.length} secciones<br>👨‍🎓 ${result.students.length} estudiantes<br>👨‍🏫 1 profesor`, 'success');
                log('✅ Datos de prueba configurados exitosamente', 'success');
            } catch (error) {
                log(`❌ Error al configurar datos: ${error.message}`, 'error');
                showStatus('setup-status', `❌ Error: ${error.message}`, 'error');
            }
        }

        function createSampleCommunications() {
            log('📝 Creando comunicaciones de ejemplo...', 'info');
            
            try {
                const communications = createSampleCommunications();
                showStatus('setup-status', `✅ ${communications.length} comunicaciones de ejemplo creadas`, 'success');
                log(`✅ ${communications.length} comunicaciones de ejemplo creadas`, 'success');
                loadCommunications();
            } catch (error) {
                log(`❌ Error al crear comunicaciones: ${error.message}`, 'error');
                showStatus('setup-status', `❌ Error: ${error.message}`, 'error');
            }
        }

        function loginAsTeacher() {
            log('👨‍🏫 Haciendo login como profesor...', 'info');
            
            const teacher = {
                id: 'teacher_comunicaciones',
                username: 'profesor_comunicaciones',
                role: 'teacher',
                displayName: 'Profesor Comunicaciones',
                email: 'comunicaciones@profesor.com',
                activeCourses: ['1ro_basico', '2do_basico', '3ro_basico']
            };
            
            localStorage.setItem('smart-student-user', JSON.stringify(teacher));
            showStatus('setup-status', `✅ Login exitoso como: ${teacher.displayName}`, 'success');
            log(`✅ Login exitoso como: ${teacher.displayName}`, 'success');
            checkSystemStatus();
        }

        function cleanupTestData() {
            log('🧹 Limpiando datos de prueba...', 'warning');
            
            try {
                cleanupCommunicationsTestData();
                showStatus('setup-status', '✅ Datos de prueba limpiados', 'success');
                log('✅ Datos de prueba limpiados exitosamente', 'success');
                checkSystemStatus();
            } catch (error) {
                log(`❌ Error al limpiar datos: ${error.message}`, 'error');
                showStatus('setup-status', `❌ Error: ${error.message}`, 'error');
            }
        }

        function goToCommunications() {
            log('🚀 Navegando a módulo de comunicaciones...', 'info');
            window.open('/dashboard/comunicaciones', '_blank');
        }

        function showStatistics() {
            log('📊 Mostrando estadísticas...', 'info');
            
            const communications = JSON.parse(localStorage.getItem('smart-student-communications') || '[]');
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            
            const courseComms = communications.filter(c => c.type === 'course');
            const studentComms = communications.filter(c => c.type === 'student');
            const teachers = users.filter(u => u.role === 'teacher');
            const students = users.filter(u => u.role === 'student');
            
            const stats = `
                <strong>📈 Estadísticas del Sistema:</strong><br>
                📨 Total comunicaciones: ${communications.length}<br>
                🏫 Comunicaciones a cursos: ${courseComms.length}<br>
                👤 Comunicaciones a estudiantes: ${studentComms.length}<br>
                👨‍🏫 Profesores registrados: ${teachers.length}<br>
                👨‍🎓 Estudiantes registrados: ${students.length}
            `;
            
            showStatus('statistics', stats, 'info');
            log(`📊 Estadísticas mostradas: ${communications.length} comunicaciones totales`, 'success');
        }

        function loadCommunications() {
            log('📨 Cargando comunicaciones...', 'info');
            
            const communications = JSON.parse(localStorage.getItem('smart-student-communications') || '[]');
            const commListDiv = document.getElementById('communications-list');
            
            if (communications.length === 0) {
                commListDiv.innerHTML = '<p class="text-gray-500">No hay comunicaciones creadas</p>';
                return;
            }
            
            let html = '';
            communications.forEach(comm => {
                const date = new Date(comm.createdAt).toLocaleDateString();
                const typeClass = comm.type === 'course' ? 'course' : 'student';
                const typeText = comm.type === 'course' ? '🏫 Curso' : '👤 Estudiante';
                
                html += `
                    <div class="communication-card">
                        <div class="communication-title">${comm.title}</div>
                        <div class="communication-content">${comm.content.substring(0, 100)}${comm.content.length > 100 ? '...' : ''}</div>
                        <div class="communication-meta">
                            <span><span class="badge ${typeClass}">${typeText}</span> ${date}</span>
                            <span>Por: ${comm.createdBy}</span>
                        </div>
                    </div>
                `;
            });
            
            commListDiv.innerHTML = html;
            log(`📨 ${communications.length} comunicaciones cargadas`, 'success');
        }

        function showTestUsers() {
            log('👥 Mostrando usuarios de prueba...', 'info');
            
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            const testUsersDiv = document.getElementById('test-users');
            
            const teachers = users.filter(u => u.role === 'teacher');
            const students = users.filter(u => u.role === 'student');
            
            let html = '<strong>👨‍🏫 Profesores:</strong><br>';
            teachers.forEach(teacher => {
                html += `• ${teacher.displayName} (${teacher.username})<br>`;
            });
            
            html += '<br><strong>👨‍🎓 Estudiantes:</strong><br>';
            students.forEach(student => {
                html += `• ${student.displayName} (${student.username})<br>`;
            });
            
            testUsersDiv.innerHTML = html;
            log(`👥 Mostrados ${teachers.length} profesores y ${students.length} estudiantes`, 'success');
        }

        function clearLog() {
            document.getElementById('activity-log').innerHTML = '';
            log('🗑️ Log limpiado', 'info');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Test de comunicaciones iniciado', 'success');
            log('ℹ️ Sigue los pasos: 1) Configurar datos, 2) Login como profesor, 3) Ir a comunicaciones', 'info');
            checkSystemStatus();
        });
    </script>
</body>
</html>
