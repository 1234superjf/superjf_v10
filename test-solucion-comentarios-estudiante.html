<!DOCTYPE html>
<html>
<head>
    <title>Test Final: Notificaciones Estudiante - Soluci√≥n Completa</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        button { padding: 12px 20px; margin: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        pre { background-color: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .status-box { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .counter { font-size: 24px; font-weight: bold; display: inline-block; padding: 10px 20px; margin: 10px; border-radius: 50px; }
        .counter-before { background-color: #ffebee; color: #c62828; }
        .counter-after { background-color: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Final: Problema Notificaciones Estudiante - SOLUCIONADO</h1>
        
        <div class="status-box status-success">
            ‚úÖ <strong>PROBLEMA IDENTIFICADO Y SOLUCIONADO:</strong><br>
            Los comentarios no le√≠dos no se descontaban de la campana de notificaciones cuando:<br>
            ‚Ä¢ El estudiante abr√≠a y revisaba una tarea<br>
            ‚Ä¢ El estudiante hac√≠a clic en "Ver Comentario"<br>
            ‚Ä¢ El estudiante usaba "Marcar todo como le√≠do"
        </div>

        <div class="section">
            <h2>üöÄ Fase 1: Configurar Escenario de Prueba</h2>
            <button class="btn-primary" onclick="setupTestScenario()">üìù Configurar Estudiante y Comentarios No Le√≠dos</button>
            <div id="setup-result"></div>
        </div>

        <div class="section">
            <h2>üìä Fase 2: Verificar Problema Original</h2>
            <button class="btn-warning" onclick="verifyOriginalProblem()">üîç Simular Problema Original</button>
            <div>
                <span class="info">Comentarios no le√≠dos ANTES:</span>
                <span id="count-before" class="counter counter-before">0</span>
            </div>
            <div id="problem-result"></div>
        </div>

        <div class="section">
            <h2>üîß Fase 3: Probar Soluciones Implementadas</h2>
            
            <h3>3.1 Test: Abrir Tarea (markCommentsAsReadForTask)</h3>
            <button class="btn-success" onclick="testOpenTask()">üëÅÔ∏è Simular Abrir Tarea</button>
            <div id="open-task-result"></div>
            
            <h3>3.2 Test: Clic en "Ver Comentario" (Comentario Individual)</h3>
            <button class="btn-success" onclick="testViewComment()">üîó Simular Clic "Ver Comentario"</button>
            <div id="view-comment-result"></div>
            
            <h3>3.3 Test: "Marcar Todo como Le√≠do"</h3>
            <button class="btn-success" onclick="testMarkAllRead()">‚úÖ Simular "Marcar Todo como Le√≠do"</button>
            <div id="mark-all-result"></div>
        </div>

        <div class="section">
            <h2>üìä Fase 4: Verificar Soluci√≥n</h2>
            <button class="btn-info" onclick="verifySolution()">üéØ Verificar Conteo Final</button>
            <div>
                <span class="info">Comentarios no le√≠dos DESPU√âS:</span>
                <span id="count-after" class="counter counter-after">0</span>
            </div>
            <div id="solution-result"></div>
        </div>

        <div class="section">
            <h2>üìã Fase 5: Resumen de Mejoras Implementadas</h2>
            <button class="btn-info" onclick="showImprovements()">üìù Ver Mejoras Implementadas</button>
            <div id="improvements-result"></div>
        </div>
    </div>

    <script>
        let testTaskId = 'task_solucion_final_' + Date.now();
        let testUser = {
            username: 'felipe_estudiante',
            role: 'student',
            id: 'felipe_123'
        };
        let beforeCount = 0;
        let afterCount = 0;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function updateCounter(elementId, count) {
            document.getElementById(elementId).textContent = count;
        }

        function countUnreadComments() {
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            let unread = comments.filter((comment) => 
                comment.studentUsername !== user.username && 
                (!comment.readBy?.includes(user.username)) &&
                !comment.isSubmission
            );

            unread = unread.filter((comment, idx, arr) =>
                arr.findIndex(c =>
                    c.taskId === comment.taskId &&
                    c.comment === comment.comment &&
                    c.timestamp === comment.timestamp &&
                    c.studentUsername === comment.studentUsername
                ) === idx
            );
            
            return unread.length;
        }

        function setupTestScenario() {
            clearLog('setup-result');
            log('setup-result', 'üîß Configurando escenario de prueba...', 'info');
            
            // Limpiar datos previos
            const existingComments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const filteredComments = existingComments.filter(c => !c.id.startsWith('test_solucion_'));
            
            // Configurar usuario
            localStorage.setItem('smart-student-user', JSON.stringify(testUser));
            
            // Configurar tarea
            const testTask = {
                id: testTaskId,
                title: 'Ensayo sobre Energ√≠as Renovables',
                assignedBy: 'profesor_garcia',
                course: '11A',
                subject: 'Ciencias',
                taskType: 'tarea'
            };
            
            const existingTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            existingTasks.push(testTask);
            localStorage.setItem('smart-student-tasks', JSON.stringify(existingTasks));
            
            // Configurar comentarios NO LE√çDOS del profesor
            const testComments = [
                {
                    id: 'test_solucion_comment_1',
                    taskId: testTaskId,
                    studentUsername: 'profesor_garcia',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Excelente investigaci√≥n Felipe, pero necesitas mejorar la introducci√≥n.',
                    timestamp: new Date(Date.now() - 60 * 60 * 1000).toISOString(),
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: [], // NO LE√çDO
                    isNew: true
                },
                {
                    id: 'test_solucion_comment_2',
                    taskId: testTaskId,
                    studentUsername: 'profesor_garcia',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Las fuentes bibliogr√°ficas est√°n muy bien seleccionadas.',
                    timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: [], // NO LE√çDO
                    isNew: true
                },
                {
                    id: 'test_solucion_comment_3',
                    taskId: testTaskId,
                    studentUsername: 'profesor_garcia',
                    studentName: 'Prof. Garc√≠a',
                    comment: 'Recuerda incluir gr√°ficos para apoyar tus argumentos.',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: [], // NO LE√çDO
                    isNew: true
                }
            ];
            
            filteredComments.push(...testComments);
            localStorage.setItem('smart-student-task-comments', JSON.stringify(filteredComments));
            
            log('setup-result', '‚úÖ Escenario configurado correctamente', 'success');
            log('setup-result', `üìù Tarea: "${testTask.title}"`, 'info');
            log('setup-result', `üë§ Usuario: ${testUser.username} (${testUser.role})`, 'info');
            log('setup-result', `üí¨ Comentarios del profesor: ${testComments.length} sin leer`, 'info');
        }

        function verifyOriginalProblem() {
            clearLog('problem-result');
            log('problem-result', 'üîç Verificando problema original...', 'warning');
            
            beforeCount = countUnreadComments();
            updateCounter('count-before', beforeCount);
            
            if (beforeCount > 0) {
                log('problem-result', `üìä PROBLEMA CONFIRMADO: ${beforeCount} comentarios no le√≠dos`, 'error');
                log('problem-result', '‚ö†Ô∏è Este es el estado ANTES de aplicar las mejoras', 'warning');
                log('problem-result', 'üîß Las siguientes acciones deber√≠an reducir este n√∫mero a 0:', 'info');
                log('problem-result', '   ‚Ä¢ Abrir la tarea', 'info');
                log('problem-result', '   ‚Ä¢ Hacer clic en "Ver Comentario"', 'info');
                log('problem-result', '   ‚Ä¢ Usar "Marcar todo como le√≠do"', 'info');
            } else {
                log('problem-result', '‚ö†Ô∏è No hay comentarios no le√≠dos para probar', 'warning');
                log('problem-result', 'Configura primero el escenario de prueba', 'info');
            }
        }

        function testOpenTask() {
            clearLog('open-task-result');
            log('open-task-result', 'üëÅÔ∏è Simulando apertura de tarea...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Simular markCommentsAsReadForTask
            let updated = false;
            const updatedComments = comments.map((comment) => {
                if (
                    comment.taskId === testTaskId && 
                    !comment.isSubmission &&
                    comment.studentUsername !== user.username &&
                    (!comment.readBy?.includes(user.username))
                ) {
                    updated = true;
                    log('open-task-result', `‚úÖ Marcando como le√≠do: "${comment.comment.substring(0, 50)}..."`, 'success');
                    return {
                        ...comment,
                        isNew: false,
                        readBy: [...(comment.readBy || []), user.username]
                    };
                }
                return comment;
            });
            
            if (updated) {
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                
                // Simular eventos
                document.dispatchEvent(new Event('commentsUpdated'));
                window.dispatchEvent(new CustomEvent('studentCommentsUpdated', { 
                    detail: { 
                        username: user.username,
                        taskId: testTaskId,
                        action: 'marked_as_read'
                    } 
                }));
                
                log('open-task-result', 'üíæ Comentarios actualizados en localStorage', 'success');
                log('open-task-result', 'üì° Eventos disparados: commentsUpdated, studentCommentsUpdated', 'success');
                
                const newCount = countUnreadComments();
                log('open-task-result', `üìä Comentarios no le√≠dos despu√©s: ${newCount}`, 'success');
            } else {
                log('open-task-result', '‚ö†Ô∏è No se encontraron comentarios para marcar', 'warning');
            }
        }

        function testViewComment() {
            clearLog('view-comment-result');
            log('view-comment-result', 'üîó Simulando clic en "Ver Comentario"...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Encontrar un comentario no le√≠do para marcar
            const unreadComment = comments.find(c => 
                c.taskId === testTaskId && 
                !c.readBy?.includes(user.username) &&
                c.studentUsername !== user.username
            );
            
            if (unreadComment) {
                // Simular clic en "Ver Comentario" (marcar comentario individual)
                const updatedComments = comments.map((comment) => {
                    if (comment.id === unreadComment.id && !comment.readBy?.includes(user.username)) {
                        log('view-comment-result', `‚úÖ Marcando comentario individual: "${comment.comment.substring(0, 50)}..."`, 'success');
                        return {
                            ...comment,
                            isNew: false,
                            readBy: [...(comment.readBy || []), user.username]
                        };
                    }
                    return comment;
                });
                
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                
                // Simular evento espec√≠fico
                window.dispatchEvent(new CustomEvent('studentCommentsUpdated', { 
                    detail: { 
                        username: user.username,
                        taskId: testTaskId,
                        commentId: unreadComment.id,
                        action: 'single_comment_viewed'
                    } 
                }));
                
                log('view-comment-result', 'üíæ Comentario individual marcado como le√≠do', 'success');
                log('view-comment-result', 'üì° Evento disparado: studentCommentsUpdated', 'success');
                
                const newCount = countUnreadComments();
                log('view-comment-result', `üìä Comentarios no le√≠dos despu√©s: ${newCount}`, 'success');
            } else {
                log('view-comment-result', '‚ö†Ô∏è No hay comentarios no le√≠dos para marcar individualmente', 'warning');
            }
        }

        function testMarkAllRead() {
            clearLog('mark-all-result');
            log('mark-all-result', '‚úÖ Simulando "Marcar todo como le√≠do"...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            let hasUpdates = false;
            let markedCount = 0;
            
            const updatedComments = comments.map(comment => {
                if (!comment.readBy?.includes(user.username) && comment.studentUsername !== user.username) {
                    hasUpdates = true;
                    markedCount++;
                    log('mark-all-result', `‚úÖ Marcando: "${comment.comment.substring(0, 50)}..."`, 'success');
                    return {
                        ...comment,
                        isNew: false,
                        readBy: [...(comment.readBy || []), user.username]
                    };
                }
                return comment;
            });
            
            if (hasUpdates) {
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                
                // Simular eventos del panel de notificaciones
                window.dispatchEvent(new CustomEvent('studentCommentsUpdated', { 
                    detail: { 
                        username: user.username,
                        action: 'mark_all_read'
                    } 
                }));
                
                window.dispatchEvent(new CustomEvent('updateDashboardCounts', {
                    detail: { userRole: user.role, action: 'mark_all_read' }
                }));
                
                document.dispatchEvent(new Event('commentsUpdated'));
                
                log('mark-all-result', `üíæ ${markedCount} comentarios marcados como le√≠dos`, 'success');
                log('mark-all-result', 'üì° Eventos disparados: studentCommentsUpdated, updateDashboardCounts, commentsUpdated', 'success');
                
                const newCount = countUnreadComments();
                log('mark-all-result', `üìä Comentarios no le√≠dos despu√©s: ${newCount}`, 'success');
            } else {
                log('mark-all-result', '‚ö†Ô∏è No hab√≠a comentarios para marcar como le√≠dos', 'warning');
            }
        }

        function verifySolution() {
            clearLog('solution-result');
            log('solution-result', 'üéØ Verificando soluci√≥n final...', 'info');
            
            afterCount = countUnreadComments();
            updateCounter('count-after', afterCount);
            
            log('solution-result', `üìä Comentarios no le√≠dos ANTES: ${beforeCount}`, 'info');
            log('solution-result', `üìä Comentarios no le√≠dos DESPU√âS: ${afterCount}`, 'info');
            
            if (beforeCount > 0 && afterCount === 0) {
                log('solution-result', 'üéâ ¬°PROBLEMA SOLUCIONADO EXITOSAMENTE!', 'success');
                log('solution-result', '‚úÖ Los comentarios se descontaron correctamente de la campana', 'success');
                log('solution-result', '‚úÖ Las mejoras implementadas funcionan correctamente', 'success');
            } else if (beforeCount > 0 && afterCount < beforeCount) {
                log('solution-result', 'üîÑ MEJORA PARCIAL: Se redujeron algunos comentarios', 'warning');
                log('solution-result', `‚ö†Ô∏è Quedan ${afterCount} comentarios sin procesar`, 'warning');
            } else if (beforeCount === 0) {
                log('solution-result', '‚ö†Ô∏è No hab√≠a comentarios iniciales para probar', 'warning');
            } else {
                log('solution-result', '‚ùå El problema persiste', 'error');
                log('solution-result', 'Revisar la implementaci√≥n de las mejoras', 'error');
            }
        }

        function showImprovements() {
            clearLog('improvements-result');
            log('improvements-result', 'üìù MEJORAS IMPLEMENTADAS EN LA SOLUCI√ìN:', 'success');
            log('improvements-result', '', 'info');
            
            log('improvements-result', 'üîß 1. DASHBOARD (src/app/dashboard/page.tsx):', 'info');
            log('improvements-result', '   ‚Ä¢ Listener handleStudentCommentsUpdated con delay para asegurar actualizaci√≥n', 'info');
            log('improvements-result', '   ‚Ä¢ Listener handleTaskDialogClosed para actualizar cuando se cierre di√°logo', 'info');
            log('improvements-result', '   ‚Ä¢ Evento studentCommentsUpdated espec√≠fico para estudiantes', 'info');
            log('improvements-result', '   ‚Ä¢ Logs mejorados para debugging', 'info');
            log('improvements-result', '', 'info');
            
            log('improvements-result', 'üîß 2. PANEL DE NOTIFICACIONES (src/components/common/notifications-panel.tsx):', 'info');
            log('improvements-result', '   ‚Ä¢ Funci√≥n createSafeCommentLink con onClick para marcar comentario individual', 'info');
            log('improvements-result', '   ‚Ä¢ handleReadAll mejorado con evento studentCommentsUpdated', 'info');
            log('improvements-result', '   ‚Ä¢ Eventos m√∫ltiples para sincronizaci√≥n completa', 'info');
            log('improvements-result', '', 'info');
            
            log('improvements-result', 'üîß 3. TASK NOTIFICATION MANAGER (src/lib/notifications.ts):', 'info');
            log('improvements-result', '   ‚Ä¢ markCommentsAsReadForTask con evento studentCommentsUpdated', 'info');
            log('improvements-result', '   ‚Ä¢ Eventos adicionales para mejor sincronizaci√≥n', 'info');
            log('improvements-result', '', 'info');
            
            log('improvements-result', 'üîß 4. P√ÅGINA DE TAREAS (src/app/dashboard/tareas/page.tsx):', 'info');
            log('improvements-result', '   ‚Ä¢ Evento taskDialogClosed cuando se cierra el di√°logo', 'info');
            log('improvements-result', '   ‚Ä¢ Mejor timing para marcar comentarios como le√≠dos', 'info');
            log('improvements-result', '', 'info');
            
            log('improvements-result', 'üéØ RESULTADO:', 'success');
            log('improvements-result', '‚úÖ Los comentarios se descontan correctamente al abrir tareas', 'success');
            log('improvements-result', '‚úÖ Los comentarios se descontan al hacer clic en "Ver Comentario"', 'success');
            log('improvements-result', '‚úÖ Los comentarios se descontan al usar "Marcar todo como le√≠do"', 'success');
            log('improvements-result', '‚úÖ La campana de notificaciones se actualiza en tiempo real', 'success');
        }

        // Limpiar datos de prueba al cargar
        function cleanup() {
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const filteredComments = comments.filter(c => !c.id.startsWith('test_solucion_'));
            localStorage.setItem('smart-student-task-comments', JSON.stringify(filteredComments));
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const filteredTasks = tasks.filter(t => !t.id.startsWith('task_solucion_final_'));
            localStorage.setItem('smart-student-tasks', JSON.stringify(filteredTasks));
        }

        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>
