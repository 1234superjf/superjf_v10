<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Correcci√≥n: Notificaciones Cruzadas entre Profesores</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #1e293b;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f1f5f9;
        }
        .problem {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        .solution {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }
        .warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
        .info {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
        }
        .btn {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-danger {
            background: #ef4444;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-success {
            background: #22c55e;
        }
        .btn-success:hover {
            background: #16a34a;
        }
        .results {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
        }
        .step.success {
            background: #dcfce7;
            border-left: 3px solid #22c55e;
        }
        .step.error {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
        }
        .step.warning {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
        .stat-label {
            color: #64748b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Correcci√≥n: Notificaciones Cruzadas entre Profesores</h1>
            <p>Herramienta para diagnosticar y solucionar el problema donde los comentarios de un profesor aparecen como notificaciones para otros profesores</p>
        </div>

        <div class="section problem">
            <h2>üö® Problema Identificado</h2>
            <p><strong>Descripci√≥n:</strong> Los comentarios que realiza un profesor est√°n llegando a otros profesores cuando deber√≠an llegar solamente a los estudiantes que tiene asignados.</p>
            <p><strong>Causa:</strong> Notificaciones mal dirigidas o datos corruptos en localStorage que incluyen a profesores como destinatarios de comentarios de otros profesores.</p>
        </div>

        <div class="section info">
            <h2>üìä Diagn√≥stico del Sistema</h2>
            <div id="diagnosis-results" class="results">Ejecuta el diagn√≥stico para ver el estado actual...</div>
            <button class="btn" onclick="runDiagnosis()">üîç Ejecutar Diagn√≥stico</button>
        </div>

        <div class="section">
            <h2>üìà Estad√≠sticas Actuales</h2>
            <div class="stats" id="current-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-notifications">-</div>
                    <div class="stat-label">Total Notificaciones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="teacher-comment-notifications">-</div>
                    <div class="stat-label">Notificaciones de Comentarios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="cross-contaminated-notifications">-</div>
                    <div class="stat-label">Notificaciones Cruzadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="affected-teachers">-</div>
                    <div class="stat-label">Profesores Afectados</div>
                </div>
            </div>
        </div>

        <div class="section solution">
            <h2>‚úÖ Soluciones Disponibles</h2>
            
            <div class="step">
                <h3>üîß Soluci√≥n 1: Limpieza Autom√°tica (Recomendada)</h3>
                <p>Ejecuta la funci√≥n de limpieza del sistema que elimina notificaciones mal dirigidas:</p>
                <button class="btn btn-success" onclick="runAutomaticCleanup()">üöë Limpieza Autom√°tica</button>
            </div>

            <div class="step">
                <h3>üîß Soluci√≥n 2: Limpieza Manual Espec√≠fica</h3>
                <p>Limpia manualmente solo las notificaciones de comentarios cruzados entre profesores:</p>
                <button class="btn" onclick="runManualCleanup()">üõ†Ô∏è Limpieza Manual</button>
            </div>

            <div class="step">
                <h3>üîß Soluci√≥n 3: Limpieza Completa de Notificaciones</h3>
                <p><strong>‚ö†Ô∏è CUIDADO:</strong> Esto eliminar√° TODAS las notificaciones del sistema. Solo usar en casos extremos:</p>
                <button class="btn btn-danger" onclick="runCompleteCleanup()">üóëÔ∏è Limpieza Completa</button>
            </div>
        </div>

        <div class="section warning">
            <h2>‚ö†Ô∏è Prevenci√≥n de Futuros Problemas</h2>
            <div id="prevention-results" class="results">Ejecuta la verificaci√≥n de prevenci√≥n...</div>
            <button class="btn" onclick="runPreventionCheck()">üõ°Ô∏è Verificar Prevenci√≥n</button>
        </div>

        <div class="section">
            <h2>üìã Registro de Acciones</h2>
            <div id="action-log" class="results">Acciones realizadas aparecer√°n aqu√≠...</div>
            <button class="btn" onclick="clearLog()">üßπ Limpiar Log</button>
        </div>
    </div>

    <script>
        let actionLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            actionLog.push(logEntry);
            
            const logElement = document.getElementById('action-log');
            logElement.textContent = actionLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            actionLog = [];
            document.getElementById('action-log').textContent = 'Log limpiado...';
        }

        function updateStats() {
            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                const teacherCommentNotifications = notifications.filter(n => n.type === 'teacher_comment');
                
                // Detectar notificaciones cruzadas (donde un profesor est√° en targetUsernames de comentario de otro profesor)
                const crossContaminated = teacherCommentNotifications.filter(notification => {
                    return notification.targetUsernames.some(targetUsername => {
                        // Verificar si el targetUsername es un profesor
                        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                        const targetUser = users.find(u => u.username === targetUsername);
                        return targetUser && targetUser.role === 'teacher' && targetUser.username !== notification.fromUsername;
                    });
                });

                // Contar profesores √∫nicos afectados
                const affectedTeachers = new Set();
                crossContaminated.forEach(notification => {
                    notification.targetUsernames.forEach(targetUsername => {
                        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                        const targetUser = users.find(u => u.username === targetUsername);
                        if (targetUser && targetUser.role === 'teacher' && targetUser.username !== notification.fromUsername) {
                            affectedTeachers.add(targetUsername);
                        }
                    });
                });

                document.getElementById('total-notifications').textContent = notifications.length;
                document.getElementById('teacher-comment-notifications').textContent = teacherCommentNotifications.length;
                document.getElementById('cross-contaminated-notifications').textContent = crossContaminated.length;
                document.getElementById('affected-teachers').textContent = affectedTeachers.size;

            } catch (error) {
                log(`‚ùå Error actualizando estad√≠sticas: ${error.message}`, 'error');
            }
        }

        function runDiagnosis() {
            log('üîç Iniciando diagn√≥stico del sistema...');
            
            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                
                log(`üìä Total de notificaciones en sistema: ${notifications.length}`);
                log(`üë• Total de usuarios en sistema: ${users.length}`);
                
                // Filtrar solo notificaciones de comentarios de profesores
                const teacherCommentNotifications = notifications.filter(n => n.type === 'teacher_comment');
                log(`üí¨ Notificaciones de comentarios de profesores: ${teacherCommentNotifications.length}`);
                
                // Analizar cada notificaci√≥n de comentario
                let problemsFound = 0;
                const problemDetails = [];
                
                teacherCommentNotifications.forEach((notification, index) => {
                    const fromUser = users.find(u => u.username === notification.fromUsername);
                    
                    if (!fromUser || fromUser.role !== 'teacher') {
                        problemDetails.push(`‚ùå Notificaci√≥n ${index + 1}: Emisor no es profesor v√°lido (${notification.fromUsername})`);
                        problemsFound++;
                        return;
                    }
                    
                    // Verificar cada destinatario
                    notification.targetUsernames.forEach(targetUsername => {
                        const targetUser = users.find(u => u.username === targetUsername);
                        
                        if (!targetUser) {
                            problemDetails.push(`‚ö†Ô∏è Notificaci√≥n ${index + 1}: Destinatario no existe (${targetUsername})`);
                            problemsFound++;
                        } else if (targetUser.role === 'teacher' && targetUser.username !== notification.fromUsername) {
                            problemDetails.push(`üö® PROBLEMA: Notificaci√≥n ${index + 1}: Profesor "${notification.fromUsername}" ‚Üí Profesor "${targetUsername}" (INCORRECTO)`);
                            problemsFound++;
                        } else if (targetUser.username === notification.fromUsername) {
                            problemDetails.push(`üö® PROBLEMA: Notificaci√≥n ${index + 1}: Profesor "${notification.fromUsername}" se env√≠a notificaci√≥n a s√≠ mismo (INCORRECTO)`);
                            problemsFound++;
                        } else if (targetUser.role === 'student') {
                            // Esto est√° correcto, no reportar
                        }
                    });
                });
                
                log(`\nüìã RESUMEN DEL DIAGN√ìSTICO:`);
                log(`‚úÖ Notificaciones analizadas: ${teacherCommentNotifications.length}`);
                log(`‚ùå Problemas encontrados: ${problemsFound}`);
                
                if (problemsFound > 0) {
                    log(`\nüîç DETALLES DE LOS PROBLEMAS:`);
                    problemDetails.forEach(detail => log(detail));
                    log(`\nüí° RECOMENDACI√ìN: Ejecutar limpieza autom√°tica para corregir estos problemas.`);
                } else {
                    log(`\nüéâ ¬°EXCELENTE! No se encontraron problemas de notificaciones cruzadas.`);
                }
                
                updateStats();
                
            } catch (error) {
                log(`‚ùå Error durante el diagn√≥stico: ${error.message}`, 'error');
            }
        }

        function runAutomaticCleanup() {
            log('üöë Iniciando limpieza autom√°tica del sistema...');
            
            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                let cleanedCount = 0;
                
                const cleanedNotifications = notifications.filter(notification => {
                    // Si no es una notificaci√≥n de comentario de profesor, mantenerla
                    if (notification.type !== 'teacher_comment') {
                        return true;
                    }
                    
                    // Verificar si tiene problemas de destinatarios
                    const hasProblems = notification.targetUsernames.some(targetUsername => {
                        const targetUser = users.find(u => u.username === targetUsername);
                        
                        // Eliminar si el destinatario es un profesor (que no sea el emisor) o si es el mismo emisor
                        if (targetUser && targetUser.role === 'teacher') {
                            cleanedCount++;
                            log(`üóëÔ∏è Eliminando notificaci√≥n problem√°tica: De "${notification.fromUsername}" hacia profesor "${targetUsername}"`);
                            return true;
                        }
                        
                        return false;
                    });
                    
                    return !hasProblems;
                });
                
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(cleanedNotifications));
                
                log(`‚úÖ Limpieza autom√°tica completada:`);
                log(`   - Notificaciones originales: ${notifications.length}`);
                log(`   - Notificaciones problem√°ticas eliminadas: ${cleanedCount}`);
                log(`   - Notificaciones restantes: ${cleanedNotifications.length}`);
                
                // Disparar eventos para actualizar la UI
                window.dispatchEvent(new CustomEvent('taskNotificationsUpdated'));
                
                updateStats();
                
                log(`\nüîÑ Eventos de actualizaci√≥n disparados. La UI deber√≠a actualizarse autom√°ticamente.`);
                
            } catch (error) {
                log(`‚ùå Error durante la limpieza autom√°tica: ${error.message}`, 'error');
            }
        }

        function runManualCleanup() {
            log('üõ†Ô∏è Iniciando limpieza manual espec√≠fica...');
            
            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                let removedCount = 0;
                
                const filteredNotifications = notifications.filter(notification => {
                    // Solo procesar notificaciones de comentarios de profesores
                    if (notification.type === 'teacher_comment') {
                        // Verificar si el profesor est√° en targetUsernames (comentario propio)
                        if (notification.targetUsernames.includes(notification.fromUsername)) {
                            log(`üóëÔ∏è Eliminando comentario propio: Profesor "${notification.fromUsername}" ‚Üí tarea "${notification.taskTitle}"`);
                            removedCount++;
                            return false;
                        }
                        
                        // Verificar si hay otros profesores en targetUsernames
                        const hasOtherTeachers = notification.targetUsernames.some(targetUsername => {
                            const targetUser = users.find(u => u.username === targetUsername);
                            return targetUser && targetUser.role === 'teacher' && targetUser.username !== notification.fromUsername;
                        });
                        
                        if (hasOtherTeachers) {
                            log(`üóëÔ∏è Eliminando notificaci√≥n cruzada: Profesor "${notification.fromUsername}" ‚Üí otros profesores`);
                            removedCount++;
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(filteredNotifications));
                
                log(`‚úÖ Limpieza manual completada:`);
                log(`   - Notificaciones eliminadas: ${removedCount}`);
                log(`   - Notificaciones restantes: ${filteredNotifications.length}`);
                
                // Disparar eventos para actualizar la UI
                window.dispatchEvent(new CustomEvent('taskNotificationsUpdated'));
                
                updateStats();
                
            } catch (error) {
                log(`‚ùå Error durante la limpieza manual: ${error.message}`, 'error');
            }
        }

        function runCompleteCleanup() {
            const confirmed = confirm('‚ö†Ô∏è ADVERTENCIA: Esto eliminar√° TODAS las notificaciones del sistema.\n\n¬øEst√°s completamente seguro?\n\nEsta acci√≥n NO se puede deshacer.');
            
            if (!confirmed) {
                log('‚ùå Limpieza completa cancelada por el usuario.');
                return;
            }
            
            const doubleConfirm = prompt('Para confirmar, escribe "ELIMINAR TODO" (en may√∫sculas):');
            
            if (doubleConfirm !== 'ELIMINAR TODO') {
                log('‚ùå Limpieza completa cancelada - confirmaci√≥n incorrecta.');
                return;
            }
            
            log('üóëÔ∏è Iniciando limpieza completa del sistema...');
            
            try {
                const originalCount = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]').length;
                
                localStorage.setItem('smart-student-task-notifications', '[]');
                
                log(`‚úÖ Limpieza completa ejecutada:`);
                log(`   - Notificaciones eliminadas: ${originalCount}`);
                log(`   - Sistema reiniciado con notificaciones limpias`);
                
                // Disparar eventos para actualizar la UI
                window.dispatchEvent(new CustomEvent('taskNotificationsUpdated'));
                window.dispatchEvent(new CustomEvent('notificationSyncCompleted'));
                
                updateStats();
                
                log(`\n‚ö†Ô∏è RECOMENDACI√ìN: Recarga la p√°gina del dashboard para asegurar que la UI se actualice completamente.`);
                
            } catch (error) {
                log(`‚ùå Error durante la limpieza completa: ${error.message}`, 'error');
            }
        }

        function runPreventionCheck() {
            log('üõ°Ô∏è Verificando medidas de prevenci√≥n...');
            
            try {
                // Verificar que la funci√≥n de limpieza autom√°tica est√© disponible
                if (typeof window.TaskNotificationManager !== 'undefined') {
                    log('‚úÖ TaskNotificationManager est√° disponible');
                    
                    if (typeof window.TaskNotificationManager.removeTeacherOwnCommentNotifications === 'function') {
                        log('‚úÖ Funci√≥n de limpieza autom√°tica disponible: removeTeacherOwnCommentNotifications');
                    } else {
                        log('‚ùå Funci√≥n de limpieza autom√°tica NO disponible');
                    }
                    
                    if (typeof window.TaskNotificationManager.createTeacherCommentNotifications === 'function') {
                        log('‚úÖ Funci√≥n de creaci√≥n de notificaciones disponible');
                    } else {
                        log('‚ùå Funci√≥n de creaci√≥n de notificaciones NO disponible');
                    }
                } else {
                    log('‚ùå TaskNotificationManager NO est√° disponible en el contexto actual');
                    log('‚ÑπÔ∏è Esto es normal si est√°s ejecutando desde esta p√°gina de diagn√≥stico');
                }
                
                // Verificar estructura de datos
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                
                log(`üìä Estructura de datos:`);
                log(`   - Usuarios en sistema: ${users.length}`);
                log(`   - Profesores: ${users.filter(u => u.role === 'teacher').length}`);
                log(`   - Estudiantes: ${users.filter(u => u.role === 'student').length}`);
                log(`   - Notificaciones totales: ${notifications.length}`);
                
                // Verificar integridad de notificaciones recientes
                const recentNotifications = notifications.filter(n => {
                    const notifDate = new Date(n.timestamp);
                    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                    return notifDate > oneDayAgo;
                });
                
                log(`üìÖ Notificaciones recientes (√∫ltimas 24h): ${recentNotifications.length}`);
                
                const recentTeacherComments = recentNotifications.filter(n => n.type === 'teacher_comment');
                log(`üí¨ Comentarios de profesores recientes: ${recentTeacherComments.length}`);
                
                // Verificar si hay problemas en notificaciones recientes
                let recentProblems = 0;
                recentTeacherComments.forEach(notification => {
                    if (notification.targetUsernames.includes(notification.fromUsername)) {
                        recentProblems++;
                    }
                    notification.targetUsernames.forEach(targetUsername => {
                        const targetUser = users.find(u => u.username === targetUsername);
                        if (targetUser && targetUser.role === 'teacher' && targetUser.username !== notification.fromUsername) {
                            recentProblems++;
                        }
                    });
                });
                
                if (recentProblems === 0) {
                    log('‚úÖ No se detectaron problemas en notificaciones recientes');
                    log('‚úÖ El sistema de prevenci√≥n parece estar funcionando correctamente');
                } else {
                    log(`‚ùå Se detectaron ${recentProblems} problemas en notificaciones recientes`);
                    log('‚ö†Ô∏è El sistema de prevenci√≥n podr√≠a necesitar atenci√≥n');
                }
                
            } catch (error) {
                log(`‚ùå Error durante la verificaci√≥n de prevenci√≥n: ${error.message}`, 'error');
            }
        }

        // Inicializar estad√≠sticas al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            log('üîß Herramienta de correcci√≥n de notificaciones cruzadas inicializada');
            log('üëÜ Usa los botones de arriba para diagnosticar y corregir problemas');
        });
    </script>
</body>
</html>
