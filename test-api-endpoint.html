<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test API Endpoint</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border-radius: 10px;
            color: white;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .critical {
            background: linear-gradient(135deg, #FF1744, #D32F2F);
            color: white;
        }
        .test-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .api-button {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        .results-box {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error-box {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #d32f2f;
        }
        .payload-box {
            background: #f3e5f5;
            border: 2px solid #9c27b0;
            color: #4a148c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß API Endpoint Diagnostic Tool</h1>
            <p>Herramienta para diagnosticar por qu√© el endpoint devuelve espa√±ol cuando se env√≠a language="en"</p>
        </div>

        <div class="test-section critical">
            <h3>üö® PROBLEMA DETECTADO</h3>
            <p><strong>S√≠ntoma:</strong> El frontend env√≠a <code>language: "en"</code> al API, pero el API devuelve contenido en espa√±ol.</p>
            <p><strong>Evidencia:</strong> En los logs se ve "CRITICAL REPEAT API CALL WITH LANGUAGE: en" pero la evaluaci√≥n aparece en espa√±ol.</p>
            <p><strong>Hip√≥tesis:</strong> El problema est√° en el endpoint <code>/api/generate-dynamic-evaluation</code></p>
        </div>

        <div class="test-section">
            <h3>üì§ Payload de Prueba</h3>
            <p>Este es el payload exacto que se env√≠a al endpoint:</p>
            <div class="results-box payload-box" id="payloadDisplay">
{
  "bookTitle": "Anatom√≠a",
  "topic": "SISTEMA RESPIRATORIO",
  "language": "en",
  "pdfContent": "",
  "questionCount": 15,
  "timeLimit": 120
}
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Pruebas del Endpoint</h3>
            
            <button class="test-button api-button" onclick="testEnglishRequest()">
                üá∫üá∏ Test con language="en"
            </button>
            
            <button class="test-button api-button" onclick="testSpanishRequest()">
                üá™üá∏ Test con language="es"
            </button>
            
            <button class="test-button api-button" onclick="runComparisonTest()">
                üî¨ Test Comparativo Completo
            </button>
            
            <div class="results-box" id="testResults">
                Los resultados de las pruebas aparecer√°n aqu√≠...
            </div>
        </div>

        <div class="test-section">
            <h3>üîç An√°lisis de Respuesta</h3>
            <div class="results-box" id="analysisResults">
                El an√°lisis detallado aparecer√° despu√©s de ejecutar una prueba...
            </div>
        </div>

        <div class="test-section">
            <h3>üìã Diagn√≥stico y Soluci√≥n</h3>
            <div class="results-box" id="diagnosisResults">
                El diagn√≥stico final aparecer√° aqu√≠...
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar resultados en la interfaz
        function displayResults(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = isError ? 'results-box error-box' : 'results-box';
        }

        // Funci√≥n para analizar si una pregunta est√° en espa√±ol o ingl√©s
        function analyzeLanguage(questionText) {
            const spanishKeywords = ['cu√°l', 'cu√°les', 'qu√©', 'por qu√©', 'c√≥mo', 'd√≥nde', 'cu√°ndo', 'funci√≥n', 'principal', 'siguiente', 'correcta', 'respuesta'];
            const englishKeywords = ['what', 'which', 'how', 'where', 'when', 'why', 'function', 'main', 'following', 'correct', 'answer'];
            
            const lowerQuestion = questionText.toLowerCase();
            const hasSpanishWords = spanishKeywords.some(word => lowerQuestion.includes(word));
            const hasEnglishWords = englishKeywords.some(word => lowerQuestion.includes(word));
            
            if (hasSpanishWords && !hasEnglishWords) return 'SPANISH';
            if (hasEnglishWords && !hasSpanishWords) return 'ENGLISH';
            return 'UNKNOWN';
        }

        // Funci√≥n para probar el endpoint con ingl√©s
        async function testEnglishRequest() {
            displayResults('testResults', 'üöÄ Enviando request con language="en"...');
            
            try {
                const payload = {
                    bookTitle: "Anatom√≠a",
                    topic: "SISTEMA RESPIRATORIO",
                    language: "en",
                    pdfContent: "",
                    questionCount: 15,
                    timeLimit: 120
                };

                console.log('üì§ Sending payload:', payload);

                const response = await fetch('/api/generate-dynamic-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                const firstQuestion = data.data?.questions?.[0];
                if (firstQuestion) {
                    const detectedLang = analyzeLanguage(firstQuestion.question);
                    
                    const result = `‚úÖ RESPONSE RECEIVED:

üìä Response Info:
- Status: ${response.status}
- Questions Count: ${data.data?.questions?.length}
- Evaluation Title: ${data.data?.evaluationTitle}

üìù First Question:
"${firstQuestion.question}"

üîç Language Analysis:
- Requested Language: EN
- Detected Language: ${detectedLang}
- Match: ${detectedLang === 'ENGLISH' ? '‚úÖ YES' : '‚ùå NO'}

${detectedLang === 'SPANISH' ? '‚ùå PROBLEM CONFIRMED: API returned SPANISH content despite language="en"' : 
  detectedLang === 'ENGLISH' ? '‚úÖ WORKING CORRECTLY: API returned ENGLISH content as expected' : 
  '‚ö†Ô∏è UNCLEAR: Cannot determine language clearly'}`;
                    
                    displayResults('testResults', result, detectedLang === 'SPANISH');
                    
                    // Store for comparison
                    window.englishResult = { question: firstQuestion.question, language: detectedLang };
                    
                } else {
                    displayResults('testResults', '‚ùå ERROR: No questions in response', true);
                }

            } catch (error) {
                console.error('Error:', error);
                displayResults('testResults', `‚ùå ERROR: ${error.message}`, true);
            }
        }

        // Funci√≥n para probar el endpoint con espa√±ol
        async function testSpanishRequest() {
            displayResults('testResults', 'üöÄ Enviando request con language="es"...');
            
            try {
                const payload = {
                    bookTitle: "Anatom√≠a",
                    topic: "SISTEMA RESPIRATORIO",
                    language: "es",
                    pdfContent: "",
                    questionCount: 15,
                    timeLimit: 120
                };

                const response = await fetch('/api/generate-dynamic-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                const firstQuestion = data.data?.questions?.[0];
                if (firstQuestion) {
                    const detectedLang = analyzeLanguage(firstQuestion.question);
                    
                    const result = `‚úÖ RESPONSE RECEIVED:

üìä Response Info:
- Status: ${response.status}
- Questions Count: ${data.data?.questions?.length}
- Evaluation Title: ${data.data?.evaluationTitle}

üìù First Question:
"${firstQuestion.question}"

üîç Language Analysis:
- Requested Language: ES
- Detected Language: ${detectedLang}
- Match: ${detectedLang === 'SPANISH' ? '‚úÖ YES' : '‚ùå NO'}`;
                    
                    displayResults('testResults', result, detectedLang !== 'SPANISH');
                    
                    // Store for comparison
                    window.spanishResult = { question: firstQuestion.question, language: detectedLang };
                    
                } else {
                    displayResults('testResults', '‚ùå ERROR: No questions in response', true);
                }

            } catch (error) {
                console.error('Error:', error);
                displayResults('testResults', `‚ùå ERROR: ${error.message}`, true);
            }
        }

        // Funci√≥n para ejecutar prueba comparativa
        async function runComparisonTest() {
            displayResults('testResults', 'üî¨ Ejecutando prueba comparativa completa...');
            displayResults('analysisResults', 'Analizando...');
            displayResults('diagnosisResults', 'Diagnosticando...');
            
            // Test ingl√©s
            await testEnglishRequest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test espa√±ol
            await testSpanishRequest();
            
            // An√°lisis comparativo
            setTimeout(() => {
                if (window.englishResult && window.spanishResult) {
                    const analysis = `üî¨ COMPARATIVE ANALYSIS:

üá∫üá∏ English Request Result:
- Question: "${window.englishResult.question.substring(0, 100)}..."
- Detected Language: ${window.englishResult.language}

üá™üá∏ Spanish Request Result:
- Question: "${window.spanishResult.question.substring(0, 100)}..."
- Detected Language: ${window.spanishResult.language}

üìä Comparison:
- Questions are identical: ${window.englishResult.question === window.spanishResult.question ? 'YES' : 'NO'}
- Both detected as Spanish: ${window.englishResult.language === 'SPANISH' && window.spanishResult.language === 'SPANISH' ? 'YES' : 'NO'}

${window.englishResult.question === window.spanishResult.question ? 
  '‚ùå CRITICAL ISSUE: Same content returned for both languages!' : 
  '‚úÖ Different content returned (expected)'}`;
                    
                    displayResults('analysisResults', analysis);
                    
                    // Diagn√≥stico final
                    let diagnosis;
                    if (window.englishResult.language === 'SPANISH' && window.spanishResult.language === 'SPANISH') {
                        if (window.englishResult.question === window.spanishResult.question) {
                            diagnosis = `üö® CRITICAL BUG CONFIRMED:

The API endpoint is IGNORING the language parameter completely.
Both requests (language="en" and language="es") return identical Spanish content.

üîß RECOMMENDED FIXES:
1. Check the API implementation in /api/generate-dynamic-evaluation
2. Verify that the language parameter is being read correctly
3. Ensure the AI prompt includes the language instruction
4. Add logging in the API to see what language is being received

This is a SERVER-SIDE issue, not a frontend issue.`;
                        } else {
                            diagnosis = `‚ö†Ô∏è PARTIAL BUG:

The API returns Spanish content for both languages but at least generates different questions.
This suggests the language parameter is being ignored in the AI prompt.

üîß RECOMMENDED FIXES:
1. Check the AI prompt template to include language instruction
2. Verify the language parameter is passed to the AI model correctly`;
                        }
                    } else {
                        diagnosis = `‚úÖ API WORKING CORRECTLY:

The endpoint respects the language parameter and returns appropriate content.
The issue might be in the frontend detection or a different part of the system.`;
                    }
                    
                    displayResults('diagnosisResults', diagnosis, window.englishResult.language === 'SPANISH');
                }
            }, 2000);
        }
    </script>
</body>
</html>
