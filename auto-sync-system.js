/**
 * üîÑ SISTEMA AUTOM√ÅTICO DE SINCRONIZACI√ìN
 * 
 * Este script detecta cambios en Gesti√≥n de Usuarios y actualiza
 * autom√°ticamente los Datos Acad√©micos en tiempo real.
 */

console.log('üîÑ ACTIVANDO SINCRONIZACI√ìN AUTOM√ÅTICA...');
console.log('==========================================');

// 1. Funci√≥n para leer el estado actual antes de los cambios
function capturarEstadoActual() {
    try {
        console.log('üìä ESTADO ACTUAL DE TODOS LOS ESTUDIANTES:');
        console.log('==========================================');
        
        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        const studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');

        const estudiantes = users.filter(u => u.role === 'student');
        
        console.log(`üìã Encontrados: ${estudiantes.length} estudiantes`);
        
        estudiantes.forEach((estudiante, index) => {
            const asignacion = studentAssignments.find(a => a.studentId === estudiante.id);
            const perfilCurso = estudiante.activeCourses?.[0] || 'Sin curso asignado';
            
            console.log(`\n${index + 1}. ${estudiante.username.toUpperCase()}:`);
            console.log(`   üë§ Perfil muestra: ${perfilCurso}`);
            
            if (asignacion) {
                const curso = courses.find(c => c.id === asignacion.courseId);
                const seccion = sections.find(s => s.id === asignacion.sectionId);
                
                if (curso && seccion) {
                    const gestionCurso = `${curso.name} - Secci√≥n ${seccion.name}`;
                    console.log(`   üìã Gesti√≥n dice: ${gestionCurso}`);
                    
                    if (perfilCurso === gestionCurso) {
                        console.log(`   ‚úÖ SINCRONIZADO`);
                    } else {
                        console.log(`   ‚ùå DESINCRONIZADO - Necesita actualizaci√≥n`);
                    }
                } else {
                    console.log(`   ‚ö†Ô∏è Datos incompletos en gesti√≥n`);
                }
            } else {
                console.log(`   ‚ùå Sin asignaci√≥n en gesti√≥n de usuarios`);
            }
        });

        return { users, courses, sections, studentAssignments, estudiantes };

    } catch (error) {
        console.error('‚ùå Error capturando estado:', error);
        return null;
    }
}

// 2. Funci√≥n para detectar y aplicar cambios desde gesti√≥n
function sincronizarDesdeGestion() {
    try {
        console.log('\nüîÑ EJECUTANDO SINCRONIZACI√ìN...');
        console.log('================================');
        
        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        const studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');

        let cambiosRealizados = 0;
        const estudiantes = users.filter(u => u.role === 'student');
        
        estudiantes.forEach(estudiante => {
            console.log(`\nüîç Procesando: ${estudiante.username}`);
            
            // Buscar asignaci√≥n en gesti√≥n de usuarios
            const asignacion = studentAssignments.find(a => a.studentId === estudiante.id);
            
            if (asignacion) {
                const curso = courses.find(c => c.id === asignacion.courseId);
                const seccion = sections.find(s => s.id === asignacion.sectionId);
                
                if (curso && seccion) {
                    const cursoGestion = `${curso.name} - Secci√≥n ${seccion.name}`;
                    const cursoPerfil = estudiante.activeCourses?.[0] || 'Sin curso';
                    
                    console.log(`   üìã Gesti√≥n: ${cursoGestion}`);
                    console.log(`   üë§ Perfil: ${cursoPerfil}`);
                    
                    if (cursoPerfil !== cursoGestion) {
                        // ACTUALIZAR PERFIL
                        estudiante.activeCourses = [cursoGestion];
                        cambiosRealizados++;
                        console.log(`   ‚úÖ ACTUALIZADO: "${cursoPerfil}" ‚Üí "${cursoGestion}"`);
                    } else {
                        console.log(`   ‚úÖ Ya sincronizado`);
                    }
                } else {
                    console.log(`   ‚ö†Ô∏è Curso o secci√≥n no encontrados`);
                }
            } else {
                console.log(`   ‚ùå Sin asignaci√≥n en gesti√≥n`);
            }
        });

        // Guardar cambios si los hay
        if (cambiosRealizados > 0) {
            localStorage.setItem('smart-student-users', JSON.stringify(users));
            
            console.log(`\nüéâ SINCRONIZACI√ìN COMPLETADA:`);
            console.log(`=============================`);
            console.log(`‚úÖ Estudiantes actualizados: ${cambiosRealizados}`);
            
            // Disparar evento de actualizaci√≥n
            const evento = new CustomEvent('profileDataUpdate', {
                detail: { 
                    type: 'sync-from-management',
                    updatedCount: cambiosRealizados,
                    timestamp: new Date().toISOString()
                }
            });
            window.dispatchEvent(evento);
            
            console.log('üì° Evento de actualizaci√≥n disparado');
            
            // Forzar recarga del componente actual
            if (window.location.pathname.includes('/perfil')) {
                console.log('üîÑ Recargando perfil para mostrar cambios...');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
            
        } else {
            console.log('\n‚úÖ Todos los perfiles ya est√°n sincronizados');
        }

        return cambiosRealizados;

    } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n:', error);
        return 0;
    }
}

// 3. Funci√≥n espec√≠fica para verificar Gustavo despu√©s del cambio
function verificarGustavoDespuesCambio() {
    try {
        console.log('\nüéØ VERIFICACI√ìN ESPEC√çFICA DE GUSTAVO:');
        console.log('=====================================');
        
        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        const studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');

        const gustavo = users.find(u => u.username === 'gustavo');
        const asignacion = studentAssignments.find(a => a.studentId === gustavo?.id);
        
        if (gustavo && asignacion) {
            const curso = courses.find(c => c.id === asignacion.courseId);
            const seccion = sections.find(s => s.id === asignacion.sectionId);
            
            console.log(`üë§ GUSTAVO:`);
            console.log(`   üìã Gesti√≥n dice: ${curso?.name} - Secci√≥n ${seccion?.name}`);
            console.log(`   üë§ Perfil muestra: ${gustavo.activeCourses?.[0] || 'Sin curso'}`);
            
            const cursoEsperado = `${curso?.name} - Secci√≥n ${seccion?.name}`;
            const cursoActual = gustavo.activeCourses?.[0];
            
            if (cursoActual === cursoEsperado) {
                console.log(`   ‚úÖ PERFECTO - Datos sincronizados correctamente`);
            } else {
                console.log(`   ‚ùå PROBLEMA - Los datos no coinciden`);
                console.log(`   üí° Ejecuta: sincronizarDesdeGestion() para corregir`);
            }
        } else {
            console.log(`‚ùå Gustavo o su asignaci√≥n no encontrados`);
        }

    } catch (error) {
        console.error('‚ùå Error verificando Gustavo:', error);
    }
}

// 4. Sistema de monitoreo autom√°tico
function activarMonitoreoAutomatico() {
    try {
        console.log('\nüîß ACTIVANDO MONITOREO AUTOM√ÅTICO...');
        console.log('====================================');
        
        // Interceptar cambios en localStorage para detectar modificaciones
        if (!window.autoSyncActive) {
            const originalSetItem = localStorage.setItem;
            
            localStorage.setItem = function(key, value) {
                const resultado = originalSetItem.call(this, key, value);
                
                // Si cambian las asignaciones de estudiantes, sincronizar autom√°ticamente
                if (key === 'smart-student-student-assignments') {
                    console.log('üîî Detectado cambio en asignaciones - Auto-sincronizando...');
                    setTimeout(() => {
                        sincronizarDesdeGestion();
                    }, 200);
                }
                
                return resultado;
            };
            
            window.autoSyncActive = true;
            console.log('‚úÖ Monitoreo autom√°tico activado');
            console.log('üîî Los cambios en Gesti√≥n de Usuarios se sincronizar√°n autom√°ticamente');
        } else {
            console.log('‚úÖ Monitoreo autom√°tico ya estaba activo');
        }

    } catch (error) {
        console.error('‚ùå Error activando monitoreo:', error);
    }
}

// ===============================
// üöÄ EJECUTAR SECUENCIA COMPLETA
// ===============================

console.log('üöÄ INICIANDO SISTEMA COMPLETO...');

// 1. Mostrar estado actual
const estadoActual = capturarEstadoActual();

// 2. Ejecutar sincronizaci√≥n
const cambios = sincronizarDesdeGestion();

// 3. Verificar Gustavo espec√≠ficamente
verificarGustavoDespuesCambio();

// 4. Activar monitoreo autom√°tico
activarMonitoreoAutomatico();

console.log('\nüí° FUNCIONES DISPONIBLES:');
console.log('=========================');
console.log('- sincronizarDesdeGestion() - Forzar sincronizaci√≥n manual');
console.log('- verificarGustavoDespuesCambio() - Verificar espec√≠ficamente a Gustavo');
console.log('- capturarEstadoActual() - Ver estado de todos los estudiantes');

console.log('\nüéØ RESULTADO:');
console.log('=============');
if (cambios > 0) {
    console.log(`‚úÖ ${cambios} perfil(es) actualizado(s) exitosamente`);
    console.log('üîÑ Los cambios se est√°n aplicando autom√°ticamente');
} else {
    console.log('‚úÖ Todos los perfiles ya estaban actualizados');
}
console.log('üîî Sistema autom√°tico activado para futuros cambios en Gesti√≥n de Usuarios');

console.log('\nüö® IMPORTANTE:');
console.log('==============');
console.log('Ahora cuando hagas cambios en Gesti√≥n de Usuarios,');
console.log('los perfiles se actualizar√°n AUTOM√ÅTICAMENTE sin necesidad de scripts.');
