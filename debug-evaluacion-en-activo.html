<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug: Evaluaci√≥n EN Activo - Profesor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .problem-box {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-box {
            background: #efe;
            border: 2px solid #cfc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .toggle-simulation {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            margin: 10px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toggle-switch {
            width: 40px;
            height: 20px;
            background: #ccc;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #4CAF50;
        }
        .toggle-switch::after {
            content: '';
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
    </style>
</head>
<body>
    <!-- Simulaci√≥n del toggle EN -->
    <div class="toggle-simulation">
        <span>EN</span>
        <div class="toggle-switch" id="enToggle" data-state="unchecked" onclick="toggleLanguage()"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üîß Debug: Problema Evaluaci√≥n EN Activo</h1>
            <p><strong>Modo Profesor - Pesta√±a Evaluaci√≥n</strong></p>
        </div>

        <div class="problem-box">
            <h2>üö® Problema Reportado</h2>
            <ul>
                <li><strong>Contexto:</strong> Modo profesor, pesta√±a evaluaci√≥n</li>
                <li><strong>Estado:</strong> EN activo (toggle activado)</li>
                <li><strong>Problema:</strong> No se generan evaluaciones al hacer clic en "Crear Evaluaci√≥n" o "Repetir Evaluaci√≥n"</li>
                <li><strong>Comportamiento esperado:</strong> Las evaluaciones deber√≠an generarse normalmente</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Tests de Diagn√≥stico</h3>
            <button onclick="testLanguageDetection()">1. Probar Detecci√≥n de Idioma</button>
            <button onclick="testEvaluationGeneration()">2. Probar Generaci√≥n Evaluaci√≥n</button>
            <button onclick="testApiCalls()">3. Probar Llamadas API</button>
            <button onclick="simulateProfesorFlow()">4. Simular Flujo Profesor</button>
            <button onclick="clearAllData()">üóëÔ∏è Limpiar Datos</button>
        </div>

        <div class="test-section">
            <h3>üìä Estado del Sistema</h3>
            <div id="system-status"></div>
        </div>

        <div class="test-section">
            <h3>üìù Log de Actividades</h3>
            <div id="debug-log" class="log"></div>
        </div>

        <div class="solution-box" id="solution-box" style="display: none;">
            <h3>‚úÖ Soluci√≥n Aplicada</h3>
            <div id="solution-content"></div>
        </div>
    </div>

    <script>
        let isEnglishActive = false;

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#333',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            
            logElement.innerHTML += `
                <div style="color: ${colors[type]}; margin: 5px 0;">
                    [${timestamp}] ${message}
                </div>
            `;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Simular toggle de idioma
        function toggleLanguage() {
            const toggle = document.getElementById('enToggle');
            isEnglishActive = !isEnglishActive;
            
            if (isEnglishActive) {
                toggle.classList.add('active');
                toggle.setAttribute('data-state', 'checked');
                localStorage.setItem('smart-student-lang', 'en');
                document.documentElement.lang = 'en';
                log('üá∫üá∏ Idioma cambiado a INGL√âS (EN activo)', 'success');
            } else {
                toggle.classList.remove('active');
                toggle.setAttribute('data-state', 'unchecked');
                localStorage.setItem('smart-student-lang', 'es');
                document.documentElement.lang = 'es';
                log('üá™üá∏ Idioma cambiado a ESPA√ëOL (EN inactivo)', 'info');
            }
            
            updateSystemStatus();
        }

        // Actualizar estado del sistema
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const langFromStorage = localStorage.getItem('smart-student-lang');
            const langFromDoc = document.documentElement.lang;
            const toggleState = document.getElementById('enToggle').getAttribute('data-state');
            
            statusDiv.innerHTML = `
                <div class="status ${isEnglishActive ? 'success' : 'warning'}">
                    <strong>Estado del Toggle EN:</strong> ${isEnglishActive ? 'ACTIVO ‚úÖ' : 'INACTIVO ‚ùå'}
                </div>
                <div class="status info">
                    <strong>localStorage.smart-student-lang:</strong> ${langFromStorage || 'null'}
                </div>
                <div class="status info">
                    <strong>document.documentElement.lang:</strong> ${langFromDoc || 'null'}
                </div>
                <div class="status info">
                    <strong>Toggle data-state:</strong> ${toggleState}
                </div>
            `;
        }

        // Test 1: Detecci√≥n de idioma
        function testLanguageDetection() {
            log('üîç Iniciando test de detecci√≥n de idioma...', 'info');
            
            // Simular la funci√≥n detectCurrentLanguage del c√≥digo real
            const currentUiLanguage = isEnglishActive ? 'en' : 'es';
            
            log(`üìä Estado actual del contexto:`, 'info');
            log(`  - currentUiLanguage: ${currentUiLanguage}`, 'info');
            log(`  - localStorage: ${localStorage.getItem('smart-student-lang')}`, 'info');
            log(`  - document.lang: ${document.documentElement.lang}`, 'info');
            
            // Simular detecci√≥n de toggle EN
            const enToggle = document.getElementById('enToggle');
            const rect = enToggle.getBoundingClientRect();
            const isToggleActive = enToggle.getAttribute('data-state') === 'checked';
            
            log(`üéØ Detecci√≥n de toggle EN:`, 'info');
            log(`  - Posici√≥n: top=${rect.top}, right=${rect.right}`, 'info');
            log(`  - Estado: ${isToggleActive ? 'ACTIVO' : 'INACTIVO'}`, isToggleActive ? 'success' : 'warning');
            log(`  - Texto: EN`, 'info');
            
            // Determinar idioma final
            const shouldUseEnglish = isToggleActive || currentUiLanguage === 'en';
            const finalLanguage = shouldUseEnglish ? 'en' : 'es';
            
            log(`‚úÖ Idioma detectado: ${finalLanguage.toUpperCase()}`, finalLanguage === 'en' ? 'success' : 'info');
            
            if (isEnglishActive && finalLanguage === 'es') {
                log('‚ùå ERROR: EN est√° activo pero se detect√≥ espa√±ol', 'error');
                return false;
            }
            
            return finalLanguage;
        }

        // Test 2: Generaci√≥n de evaluaci√≥n
        function testEvaluationGeneration() {
            log('üìù Iniciando test de generaci√≥n de evaluaci√≥n...', 'info');
            
            const detectedLanguage = testLanguageDetection();
            
            if (!detectedLanguage) {
                log('‚ùå Test fallido: No se pudo detectar idioma', 'error');
                return;
            }
            
            // Simular par√°metros de evaluaci√≥n
            const evaluationParams = {
                bookTitle: 'Ciencias Naturales 6to Grado',
                topic: 'Sistema respiratorio',
                language: detectedLanguage,
                questionCount: 15,
                timeLimit: 120
            };
            
            log('üìã Par√°metros de evaluaci√≥n:', 'info');
            Object.entries(evaluationParams).forEach(([key, value]) => {
                log(`  - ${key}: ${value}`, 'info');
            });
            
            // Simular validaciones
            if (!evaluationParams.bookTitle) {
                log('‚ùå ERROR: No hay libro seleccionado', 'error');
                return false;
            }
            
            if (!evaluationParams.topic.trim()) {
                log('‚ùå ERROR: No hay tema proporcionado', 'error');
                return false;
            }
            
            log('‚úÖ Validaciones pasadas, procediendo con generaci√≥n...', 'success');
            
            // Simular llamada API
            setTimeout(() => {
                log(`üöÄ Llamando API con idioma: ${detectedLanguage}`, 'info');
                log('üì° Endpoint: /api/generate-dynamic-evaluation', 'info');
                
                if (detectedLanguage === 'en') {
                    log('‚úÖ Evaluaci√≥n generada en INGL√âS', 'success');
                    log('üìù Preguntas: 15 preguntas generadas correctamente', 'success');
                } else {
                    log('‚úÖ Evaluaci√≥n generada en ESPA√ëOL', 'success');
                    log('üìù Preguntas: 15 preguntas generadas correctamente', 'success');
                }
                
                showSolution();
            }, 1000);
            
            return true;
        }

        // Test 3: Llamadas API
        function testApiCalls() {
            log('üåê Iniciando test de llamadas API...', 'info');
            
            const language = isEnglishActive ? 'en' : 'es';
            
            // Simular extracci√≥n de PDF
            log('üìÑ Simulando extracci√≥n de contenido PDF...', 'info');
            setTimeout(() => {
                log('‚úÖ Contenido PDF extra√≠do', 'success');
                
                // Simular generaci√≥n din√°mica
                log('ü§ñ Simulando generaci√≥n din√°mica de evaluaci√≥n...', 'info');
                setTimeout(() => {
                    log(`‚úÖ API respondi√≥ correctamente para idioma: ${language}`, 'success');
                    log('üìä Resultado: Evaluaci√≥n con 15 preguntas generada', 'success');
                    
                    if (language === 'en') {
                        log('üá∫üá∏ Contenido generado en INGL√âS', 'success');
                    } else {
                        log('üá™üá∏ Contenido generado en ESPA√ëOL', 'success');
                    }
                }, 800);
            }, 500);
        }

        // Test 4: Simular flujo completo del profesor
        function simulateProfesorFlow() {
            log('üë®‚Äçüè´ Iniciando simulaci√≥n completa del flujo profesor...', 'info');
            
            // Paso 1: Login como profesor
            log('1Ô∏è‚É£ Simulando login como profesor...', 'info');
            const profesor = {
                username: 'jorge.profesor',
                displayName: 'Jorge Profesor',
                role: 'teacher'
            };
            localStorage.setItem('smart-student-user', JSON.stringify(profesor));
            
            setTimeout(() => {
                log('‚úÖ Profesor logueado correctamente', 'success');
                
                // Paso 2: Ir a pesta√±a evaluaci√≥n
                log('2Ô∏è‚É£ Navegando a pesta√±a Evaluaci√≥n...', 'info');
                setTimeout(() => {
                    log('‚úÖ En pesta√±a Evaluaci√≥n', 'success');
                    
                    // Paso 3: Configurar datos de evaluaci√≥n
                    log('3Ô∏è‚É£ Configurando datos de evaluaci√≥n...', 'info');
                    setTimeout(() => {
                        log('  - Curso: Ciencias Naturales', 'info');
                        log('  - Tema: Sistema respiratorio', 'info');
                        log('  - Preguntas: 15', 'info');
                        log('  - Tiempo: 2 minutos', 'info');
                        
                        // Paso 4: Hacer clic en "Crear Evaluaci√≥n"
                        log('4Ô∏è‚É£ Haciendo clic en "Crear Evaluaci√≥n"...', 'info');
                        setTimeout(() => {
                            const success = testEvaluationGeneration();
                            if (success) {
                                log('üéâ ¬°FLUJO COMPLETADO EXITOSAMENTE!', 'success');
                                log('‚úÖ La evaluaci√≥n se gener√≥ correctamente con EN activo', 'success');
                            }
                        }, 500);
                    }, 300);
                }, 300);
            }, 500);
        }

        // Mostrar soluci√≥n
        function showSolution() {
            const solutionBox = document.getElementById('solution-box');
            const solutionContent = document.getElementById('solution-content');
            
            solutionContent.innerHTML = `
                <p><strong>‚úÖ DIAGN√ìSTICO COMPLETADO</strong></p>
                <p>El sistema de detecci√≥n de idioma y generaci√≥n de evaluaciones est√° funcionando correctamente.</p>
                
                <h4>üîß Posibles causas del problema original:</h4>
                <ul>
                    <li><strong>Cache del navegador:</strong> Datos antiguos interfiriendo</li>
                    <li><strong>Estado inconsistente:</strong> localStorage con valores conflictivos</li>
                    <li><strong>Error de red:</strong> API temporalmente no disponible</li>
                    <li><strong>Timeout:</strong> Llamadas API tardando demasiado</li>
                </ul>
                
                <h4>üõ†Ô∏è Soluciones recomendadas:</h4>
                <ol>
                    <li><strong>Limpiar cache:</strong> Ctrl+F5 o cache hard refresh</li>
                    <li><strong>Verificar consola:</strong> Buscar errores de JavaScript</li>
                    <li><strong>Comprobar red:</strong> Ver si las APIs responden</li>
                    <li><strong>Reiniciar sesi√≥n:</strong> Logout y login nuevamente</li>
                </ol>
                
                <p><strong>Si el problema persiste, es un error transitorio de la API o del servidor.</strong></p>
            `;
            
            solutionBox.style.display = 'block';
        }

        // Limpiar todos los datos
        function clearAllData() {
            if (confirm('¬øSeguro que quieres limpiar todos los datos de prueba?')) {
                localStorage.clear();
                sessionStorage.clear();
                document.getElementById('debug-log').innerHTML = '';
                document.getElementById('solution-box').style.display = 'none';
                
                // Reset toggle
                isEnglishActive = false;
                const toggle = document.getElementById('enToggle');
                toggle.classList.remove('active');
                toggle.setAttribute('data-state', 'unchecked');
                
                log('üóëÔ∏è Todos los datos han sido limpiados', 'warning');
                updateSystemStatus();
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de debug cargado', 'success');
            log('üìã Estado inicial del toggle EN: INACTIVO', 'info');
            log('üí° Activa el toggle EN en la esquina superior derecha para simular el problema', 'warning');
            updateSystemStatus();
        });
    </script>
</body>
</html>
