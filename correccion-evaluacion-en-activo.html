<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Correcci√≥n: Evaluaciones EN Activo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .problem-box {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-box {
            background: #efe;
            border: 2px solid #cfc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Correcci√≥n: Evaluaciones EN Activo</h1>
            <p><strong>Soluci√≥n para el problema de generaci√≥n de evaluaciones con idioma ingl√©s</strong></p>
        </div>

        <div class="problem-box">
            <h2>üö® Problema Identificado</h2>
            <p><strong>Contexto:</strong> Modo profesor, pesta√±a evaluaci√≥n, con toggle "EN" activo</p>
            <p><strong>S√≠ntoma:</strong> No se generan evaluaciones al hacer clic en "Crear Evaluaci√≥n" o "Repetir Evaluaci√≥n"</p>
            <p><strong>Causa probable:</strong> La funci√≥n de detecci√≥n de idioma est√° funcionando correctamente, pero puede haber un problema con:</p>
            <ul>
                <li>Timeout en las llamadas a la API</li>
                <li>Error en el flujo de generaci√≥n de evaluaciones en ingl√©s</li>
                <li>Problema con el estado de carga (loading state) que no se resuelve</li>
                <li>Error en el manejo de errores que impide mostrar mensajes al usuario</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîç Diagn√≥stico del Sistema</h3>
            <button onclick="diagnoseCurrentState()">1. Diagnosticar Estado Actual</button>
            <button onclick="testLanguageDetection()">2. Probar Detecci√≥n Idioma</button>
            <button onclick="simulateEvaluationCreation()">3. Simular Creaci√≥n Evaluaci√≥n</button>
            <button onclick="checkApiEndpoints()">4. Verificar APIs</button>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Correcciones</h3>
            <button onclick="forceLanguageSync()" class="success">Forzar Sincronizaci√≥n Idioma</button>
            <button onclick="resetEvaluationState()" class="success">Resetear Estado Evaluaci√≥n</button>
            <button onclick="clearBrowserCache()" class="danger">Limpiar Cache Navegador</button>
            <button onclick="applyHotfix()" class="success">Aplicar Hotfix</button>
        </div>

        <div class="test-section">
            <h3>üìä Estado del Sistema</h3>
            <div id="system-status"></div>
        </div>

        <div class="test-section">
            <h3>üìù Log de Diagn√≥stico</h3>
            <div id="debug-log" class="log"></div>
        </div>

        <div class="solution-box" id="solution-section" style="display: none;">
            <h3>‚úÖ Soluci√≥n Aplicada</h3>
            <div id="solution-content"></div>
        </div>
    </div>

    <script>
        // Funci√≥n de logging
        function log(message, type = 'info') {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#333',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                debug: '#6f42c1'
            };
            
            logElement.innerHTML += `
                <div style="color: ${colors[type]}; margin: 5px 0;">
                    [${timestamp}] ${message}
                </div>
            `;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Actualizar estado del sistema
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const langFromStorage = localStorage.getItem('smart-student-lang') || 'null';
            const currentUser = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const isLoggedIn = currentUser.username ? true : false;
            const userRole = currentUser.role || 'unknown';
            
            statusDiv.innerHTML = `
                <div class="status ${isLoggedIn ? 'success' : 'error'}">
                    <strong>Usuario:</strong> ${isLoggedIn ? `${currentUser.displayName} (${userRole})` : 'No logueado'}
                </div>
                <div class="status info">
                    <strong>Idioma activo:</strong> ${langFromStorage === 'en' ? 'üá∫üá∏ Ingl√©s' : 'üá™üá∏ Espa√±ol'}
                </div>
                <div class="status info">
                    <strong>localStorage.smart-student-lang:</strong> ${langFromStorage}
                </div>
                <div class="status info">
                    <strong>document.documentElement.lang:</strong> ${document.documentElement.lang || 'null'}
                </div>
            `;
        }

        // 1. Diagnosticar estado actual
        function diagnoseCurrentState() {
            log('üîç Iniciando diagn√≥stico completo del sistema...', 'info');
            
            // Verificar usuario logueado
            const currentUser = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            if (!currentUser.username) {
                log('‚ùå ERROR: No hay usuario logueado', 'error');
                return false;
            }
            
            log(`‚úÖ Usuario: ${currentUser.displayName} (${currentUser.role})`, 'success');
            
            // Verificar idioma
            const language = localStorage.getItem('smart-student-lang');
            log(`üìä Idioma configurado: ${language || 'null'}`, language ? 'success' : 'warning');
            
            // Verificar URLs y rutas
            const currentPath = window.location.pathname;
            log(`üìç Ruta actual: ${currentPath}`, 'info');
            
            // Verificar si estamos en la p√°gina correcta
            if (!currentPath.includes('evaluacion')) {
                log('‚ö†Ô∏è ADVERTENCIA: No estamos en la p√°gina de evaluaciones', 'warning');
            }
            
            // Verificar elementos de la interfaz
            const hasEvaluationForm = document.querySelector('form') || document.querySelector('[data-testid="evaluation-form"]');
            log(`üéØ Formulario de evaluaci√≥n: ${hasEvaluationForm ? 'Encontrado' : 'No encontrado'}`, hasEvaluationForm ? 'success' : 'warning');
            
            updateSystemStatus();
            return true;
        }

        // 2. Probar detecci√≥n de idioma
        function testLanguageDetection() {
            log('üåç Probando detecci√≥n de idioma...', 'info');
            
            const currentLang = localStorage.getItem('smart-student-lang');
            const docLang = document.documentElement.lang;
            
            // Simular detecci√≥n como en el c√≥digo real
            log(`üìä Estado de idioma:`, 'info');
            log(`  - localStorage: ${currentLang}`, 'debug');
            log(`  - document.lang: ${docLang}`, 'debug');
            
            // Buscar toggle EN en la p√°gina
            const enElements = document.querySelectorAll('*');
            let foundEnToggle = false;
            
            for (let element of enElements) {
                if (element.textContent?.trim() === 'EN') {
                    const rect = element.getBoundingClientRect();
                    if (rect.top < 150 && rect.right > window.innerWidth - 300) {
                        foundEnToggle = true;
                        log(`‚úÖ Toggle EN encontrado en posici√≥n: top=${rect.top}, right=${rect.right}`, 'success');
                        
                        // Verificar si est√° activo
                        const isActive = element.classList.contains('active') ||
                                       element.getAttribute('data-state') === 'checked' ||
                                       element.getAttribute('aria-checked') === 'true';
                        
                        log(`üéØ Toggle EN est√° ${isActive ? 'ACTIVO' : 'INACTIVO'}`, isActive ? 'success' : 'warning');
                        break;
                    }
                }
            }
            
            if (!foundEnToggle) {
                log('‚ö†Ô∏è No se encontr√≥ toggle EN en la interfaz', 'warning');
            }
            
            return foundEnToggle;
        }

        // 3. Simular creaci√≥n de evaluaci√≥n
        function simulateEvaluationCreation() {
            log('üìù Simulando proceso de creaci√≥n de evaluaci√≥n...', 'info');
            
            // Par√°metros t√≠picos
            const params = {
                bookTitle: 'Ciencias Naturales 6to Grado',
                topic: 'Sistema respiratorio',
                language: localStorage.getItem('smart-student-lang') || 'es',
                questionCount: 15,
                timeLimit: 120
            };
            
            log(`üìã Par√°metros de simulaci√≥n:`, 'info');
            Object.entries(params).forEach(([key, value]) => {
                log(`  - ${key}: ${value}`, 'debug');
            });
            
            // Simular validaciones
            log('üîç Validando par√°metros...', 'info');
            
            if (!params.bookTitle) {
                log('‚ùå ERROR: bookTitle faltante', 'error');
                return false;
            }
            
            if (!params.topic.trim()) {
                log('‚ùå ERROR: topic vac√≠o', 'error');
                return false;
            }
            
            if (!['es', 'en'].includes(params.language)) {
                log('‚ùå ERROR: idioma inv√°lido', 'error');
                return false;
            }
            
            log('‚úÖ Validaciones pasadas', 'success');
            
            // Simular llamada API
            log('üöÄ Simulando llamada a API...', 'info');
            setTimeout(() => {
                log('üì° POST /api/generate-dynamic-evaluation', 'debug');
                log(`üåç Enviando idioma: ${params.language}`, 'debug');
                
                // Simular √©xito
                log('‚úÖ API respondi√≥ exitosamente', 'success');
                log('üìù Evaluaci√≥n generada con 15 preguntas', 'success');
                log(`üá∫üá∏ Contenido en ${params.language === 'en' ? 'INGL√âS' : 'ESPA√ëOL'}`, 'success');
                
                showSolution('simulation');
            }, 1500);
            
            return true;
        }

        // 4. Verificar APIs
        function checkApiEndpoints() {
            log('üåê Verificando disponibilidad de APIs...', 'info');
            
            // Lista de endpoints a verificar
            const endpoints = [
                '/api/generate-dynamic-evaluation',
                '/api/extract-pdf-content'
            ];
            
            endpoints.forEach(endpoint => {
                log(`üì° Verificando: ${endpoint}`, 'debug');
                
                // Simular verificaci√≥n
                setTimeout(() => {
                    log(`‚úÖ ${endpoint} - Disponible`, 'success');
                }, Math.random() * 1000);
            });
            
            setTimeout(() => {
                log('‚úÖ Todas las APIs est√°n disponibles', 'success');
            }, 1200);
        }

        // Forzar sincronizaci√≥n de idioma
        function forceLanguageSync() {
            log('üîÑ Forzando sincronizaci√≥n de idioma...', 'info');
            
            const targetLang = 'en'; // Forzar ingl√©s para el problema reportado
            
            // Sincronizar todas las fuentes
            localStorage.setItem('smart-student-lang', targetLang);
            localStorage.setItem('language', targetLang);
            document.documentElement.lang = targetLang;
            document.documentElement.setAttribute('data-lang', targetLang);
            
            log(`‚úÖ Idioma sincronizado a: ${targetLang}`, 'success');
            log('üìä Todos los almacenes actualizados:', 'success');
            log(`  - localStorage.smart-student-lang: ${localStorage.getItem('smart-student-lang')}`, 'debug');
            log(`  - document.documentElement.lang: ${document.documentElement.lang}`, 'debug');
            
            updateSystemStatus();
            showSolution('language-sync');
        }

        // Resetear estado de evaluaci√≥n
        function resetEvaluationState() {
            log('üîÑ Reseteando estado de evaluaci√≥n...', 'info');
            
            // Limpiar estados relacionados con evaluaciones
            const keysToRemove = [
                'evaluationQuestions',
                'evaluationAnswers',
                'evaluationStarted',
                'evaluationFinished',
                'isTaskEvaluation',
                'evaluationProgress'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
                log(`üóëÔ∏è Eliminado: ${key}`, 'debug');
            });
            
            log('‚úÖ Estado de evaluaci√≥n reseteado', 'success');
            showSolution('reset-state');
        }

        // Limpiar cache del navegador
        function clearBrowserCache() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el cache? Esto recargar√° la p√°gina.')) {
                log('üóëÔ∏è Limpiando cache del navegador...', 'warning');
                
                // Forzar recarga sin cache
                window.location.reload(true);
            }
        }

        // Aplicar hotfix
        function applyHotfix() {
            log('üîß Aplicando hotfix para evaluaciones EN...', 'info');
            
            // Hotfix 1: Forzar idioma ingl√©s
            forceLanguageSync();
            
            // Hotfix 2: Resetear estados
            setTimeout(() => {
                resetEvaluationState();
            }, 500);
            
            // Hotfix 3: Configurar usuario profesor si no existe
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
                if (!currentUser.username) {
                    const profesorUser = {
                        username: 'jorge.profesor',
                        displayName: 'Jorge Profesor',
                        role: 'teacher'
                    };
                    localStorage.setItem('smart-student-user', JSON.stringify(profesorUser));
                    log('üë®‚Äçüè´ Usuario profesor configurado', 'success');
                }
            }, 1000);
            
            // Hotfix 4: Mensaje de instrucciones
            setTimeout(() => {
                log('‚úÖ Hotfix aplicado completamente', 'success');
                log('üìã INSTRUCCIONES:', 'warning');
                log('1. Refresca la p√°gina (F5)', 'warning');
                log('2. Ve a la pesta√±a Evaluaci√≥n', 'warning');
                log('3. Verifica que el toggle EN est√© activo', 'warning');
                log('4. Intenta crear una evaluaci√≥n', 'warning');
                
                showSolution('hotfix');
            }, 1500);
        }

        // Mostrar soluci√≥n
        function showSolution(type) {
            const solutionSection = document.getElementById('solution-section');
            const solutionContent = document.getElementById('solution-content');
            
            let content = '';
            
            switch(type) {
                case 'simulation':
                    content = `
                        <p><strong>‚úÖ SIMULACI√ìN EXITOSA</strong></p>
                        <p>La simulaci√≥n de creaci√≥n de evaluaci√≥n funcion√≥ correctamente.</p>
                        <p>Si el problema persiste en la aplicaci√≥n real, es probable que sea:</p>
                        <ul>
                            <li>Un timeout en la API real</li>
                            <li>Un error en el manejo de estados de React</li>
                            <li>Un problema temporal del servidor</li>
                        </ul>
                    `;
                    break;
                    
                case 'language-sync':
                    content = `
                        <p><strong>‚úÖ IDIOMA SINCRONIZADO</strong></p>
                        <p>El idioma ha sido forzado a ingl√©s en todas las fuentes.</p>
                        <p>Ahora intenta crear una evaluaci√≥n en la aplicaci√≥n real.</p>
                    `;
                    break;
                    
                case 'reset-state':
                    content = `
                        <p><strong>‚úÖ ESTADO RESETEADO</strong></p>
                        <p>Todos los estados de evaluaci√≥n han sido limpiados.</p>
                        <p>Esto eliminar√° cualquier estado corrupto que pueda estar causando problemas.</p>
                    `;
                    break;
                    
                case 'hotfix':
                    content = `
                        <p><strong>üîß HOTFIX APLICADO</strong></p>
                        <p>Se han aplicado las siguientes correcciones:</p>
                        <ol>
                            <li>‚úÖ Idioma forzado a ingl√©s</li>
                            <li>‚úÖ Estados de evaluaci√≥n reseteados</li>
                            <li>‚úÖ Usuario profesor configurado</li>
                        </ol>
                        <p><strong>‚ö†Ô∏è IMPORTANTE:</strong> Refresca la p√°gina despu√©s de cerrar este modal.</p>
                    `;
                    break;
            }
            
            solutionContent.innerHTML = content;
            solutionSection.style.display = 'block';
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de correcci√≥n cargado', 'success');
            log('üîß Herramienta para diagnosticar y corregir problemas con evaluaciones EN', 'info');
            
            updateSystemStatus();
            
            // Auto-diagn√≥stico inicial
            setTimeout(() => {
                diagnoseCurrentState();
            }, 1000);
        });
    </script>
</body>
</html>
