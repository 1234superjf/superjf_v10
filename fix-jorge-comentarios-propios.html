<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöë Correcci√≥n Inmediata - Jorge Profesor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #c0392b;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        .emergency-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin: 15px 0;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .emergency-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        .success-button {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        .warning-button {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        .info-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .step {
            background: white;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöë Correcci√≥n Inmediata</h1>
        
        <div class="alert alert-danger">
            <strong>üéØ PROBLEMA DETECTADO:</strong><br>
            El profesor Jorge est√° viendo notificaciones de sus propios comentarios.
            Esto no deber√≠a suceder seg√∫n las reglas de negocio del sistema.
        </div>

        <div class="info-box">
            <h3>üìã ¬øQu√© hace esta correcci√≥n?</h3>
            <div class="step">
                <strong>1. Diagn√≥stico:</strong> Identifica notificaciones problem√°ticas
            </div>
            <div class="step">
                <strong>2. Correcci√≥n:</strong> Elimina notificaciones de comentarios propios
            </div>
            <div class="step">
                <strong>3. Verificaci√≥n:</strong> Confirma que el problema se resolvi√≥
            </div>
        </div>

        <button class="emergency-button" onclick="correccionCompleta()">
            üöë CORREGIR INMEDIATAMENTE
        </button>

        <button class="emergency-button warning-button" onclick="soloEvaluacion()">
            üîç SOLO EVALUAR (SIN CAMBIOS)
        </button>

        <button class="emergency-button success-button" onclick="copiarScript()" style="display: none;" id="btnScript">
            üìã COPIAR SCRIPT PARA CONSOLA
        </button>

        <div id="resultado" style="display: none;">
            <h3>üìä Resultado de la Correcci√≥n</h3>
            <div id="contenidoResultado"></div>
        </div>

        <div id="instrucciones" class="info-box" style="display: none;">
            <h3>üîß Instrucciones Alternativas</h3>
            <p>Si el bot√≥n no funciona, puedes ejecutar este c√≥digo en la consola del navegador:</p>
            <div class="code-block" id="codigoConsola"></div>
            <p><strong>Para abrir la consola:</strong></p>
            <ul>
                <li>Presiona <kbd>F12</kbd> o <kbd>Ctrl+Shift+I</kbd></li>
                <li>Ve a la pesta√±a "Console"</li>
                <li>Pega el c√≥digo y presiona Enter</li>
            </ul>
        </div>
    </div>

    <script>
        const CODIGO_CORRECCION = `
// üöë CORRECCI√ìN INMEDIATA - Eliminar notificaciones de comentarios propios
console.log('üöë INICIANDO CORRECCI√ìN INMEDIATA...');

// Obtener notificaciones actuales
const notificaciones = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
console.log('üìã Notificaciones antes:', notificaciones.length);

// Filtrar eliminando notificaciones problem√°ticas
const corregidas = notificaciones.filter(n => {
    // Eliminar si es teacher_comment Y el fromUsername est√° en targetUsernames
    if (n.type === 'teacher_comment' && n.targetUsernames.includes(n.fromUsername)) {
        console.log('üóëÔ∏è Eliminando:', n.id, n.fromUsername, '‚Üí', n.targetUsernames);
        return false;
    }
    return true;
});

console.log('‚úÖ Notificaciones despu√©s:', corregidas.length);
console.log('üîß Eliminadas:', notificaciones.length - corregidas.length);

// Guardar correcci√≥n
localStorage.setItem('smart-student-task-notifications', JSON.stringify(corregidas));

// Recargar p√°gina
console.log('üîÑ Recargando p√°gina...');
setTimeout(() => location.reload(), 1000);
`;

        function correccionCompleta() {
            console.log('üöë Ejecutando correcci√≥n completa...');
            
            try {
                // Obtener notificaciones actuales
                const notificaciones = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                console.log('üìã Notificaciones antes de correcci√≥n:', notificaciones.length);
                
                // Contar notificaciones problem√°ticas
                const problematicas = notificaciones.filter(n => 
                    n.type === 'teacher_comment' && n.targetUsernames.includes(n.fromUsername)
                );
                
                // Filtrar eliminando notificaciones problem√°ticas
                const corregidas = notificaciones.filter(n => {
                    if (n.type === 'teacher_comment' && n.targetUsernames.includes(n.fromUsername)) {
                        console.log('üóëÔ∏è Eliminando notificaci√≥n problem√°tica:', {
                            id: n.id,
                            fromUsername: n.fromUsername,
                            targetUsernames: n.targetUsernames,
                            taskTitle: n.taskTitle
                        });
                        return false;
                    }
                    return true;
                });
                
                // Guardar correcci√≥n
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(corregidas));
                
                const eliminadas = notificaciones.length - corregidas.length;
                
                let html = '';
                if (eliminadas > 0) {
                    html = `
                        <div class="alert alert-success">
                            <strong>üéâ ¬°CORRECCI√ìN EXITOSA!</strong><br>
                            ‚Ä¢ Notificaciones eliminadas: <strong>${eliminadas}</strong><br>
                            ‚Ä¢ Notificaciones restantes: <strong>${corregidas.length}</strong><br>
                            ‚Ä¢ Jorge ya NO deber√≠a ver notificaciones de sus propios comentarios
                        </div>
                        <div class="alert alert-warning">
                            <strong>üîÑ IMPORTANTE:</strong> Recarga la p√°gina principal para ver los cambios.
                        </div>
                    `;
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <strong>‚ÑπÔ∏è No se encontraron problemas</strong><br>
                            No se detectaron notificaciones de comentarios propios para eliminar.
                        </div>
                    `;
                }
                
                document.getElementById('contenidoResultado').innerHTML = html;
                document.getElementById('resultado').style.display = 'block';
                
                // Mostrar bot√≥n de script
                document.getElementById('btnScript').style.display = 'block';
                
                if (eliminadas > 0) {
                    // Recargar autom√°ticamente despu√©s de 3 segundos
                    setTimeout(() => {
                        if (confirm('¬øRecargar la p√°gina principal para aplicar los cambios?')) {
                            window.location.href = '/dashboard';
                        }
                    }, 3000);
                }
                
            } catch (error) {
                console.error('‚ùå Error en correcci√≥n:', error);
                document.getElementById('contenidoResultado').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Error en la correcci√≥n:</strong><br>
                        ${error.message}<br><br>
                        Usa el script manual desde la consola.
                    </div>
                `;
                document.getElementById('resultado').style.display = 'block';
                document.getElementById('btnScript').style.display = 'block';
            }
        }
        
        function soloEvaluacion() {
            console.log('üîç Ejecutando solo evaluaci√≥n...');
            
            const notificaciones = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            
            const problematicas = notificaciones.filter(n => 
                n.type === 'teacher_comment' && n.targetUsernames.includes(n.fromUsername)
            );
            
            const jorge = notificaciones.filter(n => 
                n.targetUsernames.includes('jorge_profesor') && !n.readBy.includes('jorge_profesor')
            );
            
            const jorgeProblematicas = jorge.filter(n => n.fromUsername === 'jorge_profesor');
            
            let html = `
                <div class="alert alert-warning">
                    <strong>üìä EVALUACI√ìN DEL SISTEMA:</strong><br>
                    ‚Ä¢ Total de notificaciones: <strong>${notificaciones.length}</strong><br>
                    ‚Ä¢ Notificaciones problem√°ticas: <strong>${problematicas.length}</strong><br>
                    ‚Ä¢ Notificaciones para Jorge: <strong>${jorge.length}</strong><br>
                    ‚Ä¢ Notificaciones propias de Jorge: <strong>${jorgeProblematicas.length}</strong>
                </div>
            `;
            
            if (jorgeProblematicas.length > 0) {
                html += `
                    <div class="alert alert-danger">
                        <strong>‚ùå PROBLEMA CONFIRMADO:</strong><br>
                        Jorge tiene ${jorgeProblematicas.length} notificaci√≥n(es) de sus propios comentarios.
                        Esto est√° causando que vea m√°s notificaciones de las que deber√≠a.
                    </div>
                `;
                
                jorgeProblematicas.forEach((n, i) => {
                    html += `
                        <div class="step">
                            <strong>Notificaci√≥n problem√°tica ${i + 1}:</strong><br>
                            ‚Ä¢ Tipo: ${n.type}<br>
                            ‚Ä¢ Tarea: ${n.taskTitle}<br>
                            ‚Ä¢ De: ${n.fromDisplayName} (${n.fromUsername})<br>
                            ‚Ä¢ Para: ${n.targetUsernames.join(', ')}<br>
                            ‚Ä¢ Fecha: ${new Date(n.timestamp).toLocaleString()}
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="alert alert-success">
                        <strong>‚úÖ NO HAY PROBLEMAS:</strong><br>
                        No se detectaron notificaciones de comentarios propios para Jorge.
                    </div>
                `;
            }
            
            document.getElementById('contenidoResultado').innerHTML = html;
            document.getElementById('resultado').style.display = 'block';
            document.getElementById('btnScript').style.display = 'block';
        }
        
        function copiarScript() {
            document.getElementById('codigoConsola').textContent = CODIGO_CORRECCION;
            document.getElementById('instrucciones').style.display = 'block';
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(CODIGO_CORRECCION).then(() => {
                alert('üìã C√≥digo copiado al portapapeles. P√©galo en la consola del navegador.');
            }).catch(() => {
                alert('‚ö†Ô∏è No se pudo copiar autom√°ticamente. Copia manualmente el c√≥digo que aparece abajo.');
            });
        }
        
        // Ejecutar evaluaci√≥n autom√°tica al cargar
        window.onload = function() {
            console.log('üöë Herramienta de correcci√≥n inmediata cargada');
            soloEvaluacion();
        };
    </script>
</body>
</html>
