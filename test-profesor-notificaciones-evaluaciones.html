<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba: Notificaciones de Evaluaciones para el Profesor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">
            üß™ Prueba: Flujo de Notificaciones de Evaluaciones para el Profesor
        </h1>
        
        <div class="space-y-6">
            <!-- Configuraci√≥n inicial -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üîß Configuraci√≥n de Prueba</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setupTestData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Configurar Datos de Prueba
                    </button>
                    <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Limpiar Todos los Datos
                    </button>
                </div>
            </div>

            <!-- Simulaci√≥n de evaluaci√≥n completada -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üéØ Simulaci√≥n de Evaluaci√≥n Completada</h2>
                <p class="text-gray-600 mb-4">Simula que un estudiante completa una evaluaci√≥n</p>
                <div class="flex gap-4">
                    <button onclick="simulateEvaluationCompletion('felipe')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Felipe completa evaluaci√≥n
                    </button>
                    <button onclick="simulateEvaluationCompletion('maria')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Mar√≠a completa evaluaci√≥n
                    </button>
                </div>
            </div>

            <!-- Estado de notificaciones del profesor -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üîî Notificaciones del Profesor Jorge</h2>
                <div class="flex gap-4 mb-4">
                    <button onclick="checkProfessorNotifications()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                        Verificar Notificaciones
                    </button>
                    <button onclick="showTaskResults()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        Ver Resultados de Evaluaci√≥n
                    </button>
                </div>
                <div id="professor-notifications" class="bg-gray-50 p-4 rounded text-sm font-mono whitespace-pre-wrap"></div>
            </div>

            <!-- Resultados de evaluaciones -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìä Resultados de Evaluaciones</h2>
                <div id="evaluation-results" class="bg-gray-50 p-4 rounded text-sm font-mono whitespace-pre-wrap"></div>
            </div>

            <!-- Log de eventos -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">üìù Log de Eventos</h2>
                <div id="event-log" class="bg-gray-900 text-green-400 p-4 rounded text-sm font-mono whitespace-pre-wrap h-64 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // Utilidades de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('event-log');
            const colorClass = type === 'success' ? 'text-green-400' : 
                              type === 'error' ? 'text-red-400' : 
                              type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
            
            logElement.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Sistema de notificaciones simplificado (simulando el real)
        class TaskNotificationManager {
            static getNotifications() {
                return JSON.parse(localStorage.getItem('smart-student-notifications') || '[]');
            }

            static saveNotifications(notifications) {
                localStorage.setItem('smart-student-notifications', JSON.stringify(notifications));
                log(`üíæ Saved ${notifications.length} notifications to localStorage`);
            }

            static createEvaluationCompletedNotification(taskId, taskTitle, course, subject, studentUsername, studentDisplayName, teacherUsername, evaluationResults) {
                log(`üîî Creating evaluation completed notification for teacher: ${teacherUsername}`);
                
                const notifications = this.getNotifications();
                
                const newNotification = {
                    id: `eval_completed_${taskId}_${studentUsername}_${Date.now()}`,
                    type: 'task_completed',
                    taskId,
                    taskTitle,
                    targetUserRole: 'teacher',
                    targetUsernames: [teacherUsername],
                    fromUsername: studentUsername,
                    fromDisplayName: studentDisplayName,
                    course,
                    subject,
                    timestamp: new Date().toISOString(),
                    read: false,
                    readBy: [],
                    taskType: 'evaluation',
                    grade: evaluationResults.completionPercentage
                };

                notifications.push(newNotification);
                this.saveNotifications(notifications);
                
                log(`‚úÖ Notification created: ${newNotification.id}`, 'success');
                return newNotification;
            }

            static getUnreadNotificationsForUser(username, userRole) {
                const notifications = this.getNotifications();
                return notifications.filter(notification => {
                    return notification.targetUserRole === userRole &&
                           notification.targetUsernames.includes(username) &&
                           !notification.readBy.includes(username) &&
                           notification.fromUsername !== username;
                });
            }
        }

        // Configurar datos de prueba
        function setupTestData() {
            log('üîß Setting up test data...');
            
            // Crear profesor Jorge
            const professor = {
                username: 'jorge',
                firstName: 'Jorge',
                lastName: 'Profesor',
                email: 'jorge@profesor.com',
                role: 'teacher',
                displayName: 'Jorge Profesor',
                activeCourses: ['4to B√°sico'],
                subjects: ['Ciencias Naturales']
            };

            // Crear estudiantes
            const students = [
                {
                    username: 'felipe',
                    firstName: 'Felipe',
                    lastName: 'Estudiante',
                    email: 'felipe@estudiante.com',
                    role: 'student',
                    displayName: 'Felipe Estudiante',
                    activeCourses: ['4to B√°sico']
                },
                {
                    username: 'maria',
                    firstName: 'Mar√≠a',
                    lastName: 'Estudiante',
                    email: 'maria@estudiante.com',
                    role: 'student',
                    displayName: 'Mar√≠a Estudiante',
                    activeCourses: ['4to B√°sico']
                }
            ];

            // Guardar usuarios
            const users = {};
            users[professor.username] = professor;
            students.forEach(student => {
                users[student.username] = student;
            });
            localStorage.setItem('smart-student-users', JSON.stringify(users));

            // Crear tarea de evaluaci√≥n
            const evaluationTask = {
                id: 'eval_test_001',
                title: 'Evaluaci√≥n de Ciencias Naturales',
                description: 'Evaluaci√≥n sobre el sistema solar',
                subject: 'Ciencias Naturales',
                course: '4to B√°sico',
                assignedBy: 'jorge',
                assignedByName: 'Jorge Profesor',
                assignedTo: 'course',
                dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString(),
                status: 'pending',
                priority: 'medium',
                taskType: 'evaluation',
                evaluationConfig: {
                    topic: 'Sistema Solar',
                    questionCount: 10,
                    timeLimit: 30
                },
                evaluationResults: {}
            };

            // Guardar tarea global
            localStorage.setItem('smart-student-tasks', JSON.stringify([evaluationTask]));

            // Crear tareas para estudiantes
            students.forEach(student => {
                const userTasksKey = `userTasks_${student.username}`;
                localStorage.setItem(userTasksKey, JSON.stringify([evaluationTask]));
            });

            // Limpiar notificaciones existentes
            localStorage.removeItem('smart-student-notifications');

            log('‚úÖ Test data setup complete!', 'success');
            log(`üë®‚Äçüè´ Professor: ${professor.displayName} (${professor.username})`);
            students.forEach(student => {
                log(`üë®‚Äçüéì Student: ${student.displayName} (${student.username})`);
            });
            log(`üìö Evaluation: ${evaluationTask.title}`);
        }

        // Simular completar evaluaci√≥n
        function simulateEvaluationCompletion(studentUsername) {
            log(`üéØ Simulating evaluation completion for student: ${studentUsername}`);
            
            const taskId = 'eval_test_001';
            const score = Math.floor(Math.random() * 5) + 6; // Entre 6 y 10
            const totalQuestions = 10;
            const completionPercentage = (score / totalQuestions) * 100;
            
            // 1. Actualizar resultados en la tarea global
            const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const taskIndex = globalTasks.findIndex(task => task.id === taskId);
            
            if (taskIndex !== -1) {
                if (!globalTasks[taskIndex].evaluationResults) {
                    globalTasks[taskIndex].evaluationResults = {};
                }
                
                globalTasks[taskIndex].evaluationResults[studentUsername] = {
                    score: score,
                    totalQuestions: totalQuestions,
                    completionPercentage: completionPercentage,
                    completedAt: new Date().toISOString(),
                    attempt: 1
                };
                
                localStorage.setItem('smart-student-tasks', JSON.stringify(globalTasks));
                log(`üìä Updated global task results: ${score}/${totalQuestions} (${completionPercentage.toFixed(1)}%)`, 'success');
            }

            // 2. Crear notificaci√≥n para el profesor
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
            const student = users[studentUsername];
            const professor = users['jorge'];

            if (student && professor) {
                TaskNotificationManager.createEvaluationCompletedNotification(
                    taskId,
                    'Evaluaci√≥n de Ciencias Naturales',
                    '4to B√°sico',
                    'Ciencias Naturales',
                    studentUsername,
                    student.displayName,
                    'jorge',
                    {
                        score: score,
                        totalQuestions: totalQuestions,
                        completionPercentage: completionPercentage,
                        completedAt: new Date().toISOString()
                    }
                );
                
                log(`üîî Notification created for professor: jorge`, 'success');
            }

            // 3. Simular evento de actualizaci√≥n
            window.dispatchEvent(new Event('taskNotificationsUpdated'));
            log(`üì° Event dispatched: taskNotificationsUpdated`, 'info');
        }

        // Verificar notificaciones del profesor
        function checkProfessorNotifications() {
            log('üîç Checking professor notifications...');
            
            const notifications = TaskNotificationManager.getUnreadNotificationsForUser('jorge', 'teacher');
            const notificationsElement = document.getElementById('professor-notifications');
            
            if (notifications.length === 0) {
                notificationsElement.textContent = '‚ùå No hay notificaciones para el profesor Jorge';
                log('‚ùå No notifications found for professor', 'warning');
                return;
            }

            let output = `‚úÖ Encontradas ${notifications.length} notificaciones para el profesor Jorge:\n\n`;
            
            notifications.forEach((notif, index) => {
                output += `${index + 1}. ${notif.type === 'task_completed' ? 'üéØ' : 'üìù'} ${notif.type}\n`;
                output += `   üìö Tarea: ${notif.taskTitle}\n`;
                output += `   üë®‚Äçüéì Estudiante: ${notif.fromDisplayName} (${notif.fromUsername})\n`;
                output += `   üìä Calificaci√≥n: ${notif.grade ? notif.grade.toFixed(1) + '%' : 'N/A'}\n`;
                output += `   ‚è∞ Fecha: ${new Date(notif.timestamp).toLocaleString()}\n`;
                output += `   üÜî ID: ${notif.id}\n\n`;
            });

            notificationsElement.textContent = output;
            log(`‚úÖ Found ${notifications.length} notifications for professor`, 'success');
        }

        // Ver resultados de evaluaci√≥n
        function showTaskResults() {
            log('üìä Checking evaluation results...');
            
            const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const evaluationTask = globalTasks.find(task => task.id === 'eval_test_001');
            const resultsElement = document.getElementById('evaluation-results');
            
            if (!evaluationTask) {
                resultsElement.textContent = '‚ùå No se encontr√≥ la tarea de evaluaci√≥n';
                log('‚ùå Evaluation task not found', 'error');
                return;
            }

            let output = `üìä Resultados de la evaluaci√≥n: ${evaluationTask.title}\n\n`;
            
            if (!evaluationTask.evaluationResults || Object.keys(evaluationTask.evaluationResults).length === 0) {
                output += '‚ùå No hay resultados registrados a√∫n\n';
            } else {
                output += `‚úÖ Estudiantes que han completado la evaluaci√≥n (${Object.keys(evaluationTask.evaluationResults).length}):\n\n`;
                
                Object.entries(evaluationTask.evaluationResults).forEach(([studentUsername, results]) => {
                    const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
                    const student = users[studentUsername];
                    const studentName = student ? student.displayName : studentUsername;
                    
                    output += `üë®‚Äçüéì ${studentName} (${studentUsername})\n`;
                    output += `   üìä Puntaje: ${results.score}/${results.totalQuestions} (${results.completionPercentage.toFixed(1)}%)\n`;
                    output += `   ‚è∞ Completado: ${new Date(results.completedAt).toLocaleString()}\n`;
                    output += `   üîÑ Intento: ${results.attempt}\n\n`;
                });
            }

            resultsElement.textContent = output;
            log(`üìä Evaluation results checked - ${Object.keys(evaluationTask.evaluationResults || {}).length} students completed`, 'info');
        }

        // Limpiar todos los datos
        function clearAllData() {
            localStorage.removeItem('smart-student-users');
            localStorage.removeItem('smart-student-tasks');
            localStorage.removeItem('smart-student-notifications');
            localStorage.removeItem('userTasks_felipe');
            localStorage.removeItem('userTasks_maria');
            localStorage.removeItem('userTasks_jorge');
            
            document.getElementById('professor-notifications').textContent = '';
            document.getElementById('evaluation-results').textContent = '';
            
            log('üßπ All test data cleared', 'warning');
        }

        // Auto-actualizaci√≥n cada 5 segundos
        setInterval(() => {
            if (document.getElementById('professor-notifications').textContent.includes('‚úÖ')) {
                checkProfessorNotifications();
            }
            if (document.getElementById('evaluation-results').textContent.includes('‚úÖ')) {
                showTaskResults();
            }
        }, 5000);

        // Mensaje inicial
        log('üöÄ Test interface loaded. Click "Configurar Datos de Prueba" to start.');
    </script>
</body>
</html>
