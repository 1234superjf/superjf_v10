<!DOCTYPE html>
<html>
<head>
    <title>Test: Comentarios No Le√≠dos - Estudiante</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico: Comentarios No Le√≠dos - Estudiante</h1>
        
        <div class="section">
            <h2>Paso 1: Configurar Datos de Prueba</h2>
            <button class="btn-primary" onclick="setupTestData()">üìù Configurar Usuario y Comentarios</button>
            <div id="setup-result"></div>
        </div>

        <div class="section">
            <h2>Paso 2: Verificar Conteo Inicial</h2>
            <button class="btn-primary" onclick="checkInitialCount()">üìä Verificar Comentarios No Le√≠dos</button>
            <div id="initial-count-result"></div>
        </div>

        <div class="section">
            <h2>Paso 3: Simular Navegaci√≥n a Tarea</h2>
            <button class="btn-warning" onclick="simulateTaskNavigation()">üëÅÔ∏è Simular Abrir Tarea</button>
            <div id="navigation-result"></div>
        </div>

        <div class="section">
            <h2>Paso 4: Verificar Evento de Actualizaci√≥n</h2>
            <button class="btn-success" onclick="testEventHandling()">üîÑ Probar Evento commentsUpdated</button>
            <div id="event-result"></div>
        </div>

        <div class="section">
            <h2>Paso 5: Verificar Conteo Final</h2>
            <button class="btn-primary" onclick="checkFinalCount()">üìä Verificar Conteo Final</button>
            <div id="final-count-result"></div>
        </div>

        <div class="section">
            <h2>Paso 6: Diagn√≥stico del Problema</h2>
            <button class="btn-danger" onclick="diagnoseProblems()">üîß Diagnosticar Problemas</button>
            <div id="diagnosis-result"></div>
        </div>
    </div>

    <script>
        let testTaskId = 'task_test_comentarios_' + Date.now();
        let testUser = {
            username: 'felipe_estudiante',
            role: 'student',
            id: 'felipe_123'
        };
        let initialCount = 0;
        let finalCount = 0;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : 
                             type === 'success' ? 'success' : 
                             type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function setupTestData() {
            log('setup-result', 'üîß Configurando datos de prueba...', 'info');
            
            // Configurar usuario de prueba
            localStorage.setItem('smart-student-user', JSON.stringify(testUser));
            
            // Configurar tarea de prueba
            const testTask = {
                id: testTaskId,
                title: 'Ensayo sobre la Revoluci√≥n Industrial',
                assignedBy: 'profesor_martinez',
                course: '10A',
                subject: 'Historia',
                taskType: 'tarea'
            };
            
            const existingTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            existingTasks.push(testTask);
            localStorage.setItem('smart-student-tasks', JSON.stringify(existingTasks));
            
            // Configurar comentarios de prueba (NO LE√çDOS)
            const testComments = [
                {
                    id: 'comment_test_1',
                    taskId: testTaskId,
                    studentUsername: 'profesor_martinez',
                    studentName: 'Prof. Mart√≠nez',
                    comment: 'Muy buen trabajo Felipe, pero necesitas mejorar las conclusiones.',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: [], // NO LE√çDO
                    isNew: true
                },
                {
                    id: 'comment_test_2',
                    taskId: testTaskId,
                    studentUsername: 'profesor_martinez',
                    studentName: 'Prof. Mart√≠nez',
                    comment: 'Revisa las fuentes bibliogr√°ficas que te mencion√©.',
                    timestamp: new Date().toISOString(),
                    isSubmission: false,
                    userRole: 'teacher',
                    readBy: [], // NO LE√çDO
                    isNew: true
                }
            ];
            
            const existingComments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            testComments.forEach(comment => existingComments.push(comment));
            localStorage.setItem('smart-student-task-comments', JSON.stringify(existingComments));
            
            log('setup-result', '‚úÖ Datos configurados correctamente', 'success');
            log('setup-result', `üìù Tarea: ${testTask.title}`, 'info');
            log('setup-result', `üë§ Usuario: ${testUser.username} (${testUser.role})`, 'info');
            log('setup-result', `üí¨ Comentarios: ${testComments.length} sin leer`, 'info');
        }

        function checkInitialCount() {
            log('initial-count-result', 'üìä Verificando conteo inicial...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Simular la l√≥gica del dashboard
            let unread = comments.filter((comment) => 
                comment.studentUsername !== user.username && 
                (!comment.readBy?.includes(user.username)) &&
                !comment.isSubmission
            );

            // Eliminar duplicados
            unread = unread.filter((comment, idx, arr) =>
                arr.findIndex(c =>
                    c.taskId === comment.taskId &&
                    c.comment === comment.comment &&
                    c.timestamp === comment.timestamp &&
                    c.studentUsername === comment.studentUsername
                ) === idx
            );
            
            initialCount = unread.length;
            
            log('initial-count-result', `üì© Comentarios no le√≠dos encontrados: ${initialCount}`, 'info');
            
            if (initialCount > 0) {
                log('initial-count-result', 'üìù Detalles de comentarios no le√≠dos:', 'info');
                unread.forEach((comment, index) => {
                    log('initial-count-result', `   ${index + 1}. "${comment.comment}" por ${comment.studentName}`, 'info');
                });
            } else {
                log('initial-count-result', '‚ö†Ô∏è No hay comentarios no le√≠dos para probar', 'warning');
            }
        }

        function simulateTaskNavigation() {
            log('navigation-result', 'üëÅÔ∏è Simulando navegaci√≥n a tarea...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Simular la funci√≥n markCommentsAsReadForTask
            let updated = false;
            
            const updatedComments = comments.map((comment) => {
                if (
                    comment.taskId === testTaskId && 
                    !comment.isSubmission &&
                    comment.studentUsername !== user.username &&
                    (!comment.readBy?.includes(user.username))
                ) {
                    updated = true;
                    log('navigation-result', `‚úÖ Marcando como le√≠do: "${comment.comment}"`, 'success');
                    return {
                        ...comment,
                        isNew: false,
                        readBy: [...(comment.readBy || []), user.username]
                    };
                }
                return comment;
            });
            
            if (updated) {
                localStorage.setItem('smart-student-task-comments', JSON.stringify(updatedComments));
                log('navigation-result', 'üíæ Comentarios actualizados en localStorage', 'success');
            } else {
                log('navigation-result', '‚ö†Ô∏è No se encontraron comentarios para marcar como le√≠dos', 'warning');
            }
        }

        function testEventHandling() {
            log('event-result', 'üîÑ Probando manejo de eventos...', 'info');
            
            // Simular el evento commentsUpdated
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Simular handleCommentsUpdated del dashboard
            if (user?.role === 'student') {
                log('event-result', 'üìö Recargando comentarios no le√≠dos para estudiante...', 'info');
                
                let unread = comments.filter((comment) => 
                    comment.studentUsername !== user.username && 
                    (!comment.readBy?.includes(user.username)) &&
                    !comment.isSubmission
                );

                unread = unread.filter((comment, idx, arr) =>
                    arr.findIndex((c) =>
                        c.taskId === comment.taskId &&
                        c.comment === comment.comment &&
                        c.timestamp === comment.timestamp &&
                        c.studentUsername === comment.studentUsername
                    ) === idx
                );
                
                log('event-result', `üìä Comentarios no le√≠dos despu√©s del evento: ${unread.length}`, 'info');
                
                // Simular el disparo del evento
                document.dispatchEvent(new Event('commentsUpdated'));
                log('event-result', 'üì° Evento "commentsUpdated" disparado', 'success');
            }
        }

        function checkFinalCount() {
            log('final-count-result', 'üìä Verificando conteo final...', 'info');
            
            const user = JSON.parse(localStorage.getItem('smart-student-user') || '{}');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            
            // Repetir la l√≥gica del dashboard
            let unread = comments.filter((comment) => 
                comment.studentUsername !== user.username && 
                (!comment.readBy?.includes(user.username)) &&
                !comment.isSubmission
            );

            unread = unread.filter((comment, idx, arr) =>
                arr.findIndex(c =>
                    c.taskId === comment.taskId &&
                    c.comment === comment.comment &&
                    c.timestamp === comment.timestamp &&
                    c.studentUsername === comment.studentUsername
                ) === idx
            );
            
            finalCount = unread.length;
            
            log('final-count-result', `üì© Comentarios no le√≠dos final: ${finalCount}`, 'info');
            
            if (finalCount === 0) {
                log('final-count-result', '‚úÖ Todos los comentarios fueron marcados como le√≠dos', 'success');
            } else {
                log('final-count-result', '‚ùå Algunos comentarios siguen sin leer', 'error');
                unread.forEach((comment, index) => {
                    log('final-count-result', `   ${index + 1}. "${comment.comment}" por ${comment.studentName}`, 'error');
                });
            }
        }

        function diagnoseProblems() {
            log('diagnosis-result', 'üîß Ejecutando diagn√≥stico...', 'info');
            
            log('diagnosis-result', `üìä Comentarios no le√≠dos INICIAL: ${initialCount}`, 'info');
            log('diagnosis-result', `üìä Comentarios no le√≠dos FINAL: ${finalCount}`, 'info');
            
            if (initialCount > 0 && finalCount === 0) {
                log('diagnosis-result', '‚úÖ PROBLEMA RESUELTO: Los comentarios se marcaron correctamente como le√≠dos', 'success');
                log('diagnosis-result', 'üí° La l√≥gica funciona, el problema podr√≠a estar en:', 'info');
                log('diagnosis-result', '   1. El evento no se dispara en el momento correcto en la aplicaci√≥n real', 'info');
                log('diagnosis-result', '   2. El dashboard no escucha el evento en el momento correcto', 'info');
                log('diagnosis-result', '   3. Hay problemas de timing o race conditions', 'info');
            } else if (initialCount > 0 && finalCount > 0) {
                log('diagnosis-result', '‚ùå PROBLEMA PERSISTENTE: Los comentarios no se marcaron como le√≠dos', 'error');
                log('diagnosis-result', 'üîç Posibles causas:', 'info');
                log('diagnosis-result', '   1. La funci√≥n markCommentsAsReadForTask no se est√° ejecutando', 'error');
                log('diagnosis-result', '   2. Los par√°metros no coinciden (taskId, username)', 'error');
                log('diagnosis-result', '   3. El evento commentsUpdated no se dispara', 'error');
                log('diagnosis-result', '   4. El dashboard no recibe el evento correctamente', 'error');
            } else if (initialCount === 0) {
                log('diagnosis-result', '‚ö†Ô∏è NO HAY COMENTARIOS PARA PROBAR', 'warning');
                log('diagnosis-result', '   Configura primero los datos de prueba', 'warning');
            }
            
            // Mostrar informaci√≥n adicional
            log('diagnosis-result', '', 'info');
            log('diagnosis-result', 'üìã PARA VERIFICAR EN LA APLICACI√ìN REAL:', 'info');
            log('diagnosis-result', '   1. Abre la consola del navegador', 'info');
            log('diagnosis-result', '   2. Busca mensajes de "[TaskNotificationManager]"', 'info');
            log('diagnosis-result', '   3. Verifica si se ejecuta "markCommentsAsReadForTask"', 'info');
            log('diagnosis-result', '   4. Verifica si se dispara el evento "commentsUpdated"', 'info');
            log('diagnosis-result', '   5. Verifica si el dashboard recibe el evento', 'info');
        }

        // Limpiar datos de prueba al cargar
        function cleanup() {
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const filteredComments = comments.filter(c => !c.id.startsWith('comment_test_'));
            localStorage.setItem('smart-student-task-comments', JSON.stringify(filteredComments));
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const filteredTasks = tasks.filter(t => !t.id.startsWith('task_test_comentarios_'));
            localStorage.setItem('smart-student-tasks', JSON.stringify(filteredTasks));
        }

        // Limpiar al cargar la p√°gina
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>
