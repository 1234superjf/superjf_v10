<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Reparaci√≥n de Estudiantes</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button { 
            background: #007cba; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover { background: #005a84; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        
        .log { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap; 
            border-left: 4px solid #007cba;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            background: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        .step h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Herramienta de Reparaci√≥n: Estudiantes Espec√≠ficos</h1>
        
        <div class="alert info">
            <strong>üìã Problema detectado:</strong> Los estudiantes no aparecen en "Estudiantes espec√≠ficos" porque hay inconsistencias entre los UUIDs de cursos y los nombres de cursos en los datos de estudiantes.
        </div>
        
        <div class="step">
            <h3>üîç Paso 1: Diagn√≥stico</h3>
            <p>Verifica el estado actual de los datos antes de la reparaci√≥n.</p>
            <button onclick="ejecutarDiagnostico()">üîç Ejecutar Diagn√≥stico</button>
        </div>
        
        <div class="step">
            <h3>üîß Paso 2: Reparaci√≥n Autom√°tica</h3>
            <p>Corrige autom√°ticamente los datos de estudiantes para que aparezcan en la selecci√≥n.</p>
            <button onclick="ejecutarReparacion()" class="success">üöÄ Ejecutar Reparaci√≥n</button>
        </div>
        
        <div class="step">
            <h3>‚úÖ Paso 3: Verificaci√≥n</h3>
            <p>Verifica que la reparaci√≥n fue exitosa y prueba la funcionalidad.</p>
            <button onclick="verificarReparacion()">‚úÖ Verificar Resultado</button>
            <button onclick="irATareas()" class="success">üìù Probar en Tareas</button>
        </div>
        
        <div id="resultado"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        function mostrarResultado(mensaje, tipo = 'info') {
            const div = document.getElementById('resultado');
            div.innerHTML = `<div class="alert ${tipo}">${mensaje}</div>`;
        }
        
        function log(mensaje) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.innerHTML += mensaje + '\n';
            console.log(mensaje);
        }
        
        function limpiarLog() {
            document.getElementById('log').innerHTML = '';
        }

        function ejecutarDiagnostico() {
            limpiarLog();
            mostrarResultado('üîç Ejecutando diagn√≥stico...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
                
                if (!auth.user || auth.user.role !== 'teacher') {
                    mostrarResultado('‚ùå Error: Debes estar logueado como profesor', 'error');
                    return;
                }
                
                log('üë§ Profesor actual: ' + auth.user.displayName + ' (' + auth.user.username + ')');
                log('üìä Total usuarios: ' + users.length);
                log('üìö Total cursos: ' + courses.length);
                
                const targetCourseId = '9077a79d-c290-45f9-b549-6e57df8828d2';
                const targetCourse = courses.find(c => c.id === targetCourseId);
                
                log('üéØ Curso objetivo (UUID): ' + targetCourseId);
                log('üîç Curso encontrado: ' + (targetCourse ? targetCourse.name : 'NO ENCONTRADO'));
                
                const estudiantes = users.filter(u => u.role === 'student');
                log('üë• Total estudiantes: ' + estudiantes.length);
                
                let problemasEncontrados = 0;
                estudiantes.forEach(e => {
                    const tieneProfesor = e.assignedTeacher === auth.user.username || 
                                         (e.assignedTeachers && Object.values(e.assignedTeachers).includes(auth.user.username));
                    const tieneCursoUUID = e.activeCourses && e.activeCourses.includes(targetCourseId);
                    const tieneCursoNombre = e.activeCourses && e.activeCourses.includes('4to B√°sico');
                    
                    log(`   ‚Ä¢ ${e.displayName}: profesor=${tieneProfesor}, cursoUUID=${tieneCursoUUID}, cursoNombre=${tieneCursoNombre}`);
                    log(`     - activeCourses: [${e.activeCourses?.join(', ')}]`);
                    log(`     - assignedTeacher: ${e.assignedTeacher}`);
                    
                    if (tieneCursoNombre && !tieneCursoUUID && !tieneProfesor) {
                        problemasEncontrados++;
                    }
                });
                
                if (problemasEncontrados > 0) {
                    mostrarResultado(`‚ö†Ô∏è Diagn√≥stico completado: ${problemasEncontrados} problemas encontrados. Los estudiantes tienen cursos por nombre pero necesitan UUID y asignaci√≥n de profesor.`, 'warning');
                } else {
                    mostrarResultado('‚úÖ Diagn√≥stico completado: No se encontraron problemas evidentes.', 'success');
                }
                
            } catch (error) {
                mostrarResultado('‚ùå Error durante el diagn√≥stico: ' + error.message, 'error');
                log('Error: ' + error.message);
            }
        }

        function ejecutarReparacion() {
            limpiarLog();
            mostrarResultado('üîß Ejecutando reparaci√≥n...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
                
                if (!auth.user || auth.user.role !== 'teacher') {
                    mostrarResultado('‚ùå Error: Debes estar logueado como profesor', 'error');
                    return;
                }
                
                const targetCourseId = '9077a79d-c290-45f9-b549-6e57df8828d2';
                const targetCourseName = '4to B√°sico';
                
                // Crear curso si no existe
                let targetCourse = courses.find(c => c.id === targetCourseId);
                if (!targetCourse) {
                    courses.push({
                        id: targetCourseId,
                        name: targetCourseName
                    });
                    localStorage.setItem('smart-student-courses', JSON.stringify(courses));
                    log('‚úÖ Curso creado: ' + targetCourseId + ' (' + targetCourseName + ')');
                }
                
                // Reparar estudiantes
                const estudiantesObjetivo = ['felipe', 'maria', 'sofia', 'karla', 'gustavo', 'max'];
                let reparados = 0;
                
                users.forEach(user => {
                    if (user.role === 'student' && estudiantesObjetivo.includes(user.username)) {
                        log('üîß Reparando estudiante: ' + user.username);
                        
                        // Asignar al curso por UUID
                        user.activeCourses = [targetCourseId];
                        
                        // Asignar al profesor actual
                        user.assignedTeacher = auth.user.username;
                        user.assignedTeachers = {
                            'Lenguaje y Comunicaci√≥n': auth.user.username,
                            'Matem√°ticas': auth.user.username,
                            'Ciencias Naturales': auth.user.username,
                            'Historia, Geograf√≠a y Ciencias Sociales': auth.user.username
                        };
                        
                        log('‚úÖ Reparado: ' + user.username + ' ‚Üí Curso: ' + targetCourseId + ', Profesor: ' + auth.user.username);
                        reparados++;
                    }
                });
                
                // Guardar cambios
                localStorage.setItem('smart-student-users', JSON.stringify(users));
                
                log('üéâ REPARACI√ìN COMPLETADA:');
                log('   ‚Ä¢ Estudiantes reparados: ' + reparados);
                log('   ‚Ä¢ Curso objetivo: ' + targetCourseId);
                log('   ‚Ä¢ Profesor asignado: ' + auth.user.username);
                
                mostrarResultado(`üéâ Reparaci√≥n exitosa: ${reparados} estudiantes reparados. Ahora deber√≠an aparecer en "Estudiantes espec√≠ficos".`, 'success');
                
            } catch (error) {
                mostrarResultado('‚ùå Error durante la reparaci√≥n: ' + error.message, 'error');
                log('Error: ' + error.message);
            }
        }

        function verificarReparacion() {
            limpiarLog();
            mostrarResultado('‚úÖ Verificando reparaci√≥n...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                
                if (!auth.user || auth.user.role !== 'teacher') {
                    mostrarResultado('‚ùå Error: Debes estar logueado como profesor', 'error');
                    return;
                }
                
                const targetCourseId = '9077a79d-c290-45f9-b549-6e57df8828d2';
                
                const estudiantesCorrectos = users.filter(u => 
                    u.role === 'student' &&
                    u.activeCourses && u.activeCourses.includes(targetCourseId) &&
                    u.assignedTeacher === auth.user.username
                );
                
                log('üîç Verificando estudiantes reparados:');
                estudiantesCorrectos.forEach(e => {
                    log(`   ‚úÖ ${e.displayName}: curso correcto, profesor asignado`);
                });
                
                if (estudiantesCorrectos.length > 0) {
                    mostrarResultado(`‚úÖ Verificaci√≥n exitosa: ${estudiantesCorrectos.length} estudiantes correctamente configurados. ¬°Ahora deber√≠an aparecer en la creaci√≥n de tareas!`, 'success');
                } else {
                    mostrarResultado('‚ö†Ô∏è No se encontraron estudiantes correctamente configurados. Intenta ejecutar la reparaci√≥n nuevamente.', 'warning');
                }
                
            } catch (error) {
                mostrarResultado('‚ùå Error durante la verificaci√≥n: ' + error.message, 'error');
                log('Error: ' + error.message);
            }
        }
        
        function irATareas() {
            window.open('http://localhost:9002/dashboard/tareas', '_blank');
        }

        // Ejecutar diagn√≥stico inicial al cargar
        window.onload = function() {
            setTimeout(ejecutarDiagnostico, 500);
        };
    </script>
</body>
</html>
