/**
 * üî• SINCRONIZACI√ìN DIRECTA Y FORZADA
 * 
 * Este script aplica cambios INMEDIATAMENTE bas√°ndose en los datos
 * mostrados en Gesti√≥n de Usuarios, forzando la actualizaci√≥n completa.
 */

console.log('üî• SINCRONIZACI√ìN DIRECTA Y FORZADA...');
console.log('====================================');

// Funci√≥n para aplicar cambios EXACTOS basados en lo que viste en gesti√≥n
function aplicarCambiosDirectos() {
    try {
        console.log('üéØ APLICANDO CAMBIOS DIRECTOS...');
        console.log('===============================');

        // DATOS EXACTOS seg√∫n la imagen de gesti√≥n de usuarios que mostraste
        const cambiosExactos = [
            { username: 'gustavo', curso: '2do Medio', seccion: 'A' },
            { username: 'max', curso: '2do Medio', seccion: 'A' }
        ];

        console.log('üìã CAMBIOS A APLICAR:');
        cambiosExactos.forEach((cambio, index) => {
            console.log(`${index + 1}. ${cambio.username} ‚Üí ${cambio.curso} - Secci√≥n ${cambio.seccion}`);
        });

        // Leer datos actuales
        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        let courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        let sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        let assignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');

        console.log('\nüîç ESTADO ANTES:');
        cambiosExactos.forEach(cambio => {
            const user = users.find(u => u.username === cambio.username);
            if (user) {
                const cursoActual = user.activeCourses?.[0] || 'Sin curso';
                console.log(`üë§ ${cambio.username}: ${cursoActual}`);
            }
        });

        let cambiosAplicados = 0;

        // Aplicar cada cambio exacto
        cambiosExactos.forEach(cambio => {
            const user = users.find(u => u.username === cambio.username);
            if (!user) {
                console.log(`‚ùå Usuario ${cambio.username} no encontrado`);
                return;
            }

            console.log(`\nüîß Aplicando cambio para ${cambio.username}:`);

            // 1. Buscar o crear curso exacto
            let course = courses.find(c => c.name === cambio.curso);
            if (!course) {
                const courseId = `curso-2do-medio-${Date.now()}`;
                course = {
                    id: courseId,
                    name: cambio.curso,
                    description: `Curso ${cambio.curso}`,
                    createdAt: new Date().toISOString(),
                    source: 'direct-sync'
                };
                courses.push(course);
                console.log(`   ‚ûï Curso creado: ${course.name} (${course.id})`);
            } else {
                console.log(`   ‚úÖ Curso existe: ${course.name} (${course.id})`);
            }

            // 2. Buscar o crear secci√≥n exacta
            let section = sections.find(s => s.courseId === course.id && s.name === cambio.seccion);
            if (!section) {
                const sectionId = `seccion-a-2do-medio-${Date.now()}`;
                section = {
                    id: sectionId,
                    name: cambio.seccion,
                    courseId: course.id,
                    description: `Secci√≥n ${cambio.seccion} de ${course.name}`,
                    createdAt: new Date().toISOString(),
                    source: 'direct-sync'
                };
                sections.push(section);
                console.log(`   ‚ûï Secci√≥n creada: ${section.name} (${section.id})`);
            } else {
                console.log(`   ‚úÖ Secci√≥n existe: ${section.name} (${section.id})`);
            }

            // 3. Actualizar o crear asignaci√≥n
            let assignment = assignments.find(a => a.studentId === user.id);
            if (assignment) {
                assignment.courseId = course.id;
                assignment.sectionId = section.id;
                assignment.updatedAt = new Date().toISOString();
                assignment.source = 'direct-sync';
                console.log(`   üîÑ Asignaci√≥n actualizada`);
            } else {
                assignment = {
                    id: `assignment-${user.id}-${Date.now()}`,
                    studentId: user.id,
                    courseId: course.id,
                    sectionId: section.id,
                    createdAt: new Date().toISOString(),
                    source: 'direct-sync'
                };
                assignments.push(assignment);
                console.log(`   ‚ûï Asignaci√≥n creada`);
            }

            // 4. ACTUALIZAR PERFIL DIRECTAMENTE
            const nuevoCurso = `${course.name} - Secci√≥n ${section.name}`;
            const cursoAnterior = user.activeCourses?.[0] || 'Sin curso';
            
            user.activeCourses = [nuevoCurso];
            user.lastDirectSync = new Date().toISOString();
            user.syncSource = 'direct-management-sync';

            console.log(`   ‚úÖ PERFIL ACTUALIZADO:`);
            console.log(`      Antes: ${cursoAnterior}`);
            console.log(`      Ahora: ${nuevoCurso}`);

            cambiosAplicados++;
        });

        // 5. GUARDAR TODO INMEDIATAMENTE
        console.log('\nüíæ GUARDANDO CAMBIOS INMEDIATAMENTE...');
        localStorage.setItem('smart-student-users', JSON.stringify(users));
        localStorage.setItem('smart-student-courses', JSON.stringify(courses));
        localStorage.setItem('smart-student-sections', JSON.stringify(sections));
        localStorage.setItem('smart-student-student-assignments', JSON.stringify(assignments));

        console.log('‚úÖ Datos guardados en localStorage');

        // 6. VERIFICAR CAMBIOS APLICADOS
        console.log('\nüîç VERIFICACI√ìN FINAL:');
        console.log('======================');
        
        const usersUpdated = JSON.parse(localStorage.getItem('smart-student-users'));
        cambiosExactos.forEach(cambio => {
            const user = usersUpdated.find(u => u.username === cambio.username);
            if (user) {
                const cursoFinal = user.activeCourses?.[0] || 'Sin curso';
                const cursoEsperado = `${cambio.curso} - Secci√≥n ${cambio.seccion}`;
                
                console.log(`üë§ ${cambio.username}:`);
                console.log(`   Esperado: ${cursoEsperado}`);
                console.log(`   Actual: ${cursoFinal}`);
                
                if (cursoFinal === cursoEsperado) {
                    console.log(`   ‚úÖ CORRECTO`);
                } else {
                    console.log(`   ‚ùå INCORRECTO`);
                }
            }
        });

        // 7. DISPARAR EVENTOS M√öLTIPLES PARA FORZAR ACTUALIZACI√ìN
        console.log('\nüì° DISPARANDO EVENTOS DE ACTUALIZACI√ìN...');
        console.log('=========================================');
        
        const eventos = [
            'storage',
            'localStorageUpdate', 
            'profileDataUpdate',
            'userDataChanged',
            'courseAssignmentChanged'
        ];

        eventos.forEach(eventType => {
            const customEvent = new CustomEvent(eventType, {
                detail: {
                    type: 'direct-sync',
                    source: 'management-sync',
                    updatedUsers: cambiosExactos.map(c => c.username),
                    timestamp: new Date().toISOString(),
                    force: true
                }
            });
            window.dispatchEvent(customEvent);
            console.log(`üì° Evento ${eventType} disparado`);
        });

        // 8. FORZAR RECARGA DE P√ÅGINA SI ES NECESARIO
        if (window.location.pathname.includes('/perfil')) {
            console.log('\nüîÑ FORZANDO RECARGA DE P√ÅGINA...');
            console.log('================================');
            console.log('La p√°gina se recargar√° en 2 segundos para mostrar los cambios');
            
            setTimeout(() => {
                console.log('üîÑ Recargando p√°gina...');
                window.location.reload(true); // Recarga forzada
            }, 2000);
        }

        console.log(`\nüéâ SINCRONIZACI√ìN DIRECTA COMPLETADA`);
        console.log(`===================================`);
        console.log(`‚úÖ Cambios aplicados: ${cambiosAplicados}`);
        console.log(`üìä Cursos totales: ${courses.length}`);
        console.log(`üìä Secciones totales: ${sections.length}`);
        console.log(`üìä Asignaciones totales: ${assignments.length}`);

        return cambiosAplicados;

    } catch (error) {
        console.error('‚ùå Error en sincronizaci√≥n directa:', error);
        return 0;
    }
}

// Funci√≥n para verificar inmediatamente despu√©s del cambio
function verificarCambiosInmediatos() {
    try {
        console.log('\nüéØ VERIFICACI√ìN INMEDIATA POST-CAMBIO:');
        console.log('=====================================');

        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        
        ['gustavo', 'max'].forEach(username => {
            const user = users.find(u => u.username === username);
            if (user) {
                const curso = user.activeCourses?.[0] || 'Sin curso';
                console.log(`üë§ ${username.toUpperCase()}: ${curso}`);
                
                if (curso === '2do Medio - Secci√≥n A') {
                    console.log(`   ‚úÖ PERFECTO - Cambio aplicado correctamente`);
                } else {
                    console.log(`   ‚ùå PROBLEMA - Deber√≠a ser "2do Medio - Secci√≥n A"`);
                }
            } else {
                console.log(`‚ùå Usuario ${username} no encontrado`);
            }
        });

    } catch (error) {
        console.error('‚ùå Error en verificaci√≥n:', error);
    }
}

// Funci√≥n para crear bot√≥n de sincronizaci√≥n directa
function crearBotonSincronizacionDirecta() {
    // Remover bot√≥n anterior si existe
    const oldButton = document.getElementById('direct-sync-btn');
    if (oldButton) {
        oldButton.remove();
    }

    const button = document.createElement('button');
    button.id = 'direct-sync-btn';
    button.innerHTML = `üî• SINCRONIZAR AHORA`;
    
    Object.assign(button.style, {
        position: 'fixed',
        top: '20px',
        right: '280px',
        zIndex: '9999',
        backgroundColor: '#ef4444',
        color: 'white',
        border: 'none',
        borderRadius: '8px',
        padding: '12px 20px',
        fontSize: '14px',
        fontWeight: '600',
        cursor: 'pointer',
        boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)',
        fontFamily: 'system-ui, -apple-system, sans-serif'
    });

    button.addEventListener('click', async () => {
        button.innerHTML = 'üîÑ Sincronizando...';
        button.disabled = true;
        
        const cambios = await aplicarCambiosDirectos();
        
        if (cambios > 0) {
            button.innerHTML = '‚úÖ Sincronizado';
            button.style.backgroundColor = '#10b981';
        } else {
            button.innerHTML = '‚ö†Ô∏è Sin cambios';
            button.style.backgroundColor = '#6b7280';
        }

        setTimeout(() => {
            button.innerHTML = 'üî• SINCRONIZAR AHORA';
            button.style.backgroundColor = '#ef4444';
            button.disabled = false;
        }, 3000);
    });

    document.body.appendChild(button);
    console.log('‚úÖ Bot√≥n de sincronizaci√≥n directa creado');
}

// ===============================
// üöÄ EJECUTAR INMEDIATAMENTE
// ===============================

console.log('üöÄ EJECUTANDO SINCRONIZACI√ìN DIRECTA...');

// 1. Aplicar cambios directos inmediatamente
aplicarCambiosDirectos();

// 2. Verificar inmediatamente
verificarCambiosInmediatos();

// 3. Crear bot√≥n para futuras sincronizaciones
crearBotonSincronizacionDirecta();

console.log('\nüí° FUNCIONES DISPONIBLES:');
console.log('=========================');
console.log('- aplicarCambiosDirectos() - Aplicar cambios inmediatamente');
console.log('- verificarCambiosInmediatos() - Verificar estado actual');

console.log('\nüéØ RESULTADO:');
console.log('=============');
console.log('‚úÖ Sincronizaci√≥n directa ejecutada');
console.log('üî• Bot√≥n rojo "SINCRONIZAR AHORA" creado para futuras sincronizaciones');
console.log('üìù Gustavo y Max ahora deber√≠an mostrar "2do Medio - Secci√≥n A"');
