/**
 * SCRIPT DE CORRECCI√ìN: Asignaciones de Estudiantes a Secciones
 * 
 * PROBLEMA: Los estudiantes importados no aparecen al crear tareas porque:
 * 1. No est√°n asignados correctamente a secciones espec√≠ficas
 * 2. Falta la conexi√≥n entre profesores, secciones y estudiantes
 * 3. La tabla smart-student-student-assignments est√° incompleta
 * 
 * SOLUCI√ìN: Este script corrige las asignaciones y crea la estructura necesaria
 */

console.log('üîß INICIANDO CORRECCI√ìN DE ASIGNACIONES ESTUDIANTE-SECCI√ìN...');
console.log('===========================================================');

function corregirAsignacionesEstudianteSeccion() {
    try {
        // 1. Cargar datos actuales
        const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        const teacherAssignments = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
        let studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');

        console.log('üìä ESTADO INICIAL:');
        console.log(`   ‚Ä¢ Usuarios: ${users.length}`);
        console.log(`   ‚Ä¢ Cursos: ${courses.length}`);
        console.log(`   ‚Ä¢ Secciones: ${sections.length}`);
        console.log(`   ‚Ä¢ Asignaciones profesores: ${teacherAssignments.length}`);
        console.log(`   ‚Ä¢ Asignaciones estudiantes: ${studentAssignments.length}`);

        // 2. Obtener estudiantes y profesores
        const estudiantes = users.filter(u => u.role === 'student' || u.role === 'estudiante');
        const profesores = users.filter(u => u.role === 'teacher' || u.role === 'profesor');

        console.log(`\nüë• USUARIOS ENCONTRADOS:`);
        console.log(`   ‚Ä¢ Estudiantes: ${estudiantes.length}`);
        console.log(`   ‚Ä¢ Profesores: ${profesores.length}`);

        // 3. Mostrar datos actuales de los estudiantes
        console.log('\nüìã ESTUDIANTES ACTUALES:');
        estudiantes.forEach((est, index) => {
            console.log(`   ${index + 1}. ${est.username} (@${est.displayName || est.name})`);
            console.log(`      - activeCourses: ${JSON.stringify(est.activeCourses || [])}`);
            console.log(`      - assignedTeacher: ${est.assignedTeacher || 'ninguno'}`);
            console.log(`      - assignedTeachers: ${JSON.stringify(est.assignedTeachers || {})}`);
        });

        // 4. Verificar si ya existen asignaciones correctas
        if (studentAssignments.length > 0) {
            console.log('\nüîç ASIGNACIONES EXISTENTES EN smart-student-student-assignments:');
            studentAssignments.forEach((asig, index) => {
                const estudiante = users.find(u => u.id === asig.studentId);
                const curso = courses.find(c => c.id === asig.courseId);
                const seccion = sections.find(s => s.id === asig.sectionId);
                
                console.log(`   ${index + 1}. ${estudiante?.username || 'Estudiante desconocido'}`);
                console.log(`      - Curso: ${curso?.name || 'Curso desconocido'}`);
                console.log(`      - Secci√≥n: ${seccion?.name || 'Secci√≥n desconocida'}`);
            });
        }

        // 5. Detectar estudiantes sin asignaci√≥n correcta
        const estudiantesSinAsignacion = estudiantes.filter(est => {
            const tieneAsignacion = studentAssignments.some(asig => asig.studentId === est.id);
            return !tieneAsignacion;
        });

        console.log(`\n‚ö†Ô∏è ESTUDIANTES SIN ASIGNACI√ìN CORRECTA: ${estudiantesSinAsignacion.length}`);

        if (estudiantesSinAsignacion.length === 0) {
            console.log('‚úÖ TODOS los estudiantes ya tienen asignaciones correctas.');
            console.log('üí° Si a√∫n no aparecen en el selector, verifica que:');
            console.log('   1. El profesor est√© asignado a las mismas secciones');
            console.log('   2. Las asignaciones de profesores est√©n completas');
            return true;
        }

        // 6. Crear o verificar estructura de cursos y secciones
        console.log('\nüèóÔ∏è VERIFICANDO ESTRUCTURA DE CURSOS Y SECCIONES...');
        
        // Cursos b√°sicos por defecto
        const cursosDefecto = [
            { id: 'curso-4to-basico', name: '4to B√°sico', level: 'b√°sica' },
            { id: 'curso-5to-basico', name: '5to B√°sico', level: 'b√°sica' },
            { id: 'curso-6to-basico', name: '6to B√°sico', level: 'b√°sica' },
            { id: 'curso-1ro-basico', name: '1ro B√°sico', level: 'b√°sica' },
            { id: 'curso-2do-basico', name: '2do B√°sico', level: 'b√°sica' },
            { id: 'curso-3ro-basico', name: '3ro B√°sico', level: 'b√°sica' }
        ];

        // Asegurar que existen los cursos necesarios
        cursosDefecto.forEach(cursoDefault => {
            if (!courses.find(c => c.id === cursoDefault.id)) {
                courses.push({
                    ...cursoDefault,
                    description: `Curso ${cursoDefault.name}`,
                    createdAt: new Date().toISOString(),
                    autoCreated: true
                });
                console.log(`   ‚ûï Curso creado: ${cursoDefault.name}`);
            }
        });

        // Secciones por defecto para cada curso
        const seccionesDefecto = ['A', 'B', 'C'];
        
        cursosDefecto.forEach(curso => {
            seccionesDefecto.forEach(nombreSeccion => {
                const seccionId = `seccion-${curso.name.toLowerCase().replace(/\s+/g, '-')}-${nombreSeccion.toLowerCase()}`;
                
                if (!sections.find(s => s.id === seccionId)) {
                    sections.push({
                        id: seccionId,
                        name: nombreSeccion,
                        courseId: curso.id,
                        description: `Secci√≥n ${nombreSeccion} de ${curso.name}`,
                        maxStudents: 30,
                        studentCount: 0,
                        createdAt: new Date().toISOString(),
                        autoCreated: true
                    });
                    console.log(`   ‚ûï Secci√≥n creada: ${curso.name} - Secci√≥n ${nombreSeccion}`);
                }
            });
        });

        // 7. Asignar estudiantes a secciones bas√°ndose en sus activeCourses actuales
        console.log('\nüîÑ CREANDO ASIGNACIONES DE ESTUDIANTES...');
        
        let asignacionesCreadas = 0;
        
        estudiantesSinAsignacion.forEach(estudiante => {
            console.log(`\n   üéì Procesando: ${estudiante.username}`);
            
            // Intentar obtener curso de activeCourses
            let cursoAsignado = null;
            let seccionAsignada = null;
            
            if (estudiante.activeCourses && estudiante.activeCourses.length > 0) {
                const cursoPerfil = estudiante.activeCourses[0];
                console.log(`      - Curso en perfil: "${cursoPerfil}"`);
                
                // Parsear formato "4to B√°sico - Secci√≥n A"
                const match = cursoPerfil.match(/^(.+?)\s*-\s*Secci√≥n\s*([A-Z])$/i);
                if (match) {
                    const nombreCurso = match[1].trim();
                    const nombreSeccion = match[2].toUpperCase();
                    
                    console.log(`      - Parseado: Curso="${nombreCurso}", Secci√≥n="${nombreSeccion}"`);
                    
                    // Buscar curso correspondiente
                    cursoAsignado = courses.find(c => c.name === nombreCurso);
                    if (cursoAsignado) {
                        // Buscar secci√≥n correspondiente
                        seccionAsignada = sections.find(s => 
                            s.courseId === cursoAsignado.id && s.name === nombreSeccion
                        );
                    }
                } else {
                    // Si no tiene formato de secci√≥n, asumir Secci√≥n A
                    const nombreCurso = cursoPerfil.trim();
                    cursoAsignado = courses.find(c => c.name === nombreCurso);
                    if (cursoAsignado) {
                        seccionAsignada = sections.find(s => 
                            s.courseId === cursoAsignado.id && s.name === 'A'
                        );
                    }
                }
            }
            
            // Si no se pudo determinar, asignar a 4to B√°sico Secci√≥n A por defecto
            if (!cursoAsignado || !seccionAsignada) {
                console.log(`      ‚ö†Ô∏è No se pudo determinar curso/secci√≥n, asignando a 4to B√°sico - Secci√≥n A`);
                cursoAsignado = courses.find(c => c.name === '4to B√°sico');
                seccionAsignada = sections.find(s => 
                    s.courseId === cursoAsignado?.id && s.name === 'A'
                );
            }
            
            if (cursoAsignado && seccionAsignada) {
                // Crear asignaci√≥n en student-assignments
                const nuevaAsignacion = {
                    id: `student-assign-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    studentId: estudiante.id,
                    courseId: cursoAsignado.id,
                    sectionId: seccionAsignada.id,
                    createdAt: new Date().toISOString(),
                    autoAssigned: true,
                    source: 'fix-script'
                };
                
                studentAssignments.push(nuevaAsignacion);
                
                // Actualizar perfil del estudiante
                const cursoCompleto = `${cursoAsignado.name} - Secci√≥n ${seccionAsignada.name}`;
                estudiante.activeCourses = [cursoCompleto];
                
                // Actualizar contador de estudiantes en la secci√≥n
                const seccionIndex = sections.findIndex(s => s.id === seccionAsignada.id);
                if (seccionIndex >= 0) {
                    sections[seccionIndex].studentCount = (sections[seccionIndex].studentCount || 0) + 1;
                }
                
                console.log(`      ‚úÖ Asignado a: ${cursoCompleto}`);
                asignacionesCreadas++;
            } else {
                console.log(`      ‚ùå Error: No se pudo crear asignaci√≥n`);
            }
        });

        // 8. Verificar y crear asignaciones de profesores si es necesario
        console.log('\nüë®‚Äçüè´ VERIFICANDO ASIGNACIONES DE PROFESORES...');
        
        profesores.forEach(profesor => {
            console.log(`\n   üéì Profesor: ${profesor.username} (${profesor.displayName || profesor.name})`);
            
            // Verificar si ya tiene asignaciones
            const asignacionesProfesor = teacherAssignments.filter(a => 
                a.teacherId === profesor.id || a.teacherUsername === profesor.username
            );
            
            console.log(`      - Asignaciones existentes: ${asignacionesProfesor.length}`);
            
            if (asignacionesProfesor.length === 0) {
                console.log(`      ‚ö†Ô∏è Profesor sin asignaciones, creando asignaciones b√°sicas...`);
                
                // Crear asignaciones b√°sicas para este profesor
                // Asignar a 4to y 5to B√°sico por defecto
                const cursosProfesor = ['4to B√°sico', '5to B√°sico'];
                const materiasBasicas = ['Matem√°ticas', 'Lenguaje y Comunicaci√≥n', 'Ciencias Naturales'];
                
                cursosProfesor.forEach(nombreCurso => {
                    const curso = courses.find(c => c.name === nombreCurso);
                    if (curso) {
                        // Asignar a secci√≥n A
                        const seccion = sections.find(s => 
                            s.courseId === curso.id && s.name === 'A'
                        );
                        
                        if (seccion) {
                            materiasBasicas.forEach(materia => {
                                const nuevaAsignacionProfesor = {
                                    id: `teacher-assign-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                    teacherId: profesor.id,
                                    teacherUsername: profesor.username,
                                    sectionId: seccion.id,
                                    subjectName: materia,
                                    assignedAt: new Date().toISOString(),
                                    autoAssigned: true
                                };
                                
                                teacherAssignments.push(nuevaAsignacionProfesor);
                                console.log(`         ‚ûï ${materia} en ${nombreCurso} - Secci√≥n A`);
                            });
                        }
                    }
                });
            }
        });

        // 9. Guardar todos los cambios
        console.log('\nüíæ GUARDANDO CAMBIOS...');
        
        localStorage.setItem('smart-student-users', JSON.stringify(users));
        localStorage.setItem('smart-student-courses', JSON.stringify(courses));
        localStorage.setItem('smart-student-sections', JSON.stringify(sections));
        localStorage.setItem('smart-student-student-assignments', JSON.stringify(studentAssignments));
        localStorage.setItem('smart-student-teacher-assignments', JSON.stringify(teacherAssignments));

        // 10. Resumen final
        console.log('\nüéâ CORRECCI√ìN COMPLETADA EXITOSAMENTE!');
        console.log('=====================================');
        console.log(`‚úÖ Asignaciones de estudiantes creadas: ${asignacionesCreadas}`);
        console.log(`üìö Cursos en sistema: ${courses.length}`);
        console.log(`üè´ Secciones en sistema: ${sections.length}`);
        console.log(`üë• Asignaciones estudiante-secci√≥n: ${studentAssignments.length}`);
        console.log(`üë®‚Äçüè´ Asignaciones profesor-secci√≥n: ${teacherAssignments.length}`);

        console.log('\nüìä VERIFICACI√ìN FINAL:');
        const estudiantesConAsignacion = estudiantes.filter(est => 
            studentAssignments.some(asig => asig.studentId === est.id)
        );
        console.log(`   ‚Ä¢ Estudiantes con asignaci√≥n: ${estudiantesConAsignacion.length}/${estudiantes.length}`);

        console.log('\nüí° PR√ìXIMOS PASOS:');
        console.log('==================');
        console.log('1. üîÑ Recarga la p√°gina completamente (Ctrl+F5)');
        console.log('2. üë®‚Äçüè´ Haz login como profesor');
        console.log('3. üìù Ve a Tareas > Nueva Tarea');
        console.log('4. üéØ Selecciona un curso y "Estudiantes espec√≠ficos"');
        console.log('5. ‚úÖ Ahora deber√≠an aparecer los estudiantes de esa secci√≥n');

        return true;

    } catch (error) {
        console.error('‚ùå ERROR durante la correcci√≥n:', error);
        console.log('üîç Por favor revisa la consola para m√°s detalles');
        return false;
    }
}

// Funci√≥n para verificar el resultado
function verificarAsignaciones() {
    console.log('\nüîç VERIFICANDO ASIGNACIONES DESPU√âS DE LA CORRECCI√ìN...');
    console.log('=====================================================');
    
    const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
    const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
    const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
    const studentAssignments = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');
    const teacherAssignments = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
    
    const estudiantes = users.filter(u => u.role === 'student' || u.role === 'estudiante');
    
    console.log('üìä ESTADO ACTUAL:');
    estudiantes.forEach((est, index) => {
        const asignacion = studentAssignments.find(a => a.studentId === est.id);
        
        console.log(`\n${index + 1}. ${est.username} (@${est.displayName || est.name})`);
        
        if (asignacion) {
            const curso = courses.find(c => c.id === asignacion.courseId);
            const seccion = sections.find(s => s.id === asignacion.sectionId);
            
            console.log(`   ‚úÖ Asignaci√≥n oficial: ${curso?.name} - Secci√≥n ${seccion?.name}`);
            console.log(`   üìã Perfil muestra: ${JSON.stringify(est.activeCourses)}`);
            
            // Verificar si hay profesores asignados a esta secci√≥n
            const profesoresEnSeccion = teacherAssignments.filter(ta => ta.sectionId === asignacion.sectionId);
            console.log(`   üë®‚Äçüè´ Profesores en esta secci√≥n: ${profesoresEnSeccion.length}`);
            
        } else {
            console.log(`   ‚ùå Sin asignaci√≥n oficial`);
            console.log(`   üìã Perfil muestra: ${JSON.stringify(est.activeCourses)}`);
        }
    });
    
    // Mostrar resumen por secci√≥n
    console.log('\nüìä RESUMEN POR SECCI√ìN:');
    sections.forEach(seccion => {
        const curso = courses.find(c => c.id === seccion.courseId);
        const estudiantesEnSeccion = studentAssignments.filter(sa => sa.sectionId === seccion.id);
        const profesoresEnSeccion = teacherAssignments.filter(ta => ta.sectionId === seccion.id);
        
        console.log(`\nüè´ ${curso?.name} - Secci√≥n ${seccion.name}:`);
        console.log(`   üë• Estudiantes: ${estudiantesEnSeccion.length}`);
        console.log(`   üë®‚Äçüè´ Profesores: ${profesoresEnSeccion.length}`);
        
        if (profesoresEnSeccion.length > 0) {
            console.log(`   üìö Materias cubiertas: ${profesoresEnSeccion.map(p => p.subjectName).join(', ')}`);
        }
    });
}

// Ejecutar la correcci√≥n autom√°ticamente
console.log('üöÄ Ejecutando correcci√≥n autom√°tica...\n');
const resultado = corregirAsignacionesEstudianteSeccion();

if (resultado) {
    console.log('\n‚è±Ô∏è Esperando 2 segundos antes de la verificaci√≥n...');
    setTimeout(() => {
        verificarAsignaciones();
        
        console.log('\nüéØ COMANDOS DISPONIBLES:');
        console.log('========================');
        console.log('‚Ä¢ corregirAsignacionesEstudianteSeccion() - Ejecutar correcci√≥n nuevamente');
        console.log('‚Ä¢ verificarAsignaciones() - Verificar estado actual');
        console.log('‚Ä¢ localStorage.clear() - Limpiar todo (¬°CUIDADO!)');
        
    }, 2000);
}

// Hacer las funciones disponibles globalmente
window.corregirAsignacionesEstudianteSeccion = corregirAsignacionesEstudianteSeccion;
window.verificarAsignaciones = verificarAsignaciones;
