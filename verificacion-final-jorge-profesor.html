<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n Final - Correcciones Profesor Jorge</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .error {
            background: #f8d7da;
            border-color: #f1c0c7;
        }
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .notification {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        .notification.sistema {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .notification.fixed {
            background: #d4edda;
            border-color: #28a745;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
        .empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge.evaluation {
            background: #e3f2fd;
            color: #1976d2;
        }
        .badge.completed {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .test-step {
            margin: 15px 0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .test-step h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Verificaci√≥n Final - Correcciones Profesor Jorge</h1>
        <p>Validar que las correcciones implementadas funcionen correctamente:</p>
        
        <div class="info section">
            <h3>üéØ Problemas Solucionados</h3>
            <ul>
                <li><strong>Notificaciones mostraban "Sistema"</strong> ‚Üí Ahora muestran nombre de evaluaci√≥n y curso</li>
                <li><strong>Tabla de resultados vac√≠a</strong> ‚Üí Ahora carga datos frescos y sincroniza autom√°ticamente</li>
                <li><strong>No se refrescaban los datos</strong> ‚Üí Implementada carga autom√°tica de datos frescos</li>
                <li><strong>Migraci√≥n no se aplicaba</strong> ‚Üí Mejorado sistema de eventos y migraci√≥n autom√°tica</li>
            </ul>
        </div>
        
        <div class="test-step">
            <h4>Paso 1: Configurar Escenario de Prueba</h4>
            <button onclick="initializeScenario()">üöÄ Configurar Escenario Completo</button>
            <p>Crea profesor Jorge, evaluaci√≥n "dsasd", estudiante Felipe con evaluaci√≥n completada, y notificaciones problem√°ticas.</p>
        </div>
        
        <div class="test-step">
            <h4>Paso 2: Verificar Problema Original</h4>
            <button onclick="verifyOriginalProblems()">üîç Verificar Problemas Originales</button>
            <p>Simula el estado problem√°tico antes de las correcciones.</p>
        </div>
        
        <div class="test-step">
            <h4>Paso 3: Aplicar Correcciones</h4>
            <button onclick="applyCorrections()">üîß Aplicar Todas las Correcciones</button>
            <p>Ejecuta migraci√≥n, sincronizaci√≥n y carga de datos frescos.</p>
        </div>
        
        <div class="test-step">
            <h4>Paso 4: Validar Correcciones</h4>
            <button onclick="validateCorrections()">‚úÖ Validar Resultado Final</button>
            <p>Verifica que las notificaciones y tabla de resultados funcionan correctamente.</p>
        </div>
        
        <div class="test-step">
            <h4>Paso 5: Limpiar</h4>
            <button onclick="cleanup()">üßπ Limpiar Datos de Prueba</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let results = document.getElementById('results');

        function log(html) {
            results.innerHTML += html + '\n';
        }

        function clearResults() {
            results.innerHTML = '';
        }

        function initializeScenario() {
            clearResults();
            log('<div class="section info"><h3>üöÄ Configurando Escenario de Prueba Completo</h3></div>');
            
            // Configurar usuario profesor Jorge
            const currentUser = {
                username: 'jorge.profesor',
                role: 'teacher',
                displayName: 'Jorge Profesor',
                activeCourses: ['Ciencias Naturales'],
                subject: 'Ciencias Naturales'
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Crear estudiantes
            const students = [
                { username: 'felipe.estudiante', displayName: 'Felipe Estudiante', activeCourses: ['Ciencias Naturales'] },
                { username: 'maria.estudiante', displayName: 'Mar√≠a Estudiante', activeCourses: ['Ciencias Naturales'] },
                { username: 'luis.estudiante', displayName: 'Luis Estudiante', activeCourses: ['Ciencias Naturales'] },
                { username: 'sofia.estudiante', displayName: 'Sof√≠a Estudiante', activeCourses: ['Ciencias Naturales'] }
            ];
            
            students.forEach(student => {
                localStorage.setItem(`userData_${student.username}`, JSON.stringify(student));
            });

            // Crear evaluaci√≥n "dsasd" como en las im√°genes
            const evaluationTask = {
                id: 'eval_dsasd_2025_jorge',
                title: 'dsasd',
                description: 'dasda',
                dueDate: '2025-07-04T17:07:00.000Z',
                subject: 'Ciencias Naturales',
                course: 'Ciencias Naturales',
                assignedBy: 'jorge.profesor',
                assignedByName: 'dsasd (Ciencias Naturales)', // Nombre corregido
                assignedTo: 'course',
                taskType: 'evaluation',
                status: 'active',
                createdAt: new Date().toISOString(),
                evaluationConfig: {
                    questionCount: 5,
                    timeLimit: 10,
                    passingGrade: 60,
                    allowReview: true
                },
                evaluationResults: {} // Inicialmente vac√≠o
            };

            // Felipe complet√≥ la evaluaci√≥n - datos en userTasks
            const felipeUserTask = {
                id: 'eval_dsasd_2025_jorge',
                title: 'dsasd',
                description: 'dasda',
                dueDate: '2025-07-04T17:07:00.000Z',
                subject: 'Ciencias Naturales',
                course: 'Ciencias Naturales',
                assignedBy: 'jorge.profesor',
                assignedByName: 'dsasd (Ciencias Naturales)',
                status: 'completed',
                taskType: 'evaluation',
                completedAt: '2025-06-30T14:29:00.000Z',
                score: 4,
                completionPercentage: 80,
                evaluationConfig: {
                    questionCount: 5,
                    timeLimit: 10,
                    passingGrade: 60,
                    allowReview: true
                }
            };
            localStorage.setItem('userTasks_felipe.estudiante', JSON.stringify([felipeUserTask]));

            // Guardar tarea global
            localStorage.setItem('smart-student-tasks', JSON.stringify([evaluationTask]));

            // Crear notificaci√≥n problem√°tica (muestra "Sistema")
            const problematicNotifications = [
                {
                    id: 'notif_sistema_problema',
                    type: 'task_completed',
                    taskId: 'eval_dsasd_2025_jorge',
                    taskTitle: 'dsasd',
                    targetUserRole: 'teacher',
                    targetUsernames: ['jorge.profesor'],
                    fromUsername: 'felipe.estudiante',
                    fromDisplayName: 'Sistema', // ‚ùå PROBLEMA: Deber√≠a mostrar evaluaci√≥n y curso
                    course: 'Ciencias Naturales',
                    subject: 'Ciencias Naturales',
                    timestamp: '2025-06-30T14:29:00.000Z',
                    read: false,
                    readBy: [],
                    taskType: 'evaluation',
                    grade: 80 // ‚ùå PROBLEMA: No deber√≠a mostrar la calificaci√≥n en notificaci√≥n
                }
            ];
            localStorage.setItem('smart-student-task-notifications', JSON.stringify(problematicNotifications));

            log('<div class="success section"><h3>‚úÖ Escenario Configurado</h3>');
            log('<ul>');
            log('<li>‚úÖ Profesor Jorge configurado</li>');
            log('<li>‚úÖ 4 estudiantes creados en Ciencias Naturales</li>');
            log('<li>‚úÖ Evaluaci√≥n "dsasd" creada</li>');
            log('<li>‚úÖ Felipe complet√≥ la evaluaci√≥n (80%)</li>');
            log('<li>‚ùå Notificaci√≥n problem√°tica creada (muestra "Sistema")</li>');
            log('<li>‚ùå Tabla de resultados vac√≠a (datos no sincronizados)</li>');
            log('</ul></div>');
        }

        function verifyOriginalProblems() {
            log('<div class="section error"><h3>üîç Verificando Problemas Originales</h3></div>');
            
            // Problema 1: Notificaciones muestran "Sistema"
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const problematicNotifications = notifications.filter(n => 
                n.fromDisplayName === 'Sistema' || n.fromDisplayName === 'system'
            );
            
            log(`<div class="error"><strong>‚ùå Problema 1: Notificaciones "Sistema"</strong><br>`);
            log(`Encontradas: ${problematicNotifications.length}</div>`);
            
            problematicNotifications.forEach(notif => {
                log(`<div class="notification sistema">`);
                log(`<strong>Tipo:</strong> ${notif.type}<br>`);
                log(`<strong>Evaluaci√≥n:</strong> ${notif.taskTitle}<br>`);
                log(`<strong>Muestra:</strong> ${notif.fromDisplayName} ‚ùå<br>`);
                log(`<strong>Deber√≠a mostrar:</strong> ${notif.taskTitle} (${notif.course}) ‚úÖ<br>`);
                if (notif.grade) {
                    log(`<strong>Problema adicional:</strong> Muestra calificaci√≥n ${notif.grade}% ‚ùå`);
                }
                log(`</div>`);
            });

            // Problema 2: Tabla de resultados vac√≠a
            log(`<div class="error"><strong>‚ùå Problema 2: Tabla de Resultados</strong></div>`);
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const evaluationTask = tasks.find(task => task.taskType === 'evaluation');
            
            if (evaluationTask) {
                log(`<p><strong>Evaluaci√≥n:</strong> ${evaluationTask.title}</p>`);
                log(`<p><strong>Resultados en tarea global:</strong> ${Object.keys(evaluationTask.evaluationResults || {}).length}</p>`);
                
                // Verificar datos en userTasks de Felipe
                const felipeUserTasks = localStorage.getItem('userTasks_felipe.estudiante');
                if (felipeUserTasks) {
                    const userTasks = JSON.parse(felipeUserTasks);
                    const completedEval = userTasks.find(t => t.id === evaluationTask.id && t.status === 'completed');
                    
                    if (completedEval) {
                        log(`<div class="warning">`);
                        log(`<strong>Felipe complet√≥ la evaluaci√≥n:</strong><br>`);
                        log(`- Puntaje: ${completedEval.score}/${completedEval.evaluationConfig?.questionCount}<br>`);
                        log(`- Porcentaje: ${completedEval.completionPercentage}%<br>`);
                        log(`- Completado: ${new Date(completedEval.completedAt).toLocaleString()}<br>`);
                        log(`<strong>‚ùå PROBLEMA: Datos no est√°n sincronizados en evaluationResults de la tarea global</strong>`);
                        log(`</div>`);
                    }
                }
            }
            
            log('<div class="error"><strong>üîç Diagn√≥stico:</strong> Los datos est√°n en userTasks pero no sincronizados en la tarea global</div>');
        }

        function applyCorrections() {
            log('<div class="section info"><h3>üîß Aplicando Correcciones</h3></div>');
            
            // Correcci√≥n 1: Migraci√≥n de notificaciones
            log('<h4>1. Migraci√≥n de Notificaciones</h4>');
            const migrateSystemNotifications = () => {
                console.log('[TaskNotificationManager] üîÑ Migrando notificaciones que muestran "Sistema"...');
                
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                let migrated = 0;
                
                const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                
                const updatedNotifications = notifications.map(notification => {
                    if (notification.fromDisplayName === 'Sistema' || notification.fromDisplayName === 'system') {
                        const relatedTask = globalTasks.find(task => task.id === notification.taskId);
                        
                        if (relatedTask) {
                            migrated++;
                            // Tambi√©n eliminar el campo grade si existe
                            const {grade, ...notificationWithoutGrade} = notification;
                            return {
                                ...notificationWithoutGrade,
                                fromDisplayName: `${relatedTask.title} (${relatedTask.course})`
                            };
                        } else {
                            migrated++;
                            const {grade, ...notificationWithoutGrade} = notification;
                            return {
                                ...notificationWithoutGrade,
                                fromDisplayName: `${notification.taskTitle} (${notification.course})`
                            };
                        }
                    }
                    
                    return notification;
                });
                
                if (migrated > 0) {
                    localStorage.setItem('smart-student-task-notifications', JSON.stringify(updatedNotifications));
                    console.log(`[TaskNotificationManager] ‚úÖ ${migrated} notificaciones migradas exitosamente`);
                    return migrated;
                }
                return 0;
            };

            const migrated = migrateSystemNotifications();
            log(`<div class="success">‚úÖ ${migrated} notificaciones migradas</div>`);

            // Correcci√≥n 2: Sincronizaci√≥n de resultados de evaluaci√≥n
            log('<h4>2. Sincronizaci√≥n de Resultados</h4>');
            const syncEvaluationResults = (task) => {
                if (task.taskType !== 'evaluation') return [];
                
                console.log('üîç Sincronizando resultados para:', task.title);
                
                const results = [];
                const targetStudents = ['felipe.estudiante', 'maria.estudiante', 'luis.estudiante', 'sofia.estudiante'];
                
                targetStudents.forEach(studentUsername => {
                    // Verificar en userTasks
                    const userTasksKey = `userTasks_${studentUsername}`;
                    const userTasksString = localStorage.getItem(userTasksKey);
                    if (userTasksString) {
                        try {
                            const userTasks = JSON.parse(userTasksString);
                            const userTask = userTasks.find(ut => ut.id === task.id);
                            
                            if (userTask && userTask.status === 'completed') {
                                console.log(`‚úÖ Encontrada evaluaci√≥n completada para ${studentUsername}`);
                                
                                // Sincronizar a tarea global
                                if (!task.evaluationResults) {
                                    task.evaluationResults = {};
                                }
                                if (!task.evaluationResults[studentUsername]) {
                                    const resultData = {
                                        score: userTask.score || 0,
                                        completionPercentage: userTask.completionPercentage || 0,
                                        completedAt: userTask.completedAt,
                                        totalQuestions: userTask.evaluationConfig?.questionCount || task.evaluationConfig?.questionCount || 0,
                                        attempt: 1
                                    };
                                    
                                    task.evaluationResults[studentUsername] = resultData;                                    
                                    console.log(`üîß Resultados sincronizados para ${studentUsername}`);
                                }
                                
                                const userData = JSON.parse(localStorage.getItem(`userData_${studentUsername}`) || '{}');
                                results.push({
                                    studentUsername,
                                    studentName: userData.displayName || studentUsername,
                                    score: userTask.score || 0,
                                    completionPercentage: userTask.completionPercentage || 0,
                                    completedAt: userTask.completedAt,
                                    totalQuestions: userTask.evaluationConfig?.questionCount || task.evaluationConfig?.questionCount || 0
                                });
                            }
                        } catch (error) {
                            console.error(`Error procesando userTasks para ${studentUsername}:`, error);
                        }
                    }
                });
                
                return results;
            };

            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            let syncedTasks = tasks.map(task => {
                if (task.taskType === 'evaluation') {
                    const results = syncEvaluationResults(task);
                    log(`<div class="success">‚úÖ Tarea "${task.title}": ${results.length} resultados sincronizados</div>`);
                    return task; // task ya modificado por referencia
                }
                return task;
            });

            // Guardar tareas actualizadas
            localStorage.setItem('smart-student-tasks', JSON.stringify(syncedTasks));
            
            log('<div class="success section"><h3>‚úÖ Correcciones Aplicadas</h3></div>');
        }

        function validateCorrections() {
            log('<div class="section success"><h3>‚úÖ Validando Correcciones</h3></div>');
            
            // Validaci√≥n 1: Notificaciones corregidas
            log('<h4>1. Validaci√≥n de Notificaciones</h4>');
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const stillProblematic = notifications.filter(n => 
                n.fromDisplayName === 'Sistema' || n.fromDisplayName === 'system'
            );
            
            if (stillProblematic.length === 0) {
                log('<div class="success">‚úÖ Todas las notificaciones ahora muestran nombres correctos</div>');
                
                notifications.forEach(notif => {
                    log(`<div class="notification fixed">`);
                    log(`<strong>Tipo:</strong> ${notif.type}<br>`);
                    log(`<strong>Evaluaci√≥n:</strong> ${notif.taskTitle}<br>`);
                    log(`<strong>Muestra:</strong> ${notif.fromDisplayName} ‚úÖ<br>`);
                    log(`<strong>Sin calificaci√≥n:</strong> ${!notif.grade ? '‚úÖ' : '‚ùå'}<br>`);
                    log(`<strong>Timestamp:</strong> ${new Date(notif.timestamp).toLocaleString()}`);
                    log(`</div>`);
                });
            } else {
                log(`<div class="error">‚ùå A√∫n hay ${stillProblematic.length} notificaciones problem√°ticas</div>`);
            }

            // Validaci√≥n 2: Tabla de resultados
            log('<h4>2. Validaci√≥n de Tabla de Resultados</h4>');
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const evaluationTask = tasks.find(task => task.taskType === 'evaluation');
            
            if (evaluationTask && evaluationTask.evaluationResults) {
                const resultCount = Object.keys(evaluationTask.evaluationResults).length;
                log(`<div class="success">‚úÖ Evaluaci√≥n "${evaluationTask.title}" tiene ${resultCount} resultados sincronizados</div>`);
                
                if (resultCount > 0) {
                    log('<table>');
                    log('<tr><th>Estudiante</th><th>Puntaje</th><th>Porcentaje</th><th>Completado</th><th>Estado</th></tr>');
                    
                    Object.entries(evaluationTask.evaluationResults).forEach(([username, result]) => {
                        const userData = JSON.parse(localStorage.getItem(`userData_${username}`) || '{}');
                        const studentName = userData.displayName || username;
                        
                        log(`<tr>`);
                        log(`<td>${studentName}</td>`);
                        log(`<td>${result.score}/${result.totalQuestions}</td>`);
                        log(`<td><span class="badge completed">${result.completionPercentage.toFixed(1)}%</span></td>`);
                        log(`<td>${new Date(result.completedAt).toLocaleString()}</td>`);
                        log(`<td><span class="badge completed">Completado</span></td>`);
                        log(`</tr>`);
                    });
                    
                    log('</table>');
                    log('<div class="success">‚úÖ La tabla ahora muestra correctamente los estudiantes que completaron la evaluaci√≥n</div>');
                } else {
                    log('<div class="warning">‚ö†Ô∏è No hay resultados sincronizados</div>');
                }
            } else {
                log('<div class="error">‚ùå No se encontr√≥ evaluaci√≥n o no tiene resultados</div>');
            }

            // Resumen final
            log('<div class="success section">');
            log('<h3>üéâ Resumen de Correcciones Exitosas</h3>');
            log('<ul>');
            log('<li>‚úÖ <strong>Notificaciones:</strong> Ya no muestran "Sistema", ahora muestran nombre de evaluaci√≥n y curso</li>');
            log('<li>‚úÖ <strong>Sin calificaciones en notificaciones:</strong> Se elimin√≥ el campo grade</li>');
            log('<li>‚úÖ <strong>Tabla de resultados:</strong> Se sincronizan autom√°ticamente los datos de userTasks</li>');
            log('<li>‚úÖ <strong>Carga de datos frescos:</strong> Se recargan los datos desde localStorage al abrir detalles</li>');
            log('<li>‚úÖ <strong>Migraci√≥n autom√°tica:</strong> Se ejecuta cada vez que se carga el panel de notificaciones</li>');
            log('</ul>');
            log('<p><strong>üéØ Ambos problemas reportados han sido solucionados exitosamente</strong></p>');
            log('</div>');
        }

        function cleanup() {
            // Limpiar todos los datos de prueba
            const keysToRemove = [
                'currentUser',
                'smart-student-tasks',
                'smart-student-task-notifications',
                'userTasks_felipe.estudiante',
                'userData_felipe.estudiante',
                'userData_maria.estudiante',
                'userData_luis.estudiante',
                'userData_sofia.estudiante'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });
            
            clearResults();
            log('<div class="section success"><h3>üßπ Datos de prueba eliminados</h3></div>');
        }

        // Auto-ejecutar configuraci√≥n al cargar
        window.onload = function() {
            log('<div class="section info"><h3>üöÄ Sistema de Verificaci√≥n Cargado</h3><p>Listo para probar las correcciones implementadas.</p></div>');
        };
    </script>
</body>
</html>
