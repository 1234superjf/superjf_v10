<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug - Formato Notificaciones Estudiante vs Profesor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .student { border-left: 4px solid #2196F3; }
        .teacher { border-left: 4px solid #FF9800; }
        .notification-item {
            background: #f9f9f9;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ccc;
        }
        .title { font-weight: bold; color: #333; }
        .subtitle { font-size: 0.9em; color: #666; }
        .id { font-family: monospace; font-size: 0.8em; color: #999; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .error { color: #f44336; }
        .success { color: #4CAF50; }
        .warning { color: #FF9800; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Formato Notificaciones Estudiante vs Profesor</h1>
        <p>Comparando c√≥mo se muestran las notificaciones en ambos roles</p>
        
        <button onclick="analyzeNotifications()">üîç Analizar Notificaciones</button>
        <button onclick="fixNotificationFormat()">üîß Corregir Formato</button>
        <button onclick="testNotificationDisplay()">üì± Probar Display</button>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `notification-item ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function analyzeNotifications() {
            document.getElementById('results').innerHTML = '';
            log('üîç Analizando notificaciones almacenadas...', 'info');

            try {
                // Obtener datos del localStorage
                const notifications = JSON.parse(localStorage.getItem('smart-student-notifications') || '[]');
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const currentUser = JSON.parse(localStorage.getItem('smart-student-user') || '{}');

                log(`üìä Usuario actual: ${currentUser.username} (${currentUser.role})`, 'info');
                log(`üìä Total notificaciones: ${notifications.length}`, 'info');
                log(`üìä Total tareas: ${tasks.length}`, 'info');

                // Filtrar notificaciones de tareas
                const taskNotifications = notifications.filter(n => 
                    n.type === 'new_task' || n.type === 'task_created'
                );

                log(`üìã Notificaciones de tareas: ${taskNotifications.length}`, 'info');

                taskNotifications.forEach((notif, index) => {
                    log(`<div class="debug-section">
                        <strong>${index + 1}. Notificaci√≥n ID: ${notif.id}</strong><br>
                        <div class="title">T√≠tulo: ${notif.taskTitle || '‚ùå NO TIENE T√çTULO'}</div>
                        <div class="subtitle">TaskId: ${notif.taskId}</div>
                        <div class="subtitle">Para: ${notif.toUsername}</div>
                        <div class="subtitle">Tipo: ${notif.type}</div>
                        <div class="subtitle">Curso: ${notif.course}</div>
                        <div class="subtitle">Materia: ${notif.subject}</div>
                        <div class="subtitle">Timestamp: ${new Date(notif.timestamp).toLocaleString()}</div>
                    </div>`, 'info');

                    // Buscar la tarea correspondiente
                    const task = tasks.find(t => t.id === notif.taskId);
                    if (task) {
                        log(`üìù Tarea encontrada: "${task.title}"`, 'success');
                    } else {
                        log(`‚ùå Tarea NO encontrada para taskId: ${notif.taskId}`, 'error');
                    }
                });

            } catch (error) {
                log(`‚ùå Error al analizar: ${error.message}`, 'error');
            }
        }

        function fixNotificationFormat() {
            log('üîß Iniciando correcci√≥n de formato...', 'info');

            try {
                const notifications = JSON.parse(localStorage.getItem('smart-student-notifications') || '[]');
                const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');

                let correctedCount = 0;

                const correctedNotifications = notifications.map(notif => {
                    if ((notif.type === 'new_task' || notif.type === 'task_created') && !notif.taskTitle) {
                        // Buscar la tarea correspondiente
                        const task = tasks.find(t => t.id === notif.taskId);
                        if (task) {
                            notif.taskTitle = task.title;
                            correctedCount++;
                            log(`‚úÖ Corregido: ${notif.id} -> "${task.title}"`, 'success');
                        } else {
                            log(`‚ö†Ô∏è No se encontr√≥ tarea para: ${notif.taskId}`, 'warning');
                        }
                    }
                    return notif;
                });

                // Guardar las notificaciones corregidas
                localStorage.setItem('smart-student-notifications', JSON.stringify(correctedNotifications));

                log(`üéâ Correcci√≥n completada: ${correctedCount} notificaciones actualizadas`, 'success');

            } catch (error) {
                log(`‚ùå Error en la correcci√≥n: ${error.message}`, 'error');
            }
        }

        function testNotificationDisplay() {
            log('üì± Probando formato de display...', 'info');

            // Simular datos como en las im√°genes
            const mockNotifications = [
                {
                    id: 'test-1',
                    taskTitle: 'asdas',
                    taskId: '9077a78d-c290-45f9-b549-6e570f88282d',
                    type: 'new_task',
                    course: '9077a79d-c290-45f9-b549-6e57df8828d2-d326c181-fa30-4c50-ab68-efa085a3ffd3',
                    subject: 'Matem√°ticas',
                    timestamp: new Date().toISOString(),
                    toUsername: 'felipe'
                }
            ];

            // Funci√≥n para obtener abreviaci√≥n del curso
            function getCourseAbbreviation(subject) {
                const abbreviations = {
                    'Matem√°ticas': 'MAT',
                    'Lenguaje': 'LEN',
                    'Ciencias': 'CIE',
                    'Historia': 'HIS',
                    'Ingl√©s': 'ING'
                };
                return abbreviations[subject] || subject.substr(0, 3).toUpperCase();
            }

            // Funci√≥n para obtener nombre del curso
            function getCourseNameById(courseId) {
                // Simulando la funci√≥n real
                return '4to B√°sico';
            }

            // Funci√≥n para formatear fecha
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                }) + ', ' + date.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            log('<div class="debug-section teacher"><h3>üè´ Formato Profesor (Correcto)</h3>', 'info');
            mockNotifications.forEach(notif => {
                log(`<div class="notification-item">
                    <div class="title">${notif.taskTitle}</div>
                    <div class="subtitle">${getCourseNameById(notif.course)} ‚Ä¢ ${formatDate(notif.timestamp)}</div>
                    <div style="margin-top: 8px;">
                        <span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">
                            ${getCourseAbbreviation(notif.subject)}
                        </span>
                    </div>
                </div>`, 'info');
            });
            log('</div>', 'info');

            log('<div class="debug-section student"><h3>üë®‚Äçüéì Formato Estudiante (A corregir)</h3>', 'info');
            mockNotifications.forEach(notif => {
                log(`<div class="notification-item">
                    <div class="title">${notif.taskTitle || notif.taskId}</div>
                    <div class="subtitle">${getCourseNameById(notif.course)} ‚Ä¢ ${formatDate(notif.timestamp)}</div>
                    <div style="margin-top: 8px;">
                        <span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">
                            ${getCourseAbbreviation(notif.subject)}
                        </span>
                    </div>
                </div>`, 'info');
            });
            log('</div>', 'info');
        }

        // Auto-ejecutar al cargar
        window.onload = () => {
            log('‚úÖ Debug de formato de notificaciones cargado', 'success');
            log('üìã Instrucciones:', 'info');
            log('1. Haz clic en "Analizar Notificaciones" para ver el estado actual', 'info');
            log('2. Haz clic en "Corregir Formato" para aplicar la correcci√≥n', 'info');
            log('3. Haz clic en "Probar Display" para ver comparaci√≥n visual', 'info');
        };
    </script>
</body>
</html>
