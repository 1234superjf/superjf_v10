<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis: Problema de Refresco en Evaluaci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .problem-box {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-box {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 15px 0;
        }
        .step {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            padding: 15px;
            margin: 15px 0;
        }
        .warning {
            background: #fffbeb;
            border: 2px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        h1, h2, h3 { color: #2d3748; }
        .highlight { background: #fef5e7; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico: Refresco Autom√°tico en Evaluaciones</h1>
            <p>An√°lisis del problema de p√©rdida de estado de evaluaci√≥n de tarea</p>
        </div>
        
        <div class="content">
            <div class="problem-box">
                <h2>‚ùå Problema Identificado</h2>
                <p><strong>S√≠ntoma:</strong> Despu√©s de completar una evaluaci√≥n de tarea, la p√°gina se refresca autom√°ticamente y pierde el estado de que es una evaluaci√≥n de tarea, haciendo que aparezcan los botones "Repetir Evaluaci√≥n" y "Nueva Evaluaci√≥n" en lugar de solo "Cerrar".</p>
                
                <h3>Posibles Causas:</h3>
                <ul>
                    <li><strong>useEffect infinito:</strong> Alg√∫n useEffect se est√° ejecutando repetidamente</li>
                    <li><strong>Estado inconsistente:</strong> Los par√°metros de URL se pierden durante la navegaci√≥n</li>
                    <li><strong>Timing de localStorage:</strong> La limpieza/escritura de localStorage no est√° sincronizada</li>
                    <li><strong>React Strict Mode:</strong> Puede estar causando doble ejecuci√≥n en desarrollo</li>
                </ul>
            </div>

            <div class="solution-box">
                <h2>‚úÖ Soluci√≥n Implementada</h2>
                <p>Vamos a crear una versi√≥n m√°s robusta que:</p>
                
                <div class="step">
                    <h3>1. Evitar Loops Infinitos</h3>
                    <p>Asegurar que los useEffect tienen dependencias correctas y no se ejecutan innecesariamente.</p>
                </div>

                <div class="step">
                    <h3>2. Estado Persistente Mejorado</h3>
                    <p>Usar una combinaci√≥n de sessionStorage + localStorage para mayor robustez.</p>
                </div>

                <div class="step">
                    <h3>3. Detecci√≥n Robusta</h3>
                    <p>Implementar m√∫ltiples m√©todos de detecci√≥n que funcionen incluso despu√©s de refrescos.</p>
                </div>

                <div class="step">
                    <h3>4. Debug Logging Mejorado</h3>
                    <p>Agregar logs m√°s detallados para identificar exactamente cu√°ndo y por qu√© se pierde el estado.</p>
                </div>
            </div>

            <div class="warning">
                <h3>‚ö†Ô∏è Cambios Cr√≠ticos Necesarios</h3>
                <p>Se van a implementar los siguientes cambios para resolver el problema:</p>
                <ul>
                    <li>Mejorar el useEffect de par√°metros de URL para evitar loops</li>
                    <li>Usar sessionStorage como respaldo adicional</li>
                    <li>Implementar una funci√≥n de detecci√≥n m√°s robusta</li>
                    <li>Asegurar que el estado se mantiene durante toda the sesi√≥n</li>
                </ul>
            </div>

            <h2>üîß Cambios a Implementar</h2>
            
            <h3>1. Funci√≥n de Detecci√≥n Mejorada</h3>
            <div class="code-block">
const isTaskEvaluationDetection = useCallback(() => {
  // M√©todo 1: Estado React
  if (isTaskEvaluationSession) return true;
  
  // M√©todo 2: localStorage
  if (localStorage.getItem('isTaskEvaluation') === 'true') return true;
  
  // M√©todo 3: sessionStorage (nuevo)
  if (sessionStorage.getItem('isTaskEvaluation') === 'true') return true;
  
  // M√©todo 4: URL params
  const autoStart = searchParams.get('autoStart');
  const taskId = searchParams.get('taskId');
  if (autoStart === 'true' || taskId) return true;
  
  // M√©todo 5: Estado de auto-start
  if (isAutoStartMode) return true;
  
  return false;
}, [isTaskEvaluationSession, searchParams, isAutoStartMode]);
            </div>

            <h3>2. useEffect Mejorado para URL Params</h3>
            <div class="code-block">
useEffect(() => {
  // Solo ejecutar si realmente hay cambios en los par√°metros
  const courseFromQuery = searchParams.get('course');
  const bookFromQueryParam = searchParams.get('book');
  const topicFromQuery = searchParams.get('topic');
  const autoStart = searchParams.get('autoStart');
  const taskId = searchParams.get('taskId');

  const isTaskMode = autoStart === 'true' || !!taskId;
  
  // Solo actualizar estado si hay cambios
  if (isTaskMode !== isTaskEvaluationSession) {
    setIsTaskEvaluationSession(isTaskMode);
    setIsAutoStartMode(isTaskMode);
    
    if (isTaskMode) {
      localStorage.setItem('isTaskEvaluation', 'true');
      sessionStorage.setItem('isTaskEvaluation', 'true'); // Respaldo
    }
  }
  
  // Solo auto-start una vez
  if (autoStart === 'true' && !hasAutoStarted.current && courseFromQuery && bookFromQueryParam && topicFromQuery) {
    hasAutoStarted.current = true;
    handleCreateEvaluation();
  }
}, [searchParams.toString()]); // Usar toString() para evitar comparaciones complejas
            </div>

            <h3>3. Manejo de Resultados Mejorado</h3>
            <div class="code-block">
const handleCloseTaskEvaluation = useCallback(() => {
  console.log('üîÑ Closing task evaluation...');
  
  setShowResultDialog(false);
  setIsTaskEvaluationSession(false);
  
  // Limpiar todos los m√©todos de persistencia
  localStorage.removeItem('isTaskEvaluation');
  sessionStorage.removeItem('isTaskEvaluation');
  
  // Navegar limpiamente sin par√°metros
  router.push('/dashboard/evaluacion');
}, [router]);
            </div>

            <div class="solution-box">
                <h2>üéØ Resultado Esperado</h2>
                <p>Con estos cambios:</p>
                <ul>
                    <li>‚úÖ No habr√° refrescos autom√°ticos inesperados</li>
                    <li>‚úÖ El estado de evaluaci√≥n de tarea se mantendr√° correctamente</li>
                    <li>‚úÖ Los botones mostrados ser√°n los correctos en cada contexto</li>
                    <li>‚úÖ La navegaci√≥n ser√° limpia y predecible</li>
                    <li>‚úÖ Se podr√° debug f√°cilmente cualquier problema futuro</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
