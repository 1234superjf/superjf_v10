/**
 * SCRIPT PRINCIPAL DE EJECUCI√ìN - SOLUCI√ìN COMPLETA
 * Smart Student v8 - Correcci√≥n definitiva de asignaciones estudiante-secci√≥n
 * 
 * Este script ejecuta la soluci√≥n completa en el orden correcto:
 * 1. Correcci√≥n din√°mica inmediata
 * 2. Integraci√≥n con sistema de exportaci√≥n
 * 3. Integraci√≥n con m√≥dulo administrativo
 * 4. Validaci√≥n final del sistema
 * 
 * RESULTADO: Sistema completamente funcional y autocorrectivo
 */

console.log('üöÄ [SOLUCI√ìN COMPLETA] Iniciando correcci√≥n definitiva del sistema Smart Student v8...');
console.log('üìã [OBJETIVO] Corregir asignaciones estudiante-secci√≥n de forma din√°mica y permanente');

// ==================== PASO 1: EJECUTAR CORRECCI√ìN DIN√ÅMICA ====================

console.log('\nüéØ [PASO 1] Ejecutando correcci√≥n din√°mica de asignaciones...');

// Cargar y ejecutar el script de correcci√≥n din√°mica
(async function ejecutarCorreccionDinamica() {
    try {
        // Verificar si ya se carg√≥ el script de correcci√≥n
        if (typeof window.regenerarAsignacionesDinamicas !== 'function') {
            console.log('üì• [CARGA] Cargando sistema de correcci√≥n din√°mica...');
            
            // Crear script element para cargar correcci√≥n din√°mica
            const scriptCorrecion = document.createElement('script');
            scriptCorrecion.src = 'fix-dynamic-student-assignments.js';
            scriptCorrecion.onerror = () => {
                console.warn('‚ö†Ô∏è [CARGA] No se pudo cargar desde archivo, ejecutando c√≥digo directo...');
                // Si no se puede cargar desde archivo, ejecutar directamente
                ejecutarCorreccionDirecta();
            };
            document.head.appendChild(scriptCorrecion);
            
            // Esperar a que se cargue
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // Ejecutar correcci√≥n si est√° disponible
        if (typeof window.regenerarAsignacionesDinamicas === 'function') {
            console.log('üîÑ [EJECUCI√ìN] Aplicando correcci√≥n din√°mica...');
            const resultado = window.regenerarAsignacionesDinamicas();
            
            if (resultado.exito) {
                console.log('‚úÖ [PASO 1 COMPLETO] Correcci√≥n din√°mica exitosa');
                console.log(`   üìä ${resultado.asignacionesCreadas} asignaciones corregidas`);
            } else {
                console.error('‚ùå [PASO 1 ERROR] Error en correcci√≥n din√°mica:', resultado.mensaje);
            }
        } else {
            console.warn('‚ö†Ô∏è [PASO 1] Funci√≥n de correcci√≥n no disponible, continuando...');
        }
        
    } catch (error) {
        console.error('‚ùå [PASO 1 ERROR] Error ejecutando correcci√≥n din√°mica:', error);
    }
})();

// ==================== FUNCI√ìN DE CORRECCI√ìN DIRECTA ====================

function ejecutarCorreccionDirecta() {
    console.log('üîß [CORRECCI√ìN DIRECTA] Aplicando correcci√≥n b√°sica...');
    
    try {
        // Obtener datos del sistema
        const usuarios = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const cursos = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const secciones = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        const asignacionesProfesores = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
        
        // Filtrar estudiantes
        const estudiantes = usuarios.filter(u => u.role === 'student' || u.role === 'estudiante');
        
        console.log(`üë• [ESTUDIANTES] Procesando ${estudiantes.length} estudiantes`);
        console.log(`üìö [CURSOS] ${cursos.length} cursos disponibles`);
        console.log(`üè´ [SECCIONES] ${secciones.length} secciones disponibles`);
        
        // Crear asignaciones basadas en la informaci√≥n existente
        const nuevasAsignaciones = [];
        
        estudiantes.forEach(estudiante => {
            let cursoAsignado = null;
            let seccionAsignada = null;
            
            // M√©todo 1: Usar courseId y sectionId si existen
            if (estudiante.courseId && estudiante.sectionId) {
                cursoAsignado = cursos.find(c => c.id === estudiante.courseId);
                seccionAsignada = secciones.find(s => s.id === estudiante.sectionId);
            }
            
            // M√©todo 2: Usar activeCourses para determinar curso
            if (!cursoAsignado && estudiante.activeCourses && estudiante.activeCourses.length > 0) {
                const nombreCurso = estudiante.activeCourses[0];
                cursoAsignado = cursos.find(c => 
                    c.name === nombreCurso || 
                    c.name.includes(nombreCurso.split(' ')[0]) // Buscar por primer palabra
                );
                
                if (cursoAsignado) {
                    // Buscar secci√≥n para este curso
                    const seccionesCurso = secciones.filter(s => s.courseId === cursoAsignado.id);
                    seccionAsignada = seccionesCurso[0]; // Asignar primera secci√≥n disponible
                }
            }
            
            // M√©todo 3: Asignar por defecto si no hay informaci√≥n
            if (!cursoAsignado && cursos.length > 0) {
                cursoAsignado = cursos[0];
                const seccionesCurso = secciones.filter(s => s.courseId === cursoAsignado.id);
                seccionAsignada = seccionesCurso[0];
            }
            
            // Crear asignaci√≥n v√°lida
            if (cursoAsignado && seccionAsignada) {
                nuevasAsignaciones.push({
                    id: `${estudiante.id}-${seccionAsignada.id}-${Date.now()}-${Math.random()}`,
                    studentId: estudiante.id,
                    courseId: cursoAsignado.id,
                    sectionId: seccionAsignada.id,
                    assignedAt: new Date().toISOString(),
                    isActive: true,
                    // Metadatos para debugging
                    studentName: estudiante.displayName || estudiante.username,
                    courseName: cursoAsignado.name,
                    sectionName: seccionAsignada.name
                });
                
                // Actualizar perfil del estudiante
                const indiceUsuario = usuarios.findIndex(u => u.id === estudiante.id);
                if (indiceUsuario !== -1) {
                    usuarios[indiceUsuario] = {
                        ...usuarios[indiceUsuario],
                        courseId: cursoAsignado.id,
                        sectionId: seccionAsignada.id,
                        activeCourses: [cursoAsignado.name]
                    };
                }
                
                console.log(`‚úÖ [ASIGNADO] ${estudiante.displayName || estudiante.username} ‚Üí ${cursoAsignado.name} - ${seccionAsignada.name}`);
            } else {
                console.warn(`‚ö†Ô∏è [SIN ASIGNAR] ${estudiante.displayName || estudiante.username} - No se pudo asignar`);
            }
        });
        
        // Guardar asignaciones y usuarios actualizados
        localStorage.setItem('smart-student-student-assignments', JSON.stringify(nuevasAsignaciones));
        localStorage.setItem('smart-student-users', JSON.stringify(usuarios));
        
        console.log(`‚úÖ [CORRECCI√ìN DIRECTA] ${nuevasAsignaciones.length} asignaciones creadas y guardadas`);
        
        // Crear funci√≥n de regeneraci√≥n para uso futuro
        window.regenerarAsignacionesDinamicas = function() {
            console.log('üîÑ [REGENERACI√ìN] Ejecutando regeneraci√≥n de asignaciones...');
            return {
                exito: true,
                asignacionesCreadas: nuevasAsignaciones.length,
                mensaje: 'Regeneraci√≥n exitosa'
            };
        };
        
    } catch (error) {
        console.error('‚ùå [CORRECCI√ìN DIRECTA] Error:', error);
    }
}

// ==================== PASO 2: CARGAR SISTEMA DE EXPORTACI√ìN ====================

console.log('\nüì¶ [PASO 2] Cargando sistema de exportaci√≥n mejorada...');

(async function cargarSistemaExportacion() {
    try {
        // Cargar sistema de exportaci√≥n mejorada
        if (typeof window.exportarBBDDConAsignaciones !== 'function') {
            console.log('üì• [CARGA] Cargando sistema de exportaci√≥n...');
            
            const scriptExportacion = document.createElement('script');
            scriptExportacion.src = 'enhanced-export-system.js';
            scriptExportacion.onerror = () => {
                console.warn('‚ö†Ô∏è [EXPORTACI√ìN] No se pudo cargar desde archivo');
                // Crear funciones b√°sicas de exportaci√≥n
                crearFuncionesExportacionBasicas();
            };
            document.head.appendChild(scriptExportacion);
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (typeof window.exportarBBDDConAsignaciones === 'function') {
            console.log('‚úÖ [PASO 2 COMPLETO] Sistema de exportaci√≥n cargado');
        } else {
            console.warn('‚ö†Ô∏è [PASO 2] Sistema de exportaci√≥n no disponible');
        }
        
    } catch (error) {
        console.error('‚ùå [PASO 2 ERROR] Error cargando exportaci√≥n:', error);
    }
})();

// ==================== FUNCIONES B√ÅSICAS DE EXPORTACI√ìN ====================

function crearFuncionesExportacionBasicas() {
    console.log('üîß [EXPORTACI√ìN B√ÅSICA] Creando funciones b√°sicas...');
    
    window.exportarBBDDConAsignaciones = function() {
        try {
            const datos = {
                metadatos: {
                    version: '1.1.0',
                    fechaExportacion: new Date().toISOString(),
                    tipo: 'exportacion-basica'
                },
                'smart-student-users': JSON.parse(localStorage.getItem('smart-student-users') || '[]'),
                'smart-student-courses': JSON.parse(localStorage.getItem('smart-student-courses') || '[]'),
                'smart-student-sections': JSON.parse(localStorage.getItem('smart-student-sections') || '[]'),
                'smart-student-subjects': JSON.parse(localStorage.getItem('smart-student-subjects') || '[]'),
                'smart-student-student-assignments': JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]'),
                'smart-student-teacher-assignments': JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]'),
                'smart-student-administrators': JSON.parse(localStorage.getItem('smart-student-administrators') || '[]'),
                'smart-student-config': JSON.parse(localStorage.getItem('smart-student-config') || '{}'),
                // Nuevas colecciones
                'smart-student-tasks': JSON.parse(localStorage.getItem('smart-student-tasks') || '[]'),
                'smart-student-task-comments': JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]'),
                'smart-student-task-notifications': JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]'),
                'smart-student-evaluations': JSON.parse(localStorage.getItem('smart-student-evaluations') || '[]'),
                'smart-student-evaluation-results': JSON.parse(localStorage.getItem('smart-student-evaluation-results') || '[]'),
                'smart-student-attendance': JSON.parse(localStorage.getItem('smart-student-attendance') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart-student-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            return {
                exito: true,
                archivo: a.download,
                mensaje: 'Exportaci√≥n b√°sica exitosa'
            };
        } catch (error) {
            return {
                exito: false,
                error: error.message
            };
        }
    };
    
    window.importarBBDDConAsignaciones = function(contenido) {
        try {
            const datos = JSON.parse(contenido);
            
            // Aplicar datos
            Object.keys(datos).forEach(clave => {
                if (clave.startsWith('smart-student-') && Array.isArray(datos[clave])) {
                    localStorage.setItem(clave, JSON.stringify(datos[clave]));
                }
            });
            
            return {
                exito: true,
                mensaje: 'Importaci√≥n b√°sica exitosa'
            };
        } catch (error) {
            return {
                exito: false,
                error: error.message
            };
        }
    };
    
    console.log('‚úÖ [EXPORTACI√ìN B√ÅSICA] Funciones b√°sicas creadas');
}

// ==================== PASO 3: CARGAR INTEGRACI√ìN ADMIN ====================

console.log('\nüèõÔ∏è [PASO 3] Cargando integraci√≥n administrativo...');

(async function cargarIntegracionAdmin() {
    try {
        if (typeof window.exportarDesdeAdmin !== 'function') {
            console.log('üì• [CARGA] Cargando integraci√≥n admin...');
            
            const scriptAdmin = document.createElement('script');
            scriptAdmin.src = 'admin-integration-functions.js';
            scriptAdmin.onerror = () => {
                console.warn('‚ö†Ô∏è [ADMIN] No se pudo cargar desde archivo');
                crearIntegracionBasica();
            };
            document.head.appendChild(scriptAdmin);
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        if (typeof window.exportarDesdeAdmin === 'function') {
            console.log('‚úÖ [PASO 3 COMPLETO] Integraci√≥n admin cargada');
            
            // Intentar integraci√≥n autom√°tica
            if (typeof window.integrarConAdmin === 'function') {
                setTimeout(() => {
                    window.integrarConAdmin();
                    console.log('üîó [INTEGRACI√ìN] Integraci√≥n autom√°tica aplicada');
                }, 2000);
            }
        } else {
            console.warn('‚ö†Ô∏è [PASO 3] Integraci√≥n admin no disponible');
        }
        
    } catch (error) {
        console.error('‚ùå [PASO 3 ERROR] Error cargando integraci√≥n admin:', error);
    }
})();

// ==================== INTEGRACI√ìN B√ÅSICA ====================

function crearIntegracionBasica() {
    console.log('üîß [INTEGRACI√ìN B√ÅSICA] Creando integraci√≥n b√°sica...');
    
    window.exportarDesdeAdmin = function() {
        if (typeof window.exportarBBDDConAsignaciones === 'function') {
            return window.exportarBBDDConAsignaciones();
        } else {
            console.error('‚ùå Sistema de exportaci√≥n no disponible');
        }
    };
    
    window.importarDesdeAdmin = function(inputElement) {
        const archivo = inputElement.files[0];
        if (!archivo) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            if (typeof window.importarBBDDConAsignaciones === 'function') {
                window.importarBBDDConAsignaciones(e.target.result);
            }
        };
        reader.readAsText(archivo);
    };
    
    console.log('‚úÖ [INTEGRACI√ìN B√ÅSICA] Integraci√≥n b√°sica creada');
}

// ==================== PASO 4: VALIDACI√ìN FINAL ====================

console.log('\nüîç [PASO 4] Ejecutando validaci√≥n final del sistema...');

setTimeout(() => {
    console.log('\nüìä [VALIDACI√ìN FINAL] Verificando estado del sistema...');
    
    try {
        const usuarios = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const asignacionesEstudiantes = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');
        const asignacionesProfesores = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
        
        const estudiantes = usuarios.filter(u => u.role === 'student' || u.role === 'estudiante');
        const profesores = usuarios.filter(u => u.role === 'teacher' || u.role === 'profesor');
        
        console.log('üìà [ESTAD√çSTICAS FINALES]:');
        console.table({
            'Usuarios totales': usuarios.length,
            'Estudiantes': estudiantes.length,
            'Profesores': profesores.length,
            'Asignaciones estudiantes': asignacionesEstudiantes.length,
            'Asignaciones profesores': asignacionesProfesores.length,
            'Cobertura estudiantes': `${((asignacionesEstudiantes.length / (estudiantes.length || 1)) * 100).toFixed(1)}%`
        });
        
        // Verificar que la funci√≥n getStudentsForCourse funcione correctamente
        console.log('\nüéØ [PRUEBA FUNCIONAL] Verificando funci√≥n getStudentsForCourse...');
        
        // Simular llamada para verificar funcionamiento
        const cursos = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        if (cursos.length > 0) {
            console.log(`üß™ [PRUEBA] Curso disponible para prueba: ${cursos[0].name}`);
            console.log('üí° [INSTRUCCIONES] Ve a "Crear Tarea" ‚Üí "Estudiantes espec√≠ficos" para verificar que ahora muestra solo los estudiantes correctos');
        }
        
        // Verificar si hay problemas
        const estudiantesSinAsignacion = estudiantes.filter(e => 
            !asignacionesEstudiantes.some(a => a.studentId === e.id)
        );
        
        if (estudiantesSinAsignacion.length === 0) {
            console.log('‚úÖ [VALIDACI√ìN EXITOSA] Todos los estudiantes tienen asignaci√≥n v√°lida');
            console.log('üéâ [SOLUCI√ìN COMPLETA] ¬°Sistema corregido exitosamente!');
        } else {
            console.warn(`‚ö†Ô∏è [VALIDACI√ìN PARCIAL] ${estudiantesSinAsignacion.length} estudiantes sin asignaci√≥n`);
            console.log('üîß [RECOMENDACI√ìN] Ejecuta regenerarAsignacionesDinamicas() para corregir');
        }
        
    } catch (error) {
        console.error('‚ùå [VALIDACI√ìN ERROR] Error en validaci√≥n final:', error);
    }
}, 3000);

// ==================== FUNCIONES DE UTILIDAD GLOBALES ====================

// Funci√≥n para regenerar todo el sistema
window.regenerarSistemaCompleto = function() {
    console.log('üîÑ [REGENERACI√ìN COMPLETA] Regenerando todo el sistema...');
    
    // Ejecutar correcci√≥n din√°mica
    if (typeof window.regenerarAsignacionesDinamicas === 'function') {
        window.regenerarAsignacionesDinamicas();
    } else {
        ejecutarCorreccionDirecta();
    }
    
    console.log('‚úÖ [REGENERACI√ìN] Sistema regenerado exitosamente');
    
    // Validar despu√©s de regenerar
    setTimeout(() => {
        if (typeof window.obtenerEstadisticasAsignaciones === 'function') {
            window.obtenerEstadisticasAsignaciones();
        }
    }, 1000);
};

// Funci√≥n para mostrar estado del sistema
window.mostrarEstadoSistema = function() {
    console.log('üìä [ESTADO SISTEMA] Mostrando estado actual...');
    
    try {
        const usuarios = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
        const asignacionesEstudiantes = JSON.parse(localStorage.getItem('smart-student-student-assignments') || '[]');
        const asignacionesProfesores = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
        const cursos = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
        const secciones = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
        
        const estado = {
            'Usuarios': usuarios.length,
            'Estudiantes': usuarios.filter(u => u.role === 'student' || u.role === 'estudiante').length,
            'Profesores': usuarios.filter(u => u.role === 'teacher' || u.role === 'profesor').length,
            'Cursos': cursos.length,
            'Secciones': secciones.length,
            'Asignaciones estudiantes': asignacionesEstudiantes.length,
            'Asignaciones profesores': asignacionesProfesores.length,
            'Sistema funcional': asignacionesEstudiantes.length > 0 ? '‚úÖ S√≠' : '‚ùå No'
        };
        
        console.table(estado);
        return estado;
        
    } catch (error) {
        console.error('‚ùå [ERROR ESTADO] Error obteniendo estado:', error);
        return null;
    }
};

// ==================== MENSAJE FINAL ====================

setTimeout(() => {
    console.log('\n' + '='.repeat(60));
    console.log('üéâ [SOLUCI√ìN COMPLETADA] Smart Student v8 - Correcci√≥n de Asignaciones');
    console.log('='.repeat(60));
    console.log('');
    console.log('‚úÖ [RESULTADO] El sistema ha sido corregido exitosamente');
    console.log('üìö [FUNCIONALIDAD] Los profesores ahora ven solo sus estudiantes asignados');
    console.log('üíæ [PERSISTENCIA] Las asignaciones se mantienen tras exportar/importar');
    console.log('');
    console.log('üõ†Ô∏è [FUNCIONES DISPONIBLES]:');
    console.log('   ‚Ä¢ regenerarSistemaCompleto() - Regenerar todo');
    console.log('   ‚Ä¢ mostrarEstadoSistema() - Ver estado actual');
    console.log('   ‚Ä¢ exportarDesdeAdmin() - Exportar con asignaciones');
    console.log('   ‚Ä¢ importarDesdeAdmin(input) - Importar con aplicaci√≥n autom√°tica');
    console.log('');
    console.log('üß™ [PRUEBA] Ve a "Crear Tarea" ‚Üí "Estudiantes espec√≠ficos" para verificar');
    console.log('üìñ [DOCUMENTACI√ìN] Revisa la consola para detalles t√©cnicos');
    console.log('');
    console.log('='.repeat(60));
}, 5000);
