<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n de Problemas del Profesor Jorge</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .problem { background-color: #ffebee; }
        .solution { background-color: #e8f5e8; }
        .info { background-color: #e3f2fd; }
        .warning { background-color: #fff3e0; }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
        .warning-text { color: #f57c00; }
        .info-text { color: #1976d2; }
        
        h1 { color: #1976d2; text-align: center; }
        h2 { color: #333; border-bottom: 2px solid #1976d2; padding-bottom: 5px; }
        h3 { color: #555; }
        
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #1565c0; }
        button.danger { background: #d32f2f; }
        button.danger:hover { background: #c62828; }
        button.success { background: #388e3c; }
        button.success:hover { background: #2e7d32; }
        
        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #1976d2;
        }
        .notification.error { border-left-color: #d32f2f; background: #ffebee; }
        .notification.success { border-left-color: #388e3c; background: #e8f5e8; }
        .notification.warning { border-left-color: #f57c00; background: #fff3e0; }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .results-table th, .results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .results-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.evaluation { background: #e3f2fd; color: #1976d2; }
        .badge.course { background: #e8f5e8; color: #388e3c; }
        .badge.result { background: #fff3e0; color: #f57c00; }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .progress {
            background: #e0e0e0;
            border-radius: 5px;
            height: 20px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #1976d2;
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verificaci√≥n de Problemas del Profesor Jorge</h1>
        
        <div class="section problem">
            <h2>‚ùå Problemas Identificados</h2>
            <div class="notification error">
                <strong>Problema 1:</strong> Las notificaciones muestran "Sistema" en lugar del nombre de la evaluaci√≥n y curso.
            </div>
            <div class="notification error">
                <strong>Problema 2:</strong> La tabla de resultados de evaluaci√≥n aparece vac√≠a cuando ya hay estudiantes que completaron la evaluaci√≥n.
            </div>
            <div class="notification error">
                <strong>Problema 3:</strong> Las notificaciones muestran el resultado/porcentaje, lo que no es deseado.
            </div>
        </div>
        
        <div class="section info">
            <h2>üîß Panel de Control</h2>
            <button onclick="setupTestScenario()">üìã Crear Escenario de Prueba</button>
            <button onclick="simulateEvaluationCompletion()">‚úÖ Simular Evaluaci√≥n Completada</button>
            <button onclick="checkNotifications()">üîî Verificar Notificaciones</button>
            <button onclick="checkResultsTable()">üìä Verificar Tabla de Resultados</button>
            <button onclick="applyFixes()" class="success">üîß Aplicar Correcciones</button>
            <button onclick="clearAll()" class="danger">üóëÔ∏è Limpiar Todo</button>
        </div>
        
        <div class="section">
            <h2>üìä Estado Actual</h2>
            <div id="current-status">
                <p class="info-text">Haz clic en "Crear Escenario de Prueba" para comenzar la verificaci√≥n.</p>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>üîî Notificaciones del Profesor</h2>
            <div id="notifications-display">
                <p class="info-text">Las notificaciones aparecer√°n aqu√≠ despu√©s de crear el escenario de prueba.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>üìã Tabla de Resultados de Evaluaci√≥n</h2>
            <div id="results-table-display">
                <p class="info-text">La tabla de resultados aparecer√° aqu√≠ despu√©s de simular evaluaciones completadas.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>üìù Log de Verificaci√≥n</h2>
            <div id="verification-log" class="log">
                <div class="info-text">Los logs de verificaci√≥n aparecer√°n aqu√≠...</div>
            </div>
        </div>
        
        <div class="section solution">
            <h2>‚úÖ Correcciones Aplicadas</h2>
            <div id="fixes-applied">
                <p class="info-text">Las correcciones aplicadas se mostrar√°n aqu√≠.</p>
            </div>
        </div>
    </div>

    <script>
        let testTaskId = null;
        let testNotificationId = null;
        
        // Utility functions
        function log(message, type = 'info') {
            const logElement = document.getElementById('verification-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : type === 'warning' ? '#f57c00' : '#1976d2';
            logElement.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateProgress(percentage) {
            document.getElementById('progress-bar').style.width = percentage + '%';
        }
        
        function updateStatus(message) {
            document.getElementById('current-status').innerHTML = `<p class="info-text">${message}</p>`;
        }
        
        // Setup test scenario
        function setupTestScenario() {
            log('üöÄ Iniciando configuraci√≥n del escenario de prueba...', 'info');
            updateProgress(10);
            
            // Create test users
            const users = [
                {
                    username: 'jorge_profesor',
                    password: 'profesor123',
                    role: 'teacher',
                    displayName: 'Prof. Jorge Garc√≠a',
                    firstName: 'Jorge',
                    lastName: 'Garc√≠a',
                    email: 'jorge.garcia@escuela.edu',
                    courses: ['4to B√°sico', '5to B√°sico'],
                    subjects: ['Ciencias Naturales', 'Matem√°ticas']
                },
                {
                    username: 'maria_estudiante',
                    password: 'estudiante123',
                    role: 'student',
                    displayName: 'Mar√≠a Gonz√°lez',
                    firstName: 'Mar√≠a',
                    lastName: 'Gonz√°lez',
                    email: 'maria.gonzalez@estudiante.edu',
                    activeCourses: ['4to B√°sico']
                },
                {
                    username: 'pedro_estudiante',
                    password: 'estudiante123',
                    role: 'student',
                    displayName: 'Pedro Mart√≠nez',
                    firstName: 'Pedro',
                    lastName: 'Mart√≠nez',
                    email: 'pedro.martinez@estudiante.edu',
                    activeCourses: ['4to B√°sico']
                }
            ];
            
            localStorage.setItem('smart-student-users', JSON.stringify(users));
            log('‚úÖ Usuarios de prueba creados', 'success');
            updateProgress(25);
            
            // Create evaluation task with PROBLEMA: assignedByName = 'Sistema'
            testTaskId = 'eval_ciencias_' + Date.now();
            const evaluationTask = {
                id: testTaskId,
                title: 'Evaluaci√≥n de Ciencias Naturales',
                description: 'Evaluaci√≥n sobre el sistema solar y planetas',
                subject: 'Ciencias Naturales',
                course: '4to B√°sico',
                assignedBy: 'jorge_profesor',
                assignedByName: 'Sistema', // ‚ùå PROBLEMA: Muestra "Sistema" en lugar del nombre correcto
                assignedTo: 'course',
                dueDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString(),
                status: 'pending',
                priority: 'medium',
                taskType: 'evaluation',
                evaluationConfig: {
                    topic: 'Sistema Solar',
                    questionCount: 10,
                    timeLimit: 30
                },
                evaluationResults: {} // Vac√≠o inicialmente
            };
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            tasks.push(evaluationTask);
            localStorage.setItem('smart-student-tasks', JSON.stringify(tasks));
            log('‚úÖ Tarea de evaluaci√≥n creada con problema "Sistema"', 'warning');
            updateProgress(50);
            
            // Create notification with the problem
            testNotificationId = 'pending_grading_' + testTaskId + '_' + Date.now();
            const problemNotification = {
                id: testNotificationId,
                type: 'pending_grading',
                taskId: testTaskId,
                taskTitle: evaluationTask.title,
                targetUserRole: 'teacher',
                targetUsernames: ['jorge_profesor'],
                fromUsername: 'system',
                fromDisplayName: 'Sistema', // ‚ùå PROBLEMA: Muestra "Sistema"
                course: evaluationTask.course,
                subject: evaluationTask.subject,
                timestamp: new Date().toISOString(),
                read: false,
                readBy: [],
                taskType: 'evaluation'
            };
            
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            notifications.push(problemNotification);
            localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
            log('‚ùå Notificaci√≥n problem√°tica creada: muestra "Sistema"', 'error');
            updateProgress(75);
            
            updateStatus('Escenario de prueba configurado. Problemas identificados.');
            updateProgress(100);
            log('‚úÖ Escenario de prueba configurado completamente', 'success');
            
            // Display current notifications
            displayNotifications();
        }
        
        // Simulate evaluation completion
        function simulateEvaluationCompletion() {
            if (!testTaskId) {
                log('‚ùå Error: Primero debes crear el escenario de prueba', 'error');
                return;
            }
            
            log('üéØ Simulando evaluaci√≥n completada por estudiante...', 'info');
            
            // Simulate student completing evaluation
            const studentUsername = 'maria_estudiante';
            const userTasksKey = `userTasks_${studentUsername}`;
            const userTasks = JSON.parse(localStorage.getItem(userTasksKey) || '[]');
            
            // Find or create the evaluation task for the student
            let studentTask = userTasks.find(task => task.id === testTaskId);
            if (!studentTask) {
                // Create the task in student's userTasks
                const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const globalTask = globalTasks.find(task => task.id === testTaskId);
                if (globalTask) {
                    studentTask = { ...globalTask };
                    userTasks.push(studentTask);
                }
            }
            
            if (studentTask) {
                // Mark as completed
                studentTask.status = 'completed';
                studentTask.completedAt = new Date().toISOString();
                studentTask.score = 85;
                studentTask.completionPercentage = 85;
                
                localStorage.setItem(userTasksKey, JSON.stringify(userTasks));
                log('‚úÖ Evaluaci√≥n marcada como completada para Mar√≠a Gonz√°lez', 'success');
                
                // Add results to global task
                const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
                const globalTaskIndex = globalTasks.findIndex(task => task.id === testTaskId);
                if (globalTaskIndex !== -1) {
                    if (!globalTasks[globalTaskIndex].evaluationResults) {
                        globalTasks[globalTaskIndex].evaluationResults = {};
                    }
                    globalTasks[globalTaskIndex].evaluationResults[studentUsername] = {
                        score: 85,
                        completionPercentage: 85,
                        completedAt: new Date().toISOString(),
                        totalQuestions: 10
                    };
                    localStorage.setItem('smart-student-tasks', JSON.stringify(globalTasks));
                    log('‚úÖ Resultados sincronizados en tarea global', 'success');
                }
                
                // Create evaluation completed notification with PROBLEMA: shows result percentage
                const completedNotification = {
                    id: `eval_completed_${testTaskId}_${studentUsername}_${Date.now()}`,
                    type: 'task_completed',
                    taskId: testTaskId,
                    taskTitle: 'Evaluaci√≥n de Ciencias Naturales',
                    targetUserRole: 'teacher',
                    targetUsernames: ['jorge_profesor'],
                    fromUsername: studentUsername,
                    fromDisplayName: 'Mar√≠a Gonz√°lez',
                    course: '4to B√°sico',
                    subject: 'Ciencias Naturales',
                    timestamp: new Date().toISOString(),
                    read: false,
                    readBy: [],
                    taskType: 'evaluation',
                    grade: 85 // ‚ùå PROBLEMA: Muestra el resultado en la notificaci√≥n
                };
                
                const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                notifications.push(completedNotification);
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
                log('‚ùå Notificaci√≥n de evaluaci√≥n completada creada CON resultado visible', 'warning');
                
                displayNotifications();
                displayResultsTable();
            }
        }
        
        // Check notifications
        function checkNotifications() {
            log('üîî Verificando notificaciones del profesor...', 'info');
            
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const teacherNotifications = notifications.filter(n => n.targetUsernames.includes('jorge_profesor'));
            
            log(`üìä Encontradas ${teacherNotifications.length} notificaciones para el profesor`, 'info');
            
            teacherNotifications.forEach(notif => {
                if (notif.fromDisplayName === 'Sistema') {
                    log(`‚ùå PROBLEMA: Notificaci√≥n ${notif.id} muestra "Sistema" en lugar del nombre correcto`, 'error');
                }
                if (notif.grade !== undefined) {
                    log(`‚ùå PROBLEMA: Notificaci√≥n ${notif.id} muestra resultado ${notif.grade}%`, 'error');
                }
            });
            
            displayNotifications();
        }
        
        // Check results table
        function checkResultsTable() {
            if (!testTaskId) {
                log('‚ùå Error: Primero debes crear el escenario de prueba', 'error');
                return;
            }
            
            log('üìä Verificando tabla de resultados de evaluaci√≥n...', 'info');
            
            const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const evaluationTask = globalTasks.find(task => task.id === testTaskId);
            
            if (!evaluationTask) {
                log('‚ùå No se encontr√≥ la tarea de evaluaci√≥n', 'error');
                return;
            }
            
            log('üìã Tarea de evaluaci√≥n encontrada', 'success');
            log(`üìä Resultados en tarea: ${JSON.stringify(evaluationTask.evaluationResults)}`, 'info');
            
            // Check if there are any results
            const hasResults = evaluationTask.evaluationResults && Object.keys(evaluationTask.evaluationResults).length > 0;
            
            if (hasResults) {
                log('‚úÖ Se encontraron resultados en la tarea', 'success');
                const resultsCount = Object.keys(evaluationTask.evaluationResults).length;
                log(`üìä ${resultsCount} estudiante(s) han completado la evaluaci√≥n`, 'success');
            } else {
                log('‚ùå PROBLEMA: No se encontraron resultados en la tarea (tabla aparecer√° vac√≠a)', 'error');
            }
            
            displayResultsTable();
        }
        
        // Apply fixes
        function applyFixes() {
            log('üîß Aplicando correcciones a los problemas identificados...', 'info');
            updateProgress(0);
            
            // Fix 1: Correct assignedByName in evaluation task
            const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const taskIndex = globalTasks.findIndex(task => task.id === testTaskId);
            if (taskIndex !== -1) {
                const task = globalTasks[taskIndex];
                const originalAssignedByName = task.assignedByName;
                task.assignedByName = `${task.title} (${task.course})`; // ‚úÖ CORRECCI√ìN: Usar t√≠tulo y curso
                globalTasks[taskIndex] = task;
                localStorage.setItem('smart-student-tasks', JSON.stringify(globalTasks));
                log(`‚úÖ FIX 1: assignedByName cambiado de "${originalAssignedByName}" a "${task.assignedByName}"`, 'success');
            }
            updateProgress(25);
            
            // Fix 2: Correct notification fromDisplayName
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            let notificationsFixed = 0;
            
            notifications.forEach(notif => {
                if (notif.taskId === testTaskId && notif.fromDisplayName === 'Sistema') {
                    const task = globalTasks.find(t => t.id === testTaskId);
                    if (task) {
                        notif.fromDisplayName = `${task.title} (${task.course})`; // ‚úÖ CORRECCI√ìN
                        notificationsFixed++;
                    }
                }
            });
            
            if (notificationsFixed > 0) {
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
                log(`‚úÖ FIX 2: ${notificationsFixed} notificaci√≥n(es) corregida(s) - fromDisplayName actualizado`, 'success');
            }
            updateProgress(50);
            
            // Fix 3: Remove grade from completed notifications
            let gradeRemoved = 0;
            notifications.forEach(notif => {
                if (notif.taskId === testTaskId && notif.type === 'task_completed' && notif.grade !== undefined) {
                    delete notif.grade; // ‚úÖ CORRECCI√ìN: Eliminar el campo grade
                    gradeRemoved++;
                }
            });
            
            if (gradeRemoved > 0) {
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
                log(`‚úÖ FIX 3: ${gradeRemoved} notificaci√≥n(es) corregida(s) - resultado eliminado`, 'success');
            }
            updateProgress(75);
            
            // Fix 4: Ensure evaluation results are properly stored
            if (testTaskId) {
                const task = globalTasks.find(t => t.id === testTaskId);
                if (task && (!task.evaluationResults || Object.keys(task.evaluationResults).length === 0)) {
                    // Check if there are completed evaluations in student userTasks
                    const studentUsernames = ['maria_estudiante', 'pedro_estudiante'];
                    
                    studentUsernames.forEach(studentUsername => {
                        const userTasksKey = `userTasks_${studentUsername}`;
                        const userTasks = JSON.parse(localStorage.getItem(userTasksKey) || '[]');
                        const userTask = userTasks.find(ut => ut.id === testTaskId && ut.status === 'completed');
                        
                        if (userTask) {
                            if (!task.evaluationResults) task.evaluationResults = {};
                            task.evaluationResults[studentUsername] = {
                                score: userTask.score || 0,
                                completionPercentage: userTask.completionPercentage || 0,
                                completedAt: userTask.completedAt,
                                totalQuestions: userTask.evaluationConfig?.questionCount || task.evaluationConfig?.questionCount || 0
                            };
                            log(`‚úÖ FIX 4: Resultados sincronizados para ${studentUsername}`, 'success');
                        }
                    });
                    
                    const updatedTaskIndex = globalTasks.findIndex(t => t.id === testTaskId);
                    if (updatedTaskIndex !== -1) {
                        globalTasks[updatedTaskIndex] = task;
                        localStorage.setItem('smart-student-tasks', JSON.stringify(globalTasks));
                    }
                }
            }
            updateProgress(100);
            
            log('‚úÖ Todas las correcciones aplicadas exitosamente', 'success');
            updateStatus('Correcciones aplicadas. Los problemas han sido solucionados.');
            
            // Update displays
            displayNotifications();
            displayResultsTable();
            displayFixesApplied();
        }
        
        // Display notifications
        function displayNotifications() {
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const teacherNotifications = notifications.filter(n => n.targetUsernames.includes('jorge_profesor'));
            
            let html = '<h3>Notificaciones del Profesor Jorge:</h3>';
            
            if (teacherNotifications.length === 0) {
                html += '<p class="info-text">No hay notificaciones.</p>';
            } else {
                teacherNotifications.forEach(notif => {
                    const hasSystemProblem = notif.fromDisplayName === 'Sistema';
                    const hasGradeProblem = notif.grade !== undefined;
                    const problemClass = hasSystemProblem || hasGradeProblem ? 'error' : 'success';
                    
                    html += `
                        <div class="notification ${problemClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${notif.fromDisplayName || notif.fromUsername}</strong>
                                    ${hasSystemProblem ? '<span class="error"> ‚ùå PROBLEMA: Muestra "Sistema"</span>' : ''}
                                    <br>
                                    <small>${notif.type === 'task_completed' ? 'Complet√≥ la evaluaci√≥n' : 'Evaluaci√≥n pendiente'}: ${notif.taskTitle}</small>
                                    <br>
                                    <small>Curso: ${notif.course} | Materia: ${notif.subject}</small>
                                </div>
                                <div>
                                    <span class="badge course">${notif.course}</span>
                                    ${notif.grade !== undefined ? `<span class="badge result">‚ùå ${notif.grade}%</span>` : ''}
                                </div>
                            </div>
                            ${hasGradeProblem ? '<div class="error" style="margin-top: 10px;">‚ùå PROBLEMA: Muestra resultado en notificaci√≥n</div>' : ''}
                        </div>
                    `;
                });
            }
            
            document.getElementById('notifications-display').innerHTML = html;
        }
        
        // Display results table
        function displayResultsTable() {
            if (!testTaskId) {
                document.getElementById('results-table-display').innerHTML = '<p class="info-text">Primero debes crear el escenario de prueba.</p>';
                return;
            }
            
            const globalTasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const evaluationTask = globalTasks.find(task => task.id === testTaskId);
            
            if (!evaluationTask) {
                document.getElementById('results-table-display').innerHTML = '<p class="error">No se encontr√≥ la tarea de evaluaci√≥n.</p>';
                return;
            }
            
            let html = '<h3>Tabla de Resultados de Evaluaci√≥n:</h3>';
            
            // Check if there are results
            const hasResults = evaluationTask.evaluationResults && Object.keys(evaluationTask.evaluationResults).length > 0;
            
            if (!hasResults) {
                html += '<div class="notification error">‚ùå PROBLEMA: No hay resultados en la tarea (tabla aparecer√° vac√≠a)</div>';
                html += '<table class="results-table"><thead><tr><th>Estudiante</th><th>Estado</th><th>Puntaje</th><th>Porcentaje</th><th>Fecha</th></tr></thead>';
                html += '<tbody><tr><td colspan="5" style="text-align: center; font-style: italic; color: #999;">No hay resultados disponibles</td></tr></tbody></table>';
            } else {
                html += '<div class="notification success">‚úÖ Resultados encontrados en la tarea</div>';
                html += '<table class="results-table"><thead><tr><th>Estudiante</th><th>Estado</th><th>Puntaje</th><th>Porcentaje</th><th>Fecha</th></tr></thead><tbody>';
                
                Object.keys(evaluationTask.evaluationResults).forEach(studentUsername => {
                    const result = evaluationTask.evaluationResults[studentUsername];
                    const studentData = getStudentData(studentUsername);
                    
                    html += `
                        <tr>
                            <td>${studentData.displayName || studentUsername}</td>
                            <td><span class="badge evaluation">Completada</span></td>
                            <td>${result.score || 0}</td>
                            <td>${result.completionPercentage || 0}%</td>
                            <td>${new Date(result.completedAt).toLocaleString()}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('results-table-display').innerHTML = html;
        }
        
        // Display fixes applied
        function displayFixesApplied() {
            const html = `
                <div class="notification success">
                    ‚úÖ <strong>Correcci√≥n 1:</strong> assignedByName corregido en tareas de evaluaci√≥n
                </div>
                <div class="notification success">
                    ‚úÖ <strong>Correcci√≥n 2:</strong> fromDisplayName corregido en notificaciones
                </div>
                <div class="notification success">
                    ‚úÖ <strong>Correcci√≥n 3:</strong> Campo grade eliminado de notificaciones completadas
                </div>
                <div class="notification success">
                    ‚úÖ <strong>Correcci√≥n 4:</strong> Resultados de evaluaci√≥n sincronizados correctamente
                </div>
            `;
            
            document.getElementById('fixes-applied').innerHTML = html;
        }
        
        // Helper function to get student data
        function getStudentData(username) {
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            return users.find(u => u.username === username) || { displayName: username };
        }
        
        // Clear all test data
        function clearAll() {
            if (confirm('¬øEst√°s seguro de que deseas limpiar todos los datos de prueba?')) {
                localStorage.removeItem('smart-student-tasks');
                localStorage.removeItem('smart-student-task-notifications');
                localStorage.removeItem('smart-student-users');
                localStorage.removeItem('userTasks_maria_estudiante');
                localStorage.removeItem('userTasks_pedro_estudiante');
                
                testTaskId = null;
                testNotificationId = null;
                
                document.getElementById('notifications-display').innerHTML = '<p class="info-text">Las notificaciones aparecer√°n aqu√≠ despu√©s de crear el escenario de prueba.</p>';
                document.getElementById('results-table-display').innerHTML = '<p class="info-text">La tabla de resultados aparecer√° aqu√≠ despu√©s de simular evaluaciones completadas.</p>';
                document.getElementById('fixes-applied').innerHTML = '<p class="info-text">Las correcciones aplicadas se mostrar√°n aqu√≠.</p>';
                document.getElementById('verification-log').innerHTML = '<div class="info-text">Los logs de verificaci√≥n aparecer√°n aqu√≠...</div>';
                
                updateStatus('Todos los datos de prueba han sido limpiados.');
                updateProgress(0);
                log('üóëÔ∏è Todos los datos de prueba han sido limpiados', 'success');
            }
        }
        
        // Initialize
        updateStatus('Listo para verificar los problemas del Profesor Jorge.');
        log('üéØ Sistema de verificaci√≥n inicializado', 'info');
    </script>
</body>
</html>
